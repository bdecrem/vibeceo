<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PULSE GRID — 909 Minimal Techno</title>

  <!-- OpenGraph -->
  <meta property="og:title" content="PULSE GRID — 909 Minimal Techno">
  <meta property="og:description" content="Geometric shapes pulse with 909 drums. 128 BPM. Berlin evening.">
  <meta property="og:image" content="https://intheamber.com/amber/pulse-grid-og.png">
  <meta property="og:url" content="https://kochi.to/amber/pulse-grid.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://intheamber.com/amber/pulse-grid-og.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      overflow: hidden;
      font-family: 'Space Mono', monospace;
      color: #D4A574;
    }

    #canvas {
      display: block;
      width: 100vw;
      height: calc(100vh - 180px);
      cursor: pointer;
    }

    #controls {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
      z-index: 10;
      transition: opacity 0.5s;
    }

    #controls.hidden {
      opacity: 0;
    }

    .ctrl-btn {
      background: #D4A574;
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 14px;
      font-family: 'Space Mono', monospace;
      font-weight: bold;
      cursor: pointer;
      pointer-events: all;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 0 20px rgba(212, 165, 116, 0.5);
      transition: all 0.3s;
      margin: 5px;
    }

    .ctrl-btn:hover {
      background: #FFD700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
    }

    .ctrl-btn.active {
      background: #FF6B6B;
      box-shadow: 0 0 30px rgba(255, 107, 107, 0.7);
    }

    #info {
      position: fixed;
      top: 30px;
      left: 30px;
      font-size: 12px;
      letter-spacing: 1px;
      opacity: 0.6;
      z-index: 5;
    }

    #title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #FFD700;
    }

    /* Sequencer Grid */
    #sequencer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      border-top: 1px solid rgba(212, 165, 116, 0.3);
      z-index: 20;
    }

    #grid-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 800px;
      margin: 0 auto;
    }

    .grid-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .row-label {
      width: 50px;
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.6;
      text-align: right;
      padding-right: 8px;
    }

    .grid-cell {
      flex: 1;
      aspect-ratio: 1;
      max-width: 40px;
      background: rgba(212, 165, 116, 0.1);
      border: 1px solid rgba(212, 165, 116, 0.2);
      cursor: pointer;
      transition: all 0.15s;
    }

    .grid-cell:hover {
      background: rgba(212, 165, 116, 0.3);
    }

    .grid-cell.active {
      background: #D4A574;
      box-shadow: 0 0 10px rgba(212, 165, 116, 0.5);
    }

    .grid-cell.playing {
      border-color: #FFD700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }

    /* Row-specific colors */
    .grid-row[data-row="kick"] .grid-cell.active { background: #FFD700; }
    .grid-row[data-row="snare"] .grid-cell.active { background: #2D9596; }
    .grid-row[data-row="ch"] .grid-cell.active { background: #D4A574; }
    .grid-row[data-row="oh"] .grid-cell.active { background: #7B68EE; }

    #button-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 12px;
    }

    #button-row .ctrl-btn {
      padding: 10px 20px;
      font-size: 12px;
    }

    #status {
      text-align: center;
      font-size: 10px;
      opacity: 0.5;
      margin-top: 8px;
    }

    @media (max-width: 600px) {
      .ctrl-btn {
        padding: 12px 20px;
        font-size: 12px;
      }
      #info {
        top: 20px;
        left: 20px;
        font-size: 10px;
      }
      .row-label {
        width: 35px;
        font-size: 8px;
      }
      .grid-cell {
        max-width: 30px;
      }
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="play-btn" class="ctrl-btn">▶ START</button>
  </div>

  <div id="info">
    <div id="title">PULSE GRID</div>
    <div>909 Minimal Techno / 128 BPM</div>
    <div style="margin-top: 5px; opacity: 0.4;">TAP GRID TO ADD BEATS</div>
  </div>

  <div id="sequencer">
    <div id="grid-container">
      <div class="grid-row" data-row="kick">
        <span class="row-label">KICK</span>
      </div>
      <div class="grid-row" data-row="snare">
        <span class="row-label">SNARE</span>
      </div>
      <div class="grid-row" data-row="ch">
        <span class="row-label">HI-HAT</span>
      </div>
      <div class="grid-row" data-row="oh">
        <span class="row-label">OPEN</span>
      </div>
    </div>
    <div id="button-row">
      <button id="save-btn" class="ctrl-btn">SAVE</button>
      <button id="rndm-btn" class="ctrl-btn">RNDM</button>
      <button id="clear-btn" class="ctrl-btn">CLEAR</button>
    </div>
    <div id="status"></div>
  </div>

  <script type="module">
    import { TR909Controller } from '/909/dist/api/index.js';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('play-btn');
    const saveBtn = document.getElementById('save-btn');
    const rndmBtn = document.getElementById('rndm-btn');
    const clearBtn = document.getElementById('clear-btn');
    const controls = document.getElementById('controls');
    const status = document.getElementById('status');

    let width, height;
    let drums;
    let isPlaying = false;
    let beatIndex = 0;
    let currentStep = 0;

    const APP_ID = 'pulse-grid-patterns';

    // Pulse state for visualization
    const pulses = {
      kick: 0,
      snare: 0,
      ch: 0,
      oh: 0
    };

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight - 180;
    }
    resize();
    window.addEventListener('resize', resize);

    // Editable pattern
    const pattern = {
      kick: Array(16).fill(null).map(() => ({ velocity: 0 })),
      snare: Array(16).fill(null).map(() => ({ velocity: 0 })),
      ch: Array(16).fill(null).map(() => ({ velocity: 0 })),
      oh: Array(16).fill(null).map(() => ({ velocity: 0 }))
    };

    // Initialize with a basic pattern
    function loadDefaultPattern() {
      // Classic four-on-the-floor
      [0, 4, 8, 12].forEach(i => pattern.kick[i].velocity = 1);
      // Snare on 4 and 12
      [4, 12].forEach(i => pattern.snare[i].velocity = 0.8);
      // Hi-hats on every beat
      for (let i = 0; i < 16; i++) {
        pattern.ch[i].velocity = i % 2 === 0 ? 0.6 : 0.4;
      }
      // Open hat
      [6, 14].forEach(i => pattern.oh[i].velocity = 0.5);
      updateGridUI();
    }

    // Build the grid UI
    function buildGrid() {
      const rows = ['kick', 'snare', 'ch', 'oh'];
      rows.forEach(rowName => {
        const row = document.querySelector(`.grid-row[data-row="${rowName}"]`);
        for (let i = 0; i < 16; i++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.step = i;
          cell.addEventListener('click', () => toggleCell(rowName, i));
          row.appendChild(cell);
        }
      });
    }

    function toggleCell(rowName, step) {
      const vel = pattern[rowName][step].velocity;
      pattern[rowName][step].velocity = vel > 0 ? 0 : 0.8;
      updateGridUI();
      if (drums) {
        drums.setPattern(pattern);
      }
    }

    function updateGridUI() {
      const rows = ['kick', 'snare', 'ch', 'oh'];
      rows.forEach(rowName => {
        const row = document.querySelector(`.grid-row[data-row="${rowName}"]`);
        const cells = row.querySelectorAll('.grid-cell');
        cells.forEach((cell, i) => {
          cell.classList.toggle('active', pattern[rowName][i].velocity > 0);
        });
      });
    }

    function highlightStep(step) {
      document.querySelectorAll('.grid-cell').forEach(cell => {
        cell.classList.remove('playing');
      });
      document.querySelectorAll(`.grid-cell[data-step="${step}"]`).forEach(cell => {
        cell.classList.add('playing');
      });
    }

    // SAVE pattern to ZAD
    async function savePattern() {
      status.textContent = 'Saving...';
      try {
        const response = await fetch('/api/zad/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            app_id: APP_ID,
            action_type: 'pattern',
            content_data: pattern,
            participant_data: {
              saved_at: new Date().toISOString(),
              user_agent: navigator.userAgent.slice(0, 100)
            }
          })
        });
        const data = await response.json();
        if (data.success) {
          status.textContent = 'Saved!';
        } else {
          status.textContent = 'Save failed';
        }
      } catch (e) {
        status.textContent = 'Save error';
      }
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    // RNDM - load random pattern
    async function loadRandomPattern() {
      status.textContent = 'Loading...';
      try {
        const response = await fetch(`/api/zad/load?app_id=${APP_ID}&action_type=pattern`);
        const patterns = await response.json();
        if (patterns.length === 0) {
          status.textContent = 'No patterns saved yet!';
        } else {
          const random = patterns[Math.floor(Math.random() * patterns.length)];
          const loaded = random.content_data;
          // Apply loaded pattern
          ['kick', 'snare', 'ch', 'oh'].forEach(row => {
            if (loaded[row]) {
              for (let i = 0; i < 16; i++) {
                pattern[row][i].velocity = loaded[row][i]?.velocity || 0;
              }
            }
          });
          updateGridUI();
          if (drums) {
            drums.setPattern(pattern);
          }
          status.textContent = 'Loaded random pattern!';
        }
      } catch (e) {
        status.textContent = 'Load error';
      }
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    // CLEAR pattern
    function clearPattern() {
      ['kick', 'snare', 'ch', 'oh'].forEach(row => {
        for (let i = 0; i < 16; i++) {
          pattern[row][i].velocity = 0;
        }
      });
      updateGridUI();
      if (drums) {
        drums.setPattern(pattern);
      }
      status.textContent = 'Cleared';
      setTimeout(() => { status.textContent = ''; }, 1000);
    }

    // Button handlers
    saveBtn.addEventListener('click', savePattern);
    rndmBtn.addEventListener('click', loadRandomPattern);
    clearBtn.addEventListener('click', clearPattern);

    playBtn.addEventListener('click', async () => {
      if (isPlaying) {
        // Stop
        if (drums) drums.stop();
        isPlaying = false;
        playBtn.textContent = '▶ START';
        playBtn.classList.remove('active');
        return;
      }

      // Initialize 909
      drums = new TR909Controller();
      drums.setPattern(pattern);
      drums.setBpm(128);

      // Start playback
      await drums.play();
      isPlaying = true;
      playBtn.textContent = '■ STOP';
      playBtn.classList.add('active');

      // Start beat tracking
      startBeatTracking();
    });

    function startBeatTracking() {
      const stepDuration = (60 / 128 / 4) * 1000; // ms per 16th note

      const interval = setInterval(() => {
        if (!isPlaying) {
          clearInterval(interval);
          return;
        }

        const step = beatIndex % 16;
        currentStep = step;
        highlightStep(step);

        // Trigger pulses based on pattern
        if (pattern.kick[step].velocity > 0) {
          pulses.kick = pattern.kick[step].velocity;
        }
        if (pattern.snare[step].velocity > 0) {
          pulses.snare = pattern.snare[step].velocity;
        }
        if (pattern.ch[step].velocity > 0) {
          pulses.ch = pattern.ch[step].velocity;
        }
        if (pattern.oh[step].velocity > 0) {
          pulses.oh = pattern.oh[step].velocity;
        }

        beatIndex++;
      }, stepDuration);
    }

    // Visualization
    function draw() {
      // Decay pulses
      pulses.kick *= 0.85;
      pulses.snare *= 0.85;
      pulses.ch *= 0.92;
      pulses.oh *= 0.88;

      // Clear
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, width, height);

      const cx = width / 2;
      const cy = height / 2;
      const time = Date.now() * 0.0005;

      // Background grid (subtle, always visible)
      ctx.strokeStyle = 'rgba(212, 165, 116, 0.05)';
      ctx.lineWidth = 1;
      for (let i = 0; i < width; i += 60) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, height);
        ctx.stroke();
      }
      for (let i = 0; i < height; i += 60) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(width, i);
        ctx.stroke();
      }

      // KICK: Central expanding square
      const kickSize = 100 + pulses.kick * 200;
      const kickAlpha = 0.3 + pulses.kick * 0.7;
      ctx.strokeStyle = `rgba(255, 215, 0, ${kickAlpha})`;
      ctx.lineWidth = 3 + pulses.kick * 5;
      ctx.strokeRect(cx - kickSize/2, cy - kickSize/2, kickSize, kickSize);

      // SNARE: Rotating diagonal lines
      const snareIntensity = pulses.snare;
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(time);
      ctx.strokeStyle = `rgba(45, 149, 150, ${0.4 + snareIntensity * 0.6})`;
      ctx.lineWidth = 2 + snareIntensity * 6;
      const snareSize = 150 + snareIntensity * 100;
      ctx.beginPath();
      ctx.moveTo(-snareSize, -snareSize);
      ctx.lineTo(snareSize, snareSize);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(snareSize, -snareSize);
      ctx.lineTo(-snareSize, snareSize);
      ctx.stroke();
      ctx.restore();

      // CLOSED HAT: Corner circles
      const chRadius = 15 + pulses.ch * 30;
      const chAlpha = 0.3 + pulses.ch * 0.5;
      ctx.fillStyle = `rgba(212, 165, 116, ${chAlpha})`;
      const margin = 80;
      ctx.beginPath();
      ctx.arc(margin, margin, chRadius, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(width - margin, margin, chRadius, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(margin, height - margin, chRadius, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(width - margin, height - margin, chRadius, 0, Math.PI * 2);
      ctx.fill();

      // OPEN HAT: Expanding rings from corners
      if (pulses.oh > 0.05) {
        const ohRadius = 50 + pulses.oh * 250;
        const ohAlpha = pulses.oh * 0.6;
        ctx.strokeStyle = `rgba(123, 104, 238, ${ohAlpha})`;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(margin, margin, ohRadius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(width - margin, height - margin, ohRadius, 0, Math.PI * 2);
        ctx.stroke();
      }

      // Scanline effect
      ctx.fillStyle = 'rgba(212, 165, 116, 0.02)';
      for (let i = 0; i < height; i += 4) {
        ctx.fillRect(0, i, width, 2);
      }

      requestAnimationFrame(draw);
    }

    // Initialize
    buildGrid();
    loadDefaultPattern();
    draw();
  </script>
</body>
</html>
