<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PULSE GRID</title>
  <meta name="description" content="16 pulsing circles. Each one is a drum. Tap to trigger. Watch them breathe.">
  
  <!-- OpenGraph -->
  <meta property="og:title" content="PULSE GRID">
  <meta property="og:description" content="16 pulsing circles. Each one is a drum. Tap to trigger. Watch them breathe.">
  <meta property="og:image" content="https://intheamber.com/amber/pulse-grid-og.png">
  <meta property="og:url" content="https://kochi.to/amber/pulse-grid.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://intheamber.com/amber/pulse-grid-og.png">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      touch-action: manipulation;
    }
    
    #title {
      font-size: 1.2rem;
      letter-spacing: 0.2em;
      margin-bottom: 10px;
      color: #ff6b35;
      text-align: center;
    }
    
    #subtitle {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
    }
    
    #canvas {
      border: 1px solid #222;
      cursor: pointer;
      max-width: 90vw;
      max-height: 70vh;
    }
    
    #controls {
      margin-top: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    button {
      background: #ff6b35;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #ff8555;
    }
    
    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    #bpm {
      color: #888;
      font-size: 0.9rem;
    }
    
    #info {
      margin-top: 15px;
      font-size: 0.7rem;
      color: #444;
      text-align: center;
      max-width: 500px;
    }
    
    @media (max-width: 600px) {
      #title { font-size: 1rem; }
      #controls { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <div id="title">PULSE GRID</div>
  <div id="subtitle">tap circles to trigger drums</div>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <button id="playBtn">TAP TO START</button>
    <div id="bpm">128 BPM</div>
  </div>
  <div id="info">Each circle is a TR-909 voice. They pulse when they play. Click them to trigger manually.</div>

  <script type="module">
    import { TR909Engine } from '/909/dist/machines/tr909/engine.js';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('playBtn');
    
    let audioContext = null;
    let drums = null;
    let isPlaying = false;
    let animationId = null;
    let currentStep = 0;
    let lastStepTime = 0;
    const BPM = 128;
    const STEP_DURATION = (60 / BPM / 4) * 1000; // milliseconds per 16th note
    
    // Grid layout
    const GRID_SIZE = 4;
    const CELL_SIZE = 100;
    const PADDING = 20;
    const CANVAS_SIZE = GRID_SIZE * CELL_SIZE + (GRID_SIZE + 1) * PADDING;

    canvas.width = CANVAS_SIZE;
    canvas.height = CANVAS_SIZE;
    
    // Voice mapping to grid positions
    const voices = [
      { id: 'kick', color: '#ff6b35', label: 'KICK' },
      { id: 'snare', color: '#f7931e', label: 'SNARE' },
      { id: 'clap', color: '#fdc82f', label: 'CLAP' },
      { id: 'rimshot', color: '#a8e6cf', label: 'RIM' },
      
      { id: 'ch', color: '#56cfe1', label: 'CH' },
      { id: 'oh', color: '#4ea8de', label: 'OH' },
      { id: 'ltom', color: '#5e60ce', label: 'LTOM' },
      { id: 'mtom', color: '#7209b7', label: 'MTOM' },
      
      { id: 'htom', color: '#b5179e', label: 'HTOM' },
      { id: 'crash', color: '#f72585', label: 'CRASH' },
      { id: 'ride', color: '#ff758f', label: 'RIDE' },
      { id: 'kick', color: '#ff6b35', label: 'KICK2' }, // repeat for symmetry
      
      { id: 'snare', color: '#f7931e', label: 'SNR2' },
      { id: 'ch', color: '#56cfe1', label: 'CH2' },
      { id: 'clap', color: '#fdc82f', label: 'CLP2' },
      { id: 'oh', color: '#4ea8de', label: 'OH2' },
    ];
    
    // Pattern for each voice (16 steps)
    const pattern = {
      kick:    [1, 0, 0, 0,  1, 0, 0, 0,  1, 0, 0, 0,  1, 0, 0, 0],
      snare:   [0, 0, 0, 0,  1, 0, 0, 0,  0, 0, 0, 0,  1, 0, 0, 0],
      clap:    [0, 0, 0, 0,  1, 0, 0, 0,  0, 0, 0, 0,  1, 0, 0, 0],
      ch:      [1, 0, 1, 0,  1, 0, 1, 0,  1, 0, 1, 0,  1, 0, 1, 0],
      oh:      [0, 0, 0, 0,  0, 0, 1, 0,  0, 0, 0, 0,  0, 0, 1, 0],
      rimshot: [0, 0, 0, 1,  0, 0, 0, 0,  0, 0, 0, 1,  0, 0, 0, 0],
      ltom:    [0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0],
      mtom:    [0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0],
      htom:    [0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0],
      crash:   [1, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0],
      ride:    [0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0],
    };
    
    // Pulse state for each cell
    const pulses = voices.map(() => ({ active: false, intensity: 0 }));
    
    function getCellPosition(index) {
      const row = Math.floor(index / GRID_SIZE);
      const col = index % GRID_SIZE;
      const x = PADDING + col * (CELL_SIZE + PADDING) + CELL_SIZE / 2;
      const y = PADDING + row * (CELL_SIZE + PADDING) + CELL_SIZE / 2;
      return { x, y };
    }
    
    function triggerVoice(voiceId, index) {
      if (!drums) return;
      const voice = drums.voices.get(voiceId);
      if (voice) {
        const now = audioContext.currentTime;
        voice.trigger(now, 1.0);
        
        // Activate pulse
        pulses[index].active = true;
        pulses[index].intensity = 1.0;
      }
    }
    
    function drawGrid() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
      
      voices.forEach((voice, i) => {
        const pos = getCellPosition(i);
        const pulse = pulses[i];
        
        // Background circle
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 35, 0, Math.PI * 2);
        ctx.fillStyle = '#111';
        ctx.fill();
        
        // Pulse ring
        if (pulse.active) {
          const ringRadius = 35 + (15 * (1 - pulse.intensity));
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, ringRadius, 0, Math.PI * 2);
          ctx.strokeStyle = voice.color;
          ctx.lineWidth = 3;
          ctx.globalAlpha = pulse.intensity * 0.6;
          ctx.stroke();
          ctx.globalAlpha = 1;
          
          // Decay pulse
          pulse.intensity *= 0.92;
          if (pulse.intensity < 0.01) {
            pulse.active = false;
          }
        }
        
        // Main circle
        const brightness = pulse.active ? 0.3 + pulse.intensity * 0.7 : 0.3;
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 35, 0, Math.PI * 2);
        ctx.fillStyle = voice.color;
        ctx.globalAlpha = brightness;
        ctx.fill();
        ctx.globalAlpha = 1;
        
        // Border
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 35, 0, Math.PI * 2);
        ctx.strokeStyle = voice.color;
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Label
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 9px Courier New';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(voice.label, pos.x, pos.y);
      });
      
      // Step indicator at top
      ctx.fillStyle = '#444';
      ctx.font = '10px Courier New';
      ctx.textAlign = 'left';
      ctx.fillText(`STEP ${currentStep + 1}/16`, 10, 15);
    }
    
    function animate() {
      const now = performance.now();
      
      // Check if it's time for next step
      if (isPlaying && now - lastStepTime >= STEP_DURATION) {
        currentStep = (currentStep + 1) % 16;
        lastStepTime = now;
        
        // Trigger voices that are active on this step
        voices.forEach((voice, i) => {
          const shouldPlay = pattern[voice.id] && pattern[voice.id][currentStep];
          if (shouldPlay) {
            triggerVoice(voice.id, i);
          }
        });
      }
      
      drawGrid();
      animationId = requestAnimationFrame(animate);
    }
    
    async function initAudio() {
      if (audioContext) return;
      
      audioContext = new AudioContext();
      drums = new TR909Engine({ context: audioContext });
      drums.setBpm(BPM);
      
      // Tune some voices for better sound
      drums.voices.get('kick').decay = 0.5;
      drums.voices.get('snare').tone = 0.4;
      drums.voices.get('ch').decay = 0.1;
      drums.voices.get('oh').decay = 0.3;
    }
    
    async function togglePlay() {
      if (!audioContext) {
        await initAudio();
      }
      
      await audioContext.resume();
      
      isPlaying = !isPlaying;
      
      if (isPlaying) {
        playBtn.textContent = 'STOP';
        lastStepTime = performance.now();
      } else {
        playBtn.textContent = 'PLAY';
      }
    }
    
    // Click to trigger individual voices
    canvas.addEventListener('click', async (e) => {
      if (!audioContext) {
        await initAudio();
        await audioContext.resume();
      }
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Find which cell was clicked
      voices.forEach((voice, i) => {
        const pos = getCellPosition(i);
        const distance = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2);
        if (distance < 35) {
          triggerVoice(voice.id, i);
        }
      });
    });
    
    playBtn.addEventListener('click', togglePlay);
    
    // Start animation loop
    animate();
  </script>
</body>
</html>
