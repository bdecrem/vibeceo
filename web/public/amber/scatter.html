<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCATTER — Drum hits scatter across space</title>
  <meta property="og:title" content="SCATTER — Drum hits scatter across space">
  <meta property="og:description" content="A music machine by Amber">
  <meta property="og:image" content="https://intheamber.com/amber/scatter-og.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SCATTER — Drum hits scatter across space">
  <meta name="twitter:description" content="A music machine by Amber">
  <meta name="twitter:image" content="https://intheamber.com/amber/scatter-og.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-family: 'Space Mono', monospace;
      color: #D4A574;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #controls {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    #playBtn {
      background: #D4A574;
      color: #000;
      border: none;
      padding: 16px 40px;
      font-size: 18px;
      font-family: 'Space Mono', monospace;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    #playBtn:hover {
      background: #FFD700;
      transform: scale(1.05);
    }

    #playBtn.playing {
      background: #2D9596;
    }

    #info {
      font-size: 12px;
      color: #D4A574;
      opacity: 0.7;
      text-align: center;
    }

    #stats {
      position: absolute;
      bottom: 20px;
      left: 20px;
      font-size: 11px;
      color: #D4A574;
      opacity: 0.5;
      font-family: 'Space Mono', monospace;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      #playBtn {
        padding: 14px 32px;
        font-size: 16px;
      }
      #stats {
        font-size: 10px;
        bottom: 12px;
        left: 12px;
      }
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="playBtn">START</button>
    <div id="info">128 BPM • Berlin techno</div>
  </div>

  <div id="stats">
    BPM: <span id="bpm">128</span><br>
    PATTERN: <span id="pattern">4x4 techno</span><br>
    PARTICLES: <span id="particles">0</span>
  </div>

  <script type="module">
    import { TR909Controller } from '/909/dist/api/index.js';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('playBtn');
    const bpmStat = document.getElementById('bpm');
    const particlesStat = document.getElementById('particles');

    let width = window.innerWidth;
    let height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    });

    // Particle system
    const particles = [];

    class Particle {
      constructor(x, y, color, velocity, size) {
        this.x = x;
        this.y = y;
        this.vx = velocity.x;
        this.vy = velocity.y;
        this.color = color;
        this.size = size;
        this.life = 1.0;
        this.decay = 0.015;
        this.rotation = Math.random() * Math.PI * 2;
        this.rotationSpeed = (Math.random() - 0.5) * 0.2;
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= this.decay;
        this.rotation += this.rotationSpeed;

        // Bounce off walls
        if (this.x < 0 || this.x > width) this.vx *= -0.8;
        if (this.y < 0 || this.y > height) this.vy *= -0.8;

        // Keep in bounds
        this.x = Math.max(0, Math.min(width, this.x));
        this.y = Math.max(0, Math.min(height, this.y));

        // Gravity
        this.vy += 0.2;

        // Friction
        this.vx *= 0.98;
        this.vy *= 0.98;
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.life;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);

        // Glow
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size * 2);
        gradient.addColorStop(0, this.color);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(-this.size * 2, -this.size * 2, this.size * 4, this.size * 4);

        // Core
        ctx.fillStyle = this.color;
        ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);

        ctx.restore();
      }
    }

    function spawnParticles(voice) {
      const configs = {
        kick: { 
          color: '#FFD700', 
          count: 20, 
          speed: 12, 
          size: 8,
          x: width / 2,
          y: height / 2
        },
        snare: { 
          color: '#D4A574', 
          count: 15, 
          speed: 10, 
          size: 6,
          x: width / 2,
          y: height / 2
        },
        ch: { 
          color: '#2D9596', 
          count: 8, 
          speed: 6, 
          size: 4,
          x: Math.random() * width,
          y: height * 0.3
        },
        oh: { 
          color: '#7B68EE', 
          count: 12, 
          speed: 8, 
          size: 5,
          x: Math.random() * width,
          y: height * 0.3
        },
        rimshot: {
          color: '#FF69B4',
          count: 10,
          speed: 9,
          size: 5,
          x: width * 0.2,
          y: height * 0.5
        },
        clap: {
          color: '#FF6B6B',
          count: 12,
          speed: 8,
          size: 6,
          x: width * 0.8,
          y: height * 0.5
        }
      };

      const config = configs[voice];
      if (!config) return;

      for (let i = 0; i < config.count; i++) {
        const angle = (Math.PI * 2 * i) / config.count + Math.random() * 0.5;
        const speed = config.speed * (0.5 + Math.random() * 0.5);
        particles.push(new Particle(
          config.x,
          config.y,
          config.color,
          { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed },
          config.size
        ));
      }
    }

    // 909 Setup
    let drums = null;
    let isPlaying = false;
    let audioStarted = false;
    const BPM = 128;

    const pattern = {
      kick: [
        { velocity: 1.0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0.9 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 1.0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0.9 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 }
      ],
      snare: [
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 1.0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 1.0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 }
      ],
      ch: [
        { velocity: 0.7 }, { velocity: 0 }, { velocity: 0.7 }, { velocity: 0 },
        { velocity: 0.7 }, { velocity: 0 }, { velocity: 0.7 }, { velocity: 0 },
        { velocity: 0.7 }, { velocity: 0 }, { velocity: 0.7 }, { velocity: 0 },
        { velocity: 0.7 }, { velocity: 0 }, { velocity: 0.7 }, { velocity: 0 }
      ],
      oh: [
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0.8 }, { velocity: 0 },
{ velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0.8 }, { velocity: 0 }
      ],
      rimshot: [
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0.6 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0.6 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 }
      ],
      clap: [
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0 },
        { velocity: 0 }, { velocity: 0 }, { velocity: 0 }, { velocity: 0.5 }
      ]
    };

    function initDrums() {
      if (drums) return;
      drums = new TR909Controller();
      drums.setBpm(BPM);
      drums.setPattern(pattern);

      // Hook into voice outputs to trigger visuals
      const voices = ['kick', 'snare', 'ch', 'oh', 'rimshot', 'clap'];
      voices.forEach(voice => {
        const originalTrigger = drums.engine.voices.get(voice).trigger.bind(drums.engine.voices.get(voice));
        drums.engine.voices.get(voice).trigger = function(time, velocity) {
          originalTrigger(time, velocity);
          if (velocity > 0) {
            spawnParticles(voice);
          }
        };
      });
    }

    playBtn.addEventListener('click', async () => {
      if (!audioStarted) {
        initDrums();
        await drums.engine.context.resume();
        audioStarted = true;
      }

      if (isPlaying) {
        drums.stop();
        isPlaying = false;
        playBtn.textContent = 'START';
        playBtn.classList.remove('playing');
      } else {
        drums.play();
        isPlaying = true;
        playBtn.textContent = 'STOP';
        playBtn.classList.add('playing');
      }
    });

    // Animation loop
    function animate() {
      // Fade trail effect
      ctx.fillStyle = 'rgba(0, 0, 0, 0.08)';
      ctx.fillRect(0, 0, width, height);

      // Update and draw particles
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw();

        if (particles[i].life <= 0) {
          particles.splice(i, 1);
        }
      }

      // Update stats
      particlesStat.textContent = particles.length;

      requestAnimationFrame(animate);
    }

    // Preview animation (before play is pressed)
    let previewTime = 0;
    function previewAnimate() {
      if (isPlaying) {
        requestAnimationFrame(animate);
        return;
      }

      ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      ctx.fillRect(0, 0, width, height);

      previewTime += 0.01;

      // Show preview particles pulsing at beat positions
      const positions = [
        { x: width / 2, y: height / 2, color: '#FFD700', size: 30 }, // kick
        { x: width / 2, y: height * 0.3, color: '#2D9596', size: 20 }, // hats
        { x: width * 0.2, y: height * 0.6, color: '#FF69B4', size: 15 }, // rimshot
        { x: width * 0.8, y: height * 0.6, color: '#FF6B6B', size: 15 }, // clap
      ];

      positions.forEach((pos, i) => {
        const pulse = Math.sin(previewTime * 2 + i) * 0.3 + 0.7;
        ctx.save();
        ctx.globalAlpha = pulse * 0.4;

        const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, pos.size * pulse);
        gradient.addColorStop(0, pos.color);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(pos.x - pos.size * pulse, pos.y - pos.size * pulse, pos.size * 2 * pulse, pos.size * 2 * pulse);

        ctx.restore();
      });

      requestAnimationFrame(previewAnimate);
    }

    previewAnimate();
  </script>
</body>
</html>
