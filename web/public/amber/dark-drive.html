<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARK DRIVE — 909 + 303</title>

    <!-- OG Meta Tags -->
    <meta property="og:title" content="DARK DRIVE — 909 + 303">
    <meta property="og:description" content="Techno. TR-909 kick + TB-303 sub bass. 128 BPM darkness.">
    <meta property="og:image" content="https://intheamber.com/amber/dark-drive-og.png">
    <meta property="og:url" content="https://intheamber.com/amber/dark-drive.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="DARK DRIVE — 909 + 303">
    <meta name="twitter:description" content="Techno. TR-909 kick + TB-303 sub bass. 128 BPM darkness.">
    <meta name="twitter:image" content="https://intheamber.com/amber/dark-drive-og.png">

    <script type="importmap">
        {
            "imports": {
                "audiobuffer-to-wav": "https://esm.sh/audiobuffer-to-wav@1.0.0"
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0a0a0a;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            color: #ff3333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #ff3333;
        }

        #title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #bpm {
            opacity: 0.7;
            font-size: 12px;
        }

        /* Step indicator */
        #steps {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            z-index: 10;
        }

        .step {
            width: 12px;
            height: 40px;
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.3);
            transition: all 0.05s;
        }

        .step.active {
            background: #ff3333;
            box-shadow: 0 0 15px #ff3333;
        }

        .step.kick {
            background: #ff3333;
            box-shadow: 0 0 20px #ff3333, 0 0 40px #ff0000;
        }

        #start {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff3333;
            color: #000;
            border: none;
            padding: 30px 60px;
            font-size: 32px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 4px;
            z-index: 100;
        }

        #start:hover {
            background: #ff5555;
            box-shadow: 0 0 30px #ff3333;
        }

        #start.hidden {
            display: none;
        }

        .signature {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #ff3333;
            opacity: 0.3;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="ui">
        <div id="title">DARK DRIVE</div>
        <div id="bpm">128 BPM</div>
    </div>

    <div id="steps"></div>

    <button id="start">IGNITE</button>

    <div class="signature">TECHNO</div>

    <script type="module">
        import { TR909Controller } from '/909/dist/api/index.js';
        import { TB303Controller } from '/303/dist/api/index.js';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const stepsContainer = document.getElementById('steps');
        const startBtn = document.getElementById('start');

        let width, height;
        let drums = null;
        let bass = null;
        let currentStep = -1;
        let kickSteps = [];
        let time = 0;
        let kickIntensity = 0;
        let hatIntensity = 0;
        let bassIntensity = 0;
        let playing = false;

        // Dark red palette
        const RED = '#ff3333';
        const DARK_RED = '#990000';
        const WHITE = '#ffffff';

        const BPM = 128;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        // Create step indicators
        function createStepIndicators() {
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.dataset.index = i;
                stepsContainer.appendChild(step);
            }
        }

        // Update step indicators
        function updateSteps(activeStep, isKick) {
            const steps = stepsContainer.querySelectorAll('.step');
            steps.forEach((step, i) => {
                step.classList.remove('active', 'kick');
                if (i === activeStep) {
                    step.classList.add('active');
                    if (isKick) step.classList.add('kick');
                }
            });
        }

        // Draw pulsing circles from center
        function drawPulse() {
            const centerX = width / 2;
            const centerY = height / 2;

            // Kick pulse - expands outward
            if (kickIntensity > 0.1) {
                const radius = (1 - kickIntensity) * 400 + 50;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.strokeStyle = RED;
                ctx.lineWidth = 2 + kickIntensity * 8;
                ctx.globalAlpha = kickIntensity * 0.8;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }

        // Draw vertical bars - visualize bass
        function drawBars() {
            const barCount = 16;
            const barWidth = width / barCount - 4;
            const maxHeight = height * 0.4;

            for (let i = 0; i < barCount; i++) {
                const x = i * (barWidth + 4) + 2;
                const phase = time * 0.05 + i * 0.4;
                const baseHeight = Math.sin(phase) * 0.3 + 0.3;
                const boost = (i === currentStep) ? bassIntensity : 0;
                const barHeight = (baseHeight + boost * 0.5) * maxHeight;

                const y = height / 2 - barHeight / 2;

                // Gradient bar
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, DARK_RED);
                gradient.addColorStop(0.5, RED);
                gradient.addColorStop(1, DARK_RED);

                ctx.fillStyle = gradient;
                ctx.globalAlpha = 0.3 + (i === currentStep ? 0.5 : 0);
                ctx.fillRect(x, y, barWidth, barHeight);
            }
            ctx.globalAlpha = 1;
        }

        // Draw horizontal scanlines
        function drawScanlines() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.02)';
            for (let y = 0; y < height; y += 2) {
                ctx.fillRect(0, y, width, 1);
            }
        }

        // Draw hi-hat sparkles
        function drawHatSparkles() {
            if (hatIntensity > 0.1) {
                const count = Math.floor(hatIntensity * 20);
                for (let i = 0; i < count; i++) {
                    const x = Math.random() * width;
                    const y = Math.random() * height;
                    const size = Math.random() * 2 + 1;

                    ctx.fillStyle = WHITE;
                    ctx.globalAlpha = hatIntensity * 0.5;
                    ctx.fillRect(x, y, size, size);
                }
                ctx.globalAlpha = 1;
            }
        }

        // Main draw loop
        function draw() {
            // Fade
            ctx.fillStyle = 'rgba(10, 10, 10, 0.15)';
            ctx.fillRect(0, 0, width, height);

            // Flash on kick
            if (kickIntensity > 0.5) {
                ctx.fillStyle = `rgba(255, 51, 51, ${(kickIntensity - 0.5) * 0.15})`;
                ctx.fillRect(0, 0, width, height);
            }

            drawBars();
            drawPulse();
            drawHatSparkles();
            drawScanlines();

            // Decay
            kickIntensity *= 0.9;
            hatIntensity *= 0.85;
            bassIntensity *= 0.92;
            time++;

            requestAnimationFrame(draw);
        }

        // 909 pattern - driving techno
        const drumPattern = {
            kick: [
                { velocity: 1, accent: true },   // 1
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 1 },                 // 5
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 1, accent: true },   // 9
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 1 },                 // 13
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
            ],
            ch: [
                { velocity: 0 },
                { velocity: 0.7 },               // offbeat
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
                { velocity: 0 },
                { velocity: 0.7 },
            ],
            oh: [
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0.6 },               // 8 - open hat accent
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0 },
                { velocity: 0.6 },               // 16
            ],
        };

        // Mark which steps have kicks for visualization
        kickSteps = [0, 4, 8, 12];

        // 303 as BASS instrument - 16 steps
        const bassPattern = [
            { note: 'C1', gate: true, accent: true, slide: false },   // 1 - root with kick
            { note: 'C1', gate: false, accent: false, slide: false }, // 2
            { note: 'C1', gate: true, accent: false, slide: false },  // 3
            { note: 'C1', gate: true, accent: false, slide: false },  // 4
            { note: 'C1', gate: true, accent: true, slide: false },   // 5 - root with kick
            { note: 'C1', gate: false, accent: false, slide: false }, // 6
            { note: 'C1', gate: true, accent: false, slide: false },  // 7
            { note: 'G1', gate: true, accent: false, slide: false },  // 8 - fifth
            { note: 'C1', gate: true, accent: true, slide: false },   // 9 - root with kick
            { note: 'C1', gate: false, accent: false, slide: false }, // 10
            { note: 'C1', gate: true, accent: false, slide: false },  // 11
            { note: 'C1', gate: true, accent: false, slide: false },  // 12
            { note: 'C1', gate: true, accent: true, slide: false },   // 13 - root with kick
            { note: 'D#1', gate: true, accent: false, slide: false }, // 14 - minor third
            { note: 'F1', gate: true, accent: false, slide: false },  // 15 - fourth
            { note: 'G1', gate: true, accent: false, slide: false },  // 16 - fifth
        ];

        // Initialize
        async function initMachines() {
            drums = new TR909Controller(drumPattern);
            bass = new TB303Controller({ engine: 'E2' });

            // 909 settings
            drums.setBpm(BPM);
            drums.engine.setVoiceParameter('kick', 'attack', 0.9);   // Max click
            drums.engine.setVoiceParameter('kick', 'decay', 0.08);  // Very tight
            drums.engine.setVoiceParameter('kick', 'tune', 200);    // Higher pitch, less boom
            drums.engine.setVoiceParameter('kick', 'level', 1.3);
            drums.engine.setVoiceParameter('ch', 'level', 0);   // Muted
            drums.engine.setVoiceParameter('oh', 'level', 0);   // Muted

            // 303 as BASS - dark, minimal filter movement
            bass.setPattern(bassPattern);
            bass.setBpm(BPM);
            bass.setWaveform('square');           // Darker, more sub
            bass.setParameter('cutoff', 0.08);    // Very low - sub bass
            bass.setParameter('resonance', 0.2);  // Low - no squelch
            bass.setParameter('envMod', 0.15);    // Minimal sweep
            bass.setParameter('decay', 0.5);      // Longer decay
            bass.setParameter('accent', 0.6);     // Subtle accent
            bass.engine.masterGain.gain.value = 0.3;

            // 909 step callback
            drums.engine.onStepChange = (step) => {
                currentStep = step;
                const isKick = kickSteps.includes(step);
                updateSteps(step, isKick);

                if (drumPattern.kick[step]?.velocity > 0) {
                    kickIntensity = 1;
                }
                if (drumPattern.ch[step]?.velocity > 0 || drumPattern.oh[step]?.velocity > 0) {
                    hatIntensity = drumPattern.oh[step]?.velocity > 0 ? 1 : 0.5;
                }
            };

            // 303 step callback
            bass.engine.onStepChange = (step) => {
                const stepData = bassPattern[step];
                if (stepData?.gate) {
                    bassIntensity = stepData.accent ? 1 : 0.6;
                }
            };
        }

        // Start
        startBtn.addEventListener('click', async () => {
            if (!drums || !bass) {
                await initMachines();
            }

            drums.play();
            bass.play();
            playing = true;
            startBtn.classList.add('hidden');
        });

        // Init
        resize();
        createStepIndicators();
        window.addEventListener('resize', resize);
        draw();
    </script>
</body>
</html>
