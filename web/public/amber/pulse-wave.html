<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PULSE WAVE — Acid Bass Machine</title>
  
  <!-- OpenGraph -->
  <meta property="og:title" content="PULSE WAVE">
  <meta property="og:description" content="TB-303 acid bassline with animated waveform visualization. Berlin. Squelch. Visual rhythm.">
  <meta property="og:image" content="https://intheamber.com/amber/pulse-wave-og.png">
  <meta property="og:url" content="https://kochi.to/amber/pulse-wave.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://intheamber.com/amber/pulse-wave-og.png">
  
  <link rel="icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Space Mono', monospace;
      background: #000;
      color: #D4A574;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    /* Subtle scanline effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15),
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
      opacity: 0.3;
    }
    
    .container {
      text-align: center;
      padding: 20px;
      position: relative;
      z-index: 10;
    }
    
    h1 {
      font-size: clamp(2rem, 6vw, 4rem);
      margin-bottom: 0.5rem;
      letter-spacing: 0.1em;
      text-shadow: 0 0 20px rgba(212, 165, 116, 0.5);
    }
    
    .subtitle {
      font-size: clamp(0.8rem, 2vw, 1rem);
      color: #2D9596;
      margin-bottom: 2rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }
    
    /* Canvas for waveform */
    #waveform {
      width: 100%;
      max-width: 900px;
      height: 300px;
      margin: 2rem auto;
      border: 2px solid #D4A574;
      border-radius: 4px;
      background: rgba(13, 13, 13, 0.8);
      box-shadow: 0 0 30px rgba(212, 165, 116, 0.2);
    }
    
    /* Control buttons */
    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 2rem 0;
    }
    
    button {
      background: transparent;
      border: 2px solid #D4A574;
      color: #D4A574;
      padding: 1rem 2rem;
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      background: rgba(212, 165, 116, 0.1);
      box-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    button.active {
      background: #D4A574;
      color: #000;
      box-shadow: 0 0 30px rgba(212, 165, 116, 0.5);
    }
    
    /* Parameter display */
    .params {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      max-width: 600px;
      margin: 2rem auto;
      font-size: 0.85rem;
    }
    
    .param {
      padding: 0.75rem;
      border: 1px solid rgba(212, 165, 116, 0.3);
      border-radius: 4px;
      background: rgba(13, 13, 13, 0.5);
    }
    
    .param-label {
      color: #2D9596;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      margin-bottom: 0.25rem;
    }
    
    .param-value {
      font-size: 1.1rem;
      color: #FFD700;
    }
    
    .footer {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: rgba(212, 165, 116, 0.5);
      letter-spacing: 0.2em;
    }
    
    @media (max-width: 600px) {
      #waveform {
        height: 200px;
      }
      
      .params {
        grid-template-columns: repeat(2, 1fr);
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PULSE WAVE</h1>
    <div class="subtitle">TB-303 Acid Bass Machine</div>
    
    <canvas id="waveform"></canvas>
    
    <div class="controls">
      <button id="playBtn">▶ PLAY</button>
      <button id="stopBtn">■ STOP</button>
    </div>
    
    <div class="params">
      <div class="param">
        <div class="param-label">Cutoff</div>
        <div class="param-value" id="cutoffValue">0.35</div>
      </div>
      <div class="param">
        <div class="param-label">Resonance</div>
        <div class="param-value" id="resValue">0.75</div>
      </div>
      <div class="param">
        <div class="param-label">Env Mod</div>
        <div class="param-value" id="envModValue">0.65</div>
      </div>
      <div class="param">
        <div class="param-label">BPM</div>
        <div class="param-value" id="bpmValue">135</div>
      </div>
    </div>
  </div>
  
  <div class="footer">AMBER / 2026 / KOCHITO LABS</div>
  
  <script type="module">
    import { TB303Controller } from '/303/dist/api/index.js';
    
    const canvas = document.getElementById('waveform');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    let bass = null;
    let analyser = null;
    let dataArray = null;
    let animationId = null;
    let isPlaying = false;
    
    // Canvas setup
    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Acid pattern - classic squelch progression
    const acidPattern = [
      { note: 'C2', gate: true, accent: true, slide: false },
      { note: 'C2', gate: false, accent: false, slide: false },
      { note: 'D#2', gate: true, accent: false, slide: false },
      { note: 'F2', gate: true, accent: false, slide: true },
      { note: 'G2', gate: true, accent: true, slide: false },
      { note: 'G2', gate: false, accent: false, slide: false },
      { note: 'A#2', gate: true, accent: false, slide: true },
      { note: 'C3', gate: true, accent: true, slide: false },
      { note: 'C2', gate: true, accent: false, slide: false },
      { note: 'C2', gate: false, accent: false, slide: false },
      { note: 'G2', gate: true, accent: true, slide: false },
      { note: 'F2', gate: true, accent: false, slide: true },
      { note: 'D#2', gate: true, accent: false, slide: false },
      { note: 'D#2', gate: false, accent: false, slide: false },
      { note: 'C2', gate: true, accent: true, slide: false },
      { note: 'G2', gate: true, accent: false, slide: true },
    ];
    
    // Initialize TB-303
    async function init() {
      bass = new TB303Controller();
      
      // Set parameters for classic acid sound
      bass.setParameter('cutoff', 0.35);
      bass.setParameter('resonance', 0.75);
      bass.setParameter('envMod', 0.65);
      bass.setParameter('decay', 0.4);
      bass.setParameter('accent', 0.85);
      bass.setWaveform('sawtooth');
      bass.setBpm(135);
      
      // Load pattern
      bass.setPattern(acidPattern);
      
      // Setup analyser for waveform visualization
      const audioContext = bass.engine.context;
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.8;
      
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      
      // Connect bass output to analyser
      bass.engine.output.connect(analyser);
      
      console.log('✓ TB-303 initialized');
    }
    
    // Draw waveform
    function draw() {
      animationId = requestAnimationFrame(draw);
      
      analyser.getByteTimeDomainData(dataArray);
      
      // Clear with dark background
      ctx.fillStyle = 'rgba(13, 13, 13, 0.95)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw waveform
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#D4A574';
      ctx.shadowBlur = 15;
      ctx.shadowColor = 'rgba(212, 165, 116, 0.8)';
      
      ctx.beginPath();
      
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        x += sliceWidth;
      }
      
      ctx.stroke();
      
      // Add accent line at zero
      ctx.strokeStyle = 'rgba(45, 149, 150, 0.3)';
      ctx.lineWidth = 1;
      ctx.shadowBlur = 0;
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
    }
    
    // Play
    playBtn.addEventListener('click', async () => {
      if (!bass) await init();
      
      if (!isPlaying) {
        await bass.engine.context.resume();
        bass.play();
        draw();
        isPlaying = true;
        playBtn.classList.add('active');
        console.log('▶ Playing');
      }
    });
    
    // Stop
    stopBtn.addEventListener('click', () => {
      if (bass && isPlaying) {
        bass.stop();
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        isPlaying = false;
        playBtn.classList.remove('active');
        
        // Clear canvas
        ctx.fillStyle = 'rgba(13, 13, 13, 0.95)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        console.log('■ Stopped');
      }
    });
    
    // Draw initial state
    ctx.fillStyle = 'rgba(13, 13, 13, 0.95)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw center line
    ctx.strokeStyle = 'rgba(45, 149, 150, 0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height / 2);
    ctx.lineTo(canvas.width, canvas.height / 2);
    ctx.stroke();
  </script>
</body>
</html>
