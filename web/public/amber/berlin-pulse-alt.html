<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BERLIN PULSE ALT</title>
    <meta name="description" content="Minimal techno pulse — Web Audio synthesis">
    <meta property="og:title" content="BERLIN PULSE ALT">
    <meta property="og:description" content="Minimal techno pulse — Web Audio synthesis">
    <meta property="og:image" content="https://intheamber.com/amber/berlin-pulse-alt-og.png">
    <meta property="og:url" content="https://kochi.to/amber/berlin-pulse-alt.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://intheamber.com/amber/berlin-pulse-alt-og.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0A0908;
            color: #D4A574;
            font-family: 'Space Mono', monospace;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        #container {
            text-align: center;
            z-index: 10;
        }

        h1 {
            font-size: 2rem;
            letter-spacing: 0.3em;
            margin-bottom: 1rem;
            color: #D4A574;
        }

        #bpm {
            font-size: 4rem;
            font-weight: bold;
            color: #B8860B;
            margin: 2rem 0;
            text-shadow: 0 0 20px rgba(212, 165, 116, 0.5);
            transition: transform 0.1s ease-out;
        }

        #controls {
            margin-top: 2rem;
        }

        button {
            background: transparent;
            border: 2px solid #D4A574;
            color: #D4A574;
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-family: 'Space Mono', monospace;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.2em;
            margin: 0 0.5rem;
        }

        button:hover {
            background: #D4A574;
            color: #0A0908;
            box-shadow: 0 0 20px rgba(212, 165, 116, 0.6);
        }

        button:active {
            transform: scale(0.95);
        }

        button.active {
            background: #D4A574;
            color: #0A0908;
        }

        #visualizer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #status {
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
            #bpm {
                font-size: 3rem;
            }
            button {
                padding: 0.8rem 2rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <canvas id="visualizer"></canvas>

    <div id="container">
        <h1>BERLIN PULSE ALT</h1>
        <div id="bpm">128</div>
        <div id="controls">
            <button id="playBtn">START</button>
        </div>
        <div id="status">Web Audio • iOS Compatible</div>
    </div>

    <script>
        let audioContext = null;
        let isPlaying = false;
        let nextNoteTime = 0;
        let schedulerTimer = null;
        let tempo = 128;
        let currentBeat = 0;

        // Visualizer
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        let pulsePhase = 0;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // iOS requires user interaction to start audio context
        function initAudio() {
            if (!audioContext) {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioCtx();

                // iOS Safari requires playing a silent buffer first
                const silentBuffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = silentBuffer;
                source.connect(audioContext.destination);
                source.start(0);
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Kick drum synth
        function playKick(time) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            // iOS needs setTargetAtTime instead of exponentialRamp for reliable playback
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.setTargetAtTime(40, time, 0.1);

            gain.gain.setValueAtTime(1, time);
            gain.gain.setTargetAtTime(0.001, time, 0.15);

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.start(time);
            osc.stop(time + 0.5);
        }

        // Hi-hat synth using noise-like oscillators
        function playHihat(time, closed = true) {
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            osc1.type = 'square';
            osc2.type = 'square';
            osc3.type = 'square';

            osc1.frequency.value = 324;
            osc2.frequency.value = 432;
            osc3.frequency.value = 578;

            filter.type = 'highpass';
            filter.frequency.value = 7000;

            const duration = closed ? 0.08 : 0.2;
            const volume = closed ? 0.25 : 0.12;

            gain.gain.setValueAtTime(volume, time);
            gain.gain.setTargetAtTime(0.001, time, duration * 0.3);

            osc1.connect(filter);
            osc2.connect(filter);
            osc3.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);

            osc1.start(time);
            osc2.start(time);
            osc3.start(time);
            osc1.stop(time + duration + 0.1);
            osc2.stop(time + duration + 0.1);
            osc3.stop(time + duration + 0.1);
        }

        // Bass synth (sub bass) - iOS compatible
        function playBass(time, note = 55) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(note, time);

            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(200, time);
            filter.frequency.setTargetAtTime(700, time, 0.05);
            filter.frequency.setTargetAtTime(200, time + 0.15, 0.1);
            filter.Q.value = 6;

            gain.gain.setValueAtTime(0.35, time);
            gain.gain.setTargetAtTime(0.001, time, 0.15);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);

            osc.start(time);
            osc.stop(time + 0.6);
        }

        // Pattern sequencer
        function scheduleNote(beatNumber, time) {
            const sixteenth = beatNumber % 4;
            const beat = Math.floor(beatNumber / 4) % 4;

            // Kick on 1 and 3
            if (sixteenth === 0 && (beat === 0 || beat === 2)) {
                playKick(time);
            }

            // Hi-hats on every eighth note
            if (sixteenth === 0 ||sixteenth === 2) {
                playHihat(time, true);
            }

            // Open hi-hat on offbeats
            if (sixteenth === 1 && beat % 2 === 1) {
                playHihat(time, false);
            }

            // Bass line (minimal)
            if (sixteenth === 0) {
                if (beat === 0) playBass(time, 55); // A1
                if (beat === 2) playBass(time, 55); // A1
                if (beat === 3) playBass(time, 65.4); // C2
            }
        }

        // Scheduler
        function scheduler() {
            const scheduleAheadTime = 0.1;
            const lookAhead = 25.0;

            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeat, nextNoteTime);

                const secondsPerBeat = 60.0 / tempo / 4; // 16th notes
                nextNoteTime += secondsPerBeat;
                currentBeat++;
            }

            schedulerTimer = setTimeout(scheduler, lookAhead);
        }

        // Visualizer animation
        function animate() {
            ctx.fillStyle = 'rgba(10, 9, 8, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (isPlaying) {
                pulsePhase += 0.08;

                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const maxRadius = Math.min(canvas.width, canvas.height) * 0.4;

                // Draw concentric circles that pulse
                for (let i = 0; i < 5; i++) {
                    const phase = pulsePhase + i * Math.PI / 5;
                    const radius = maxRadius * (0.2 + i * 0.2) * (1 + Math.sin(phase) * 0.1);
                    const alpha = 0.3 + Math.sin(phase) * 0.2;

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(212, 165, 116, ${alpha})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Draw radial lines
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2 + pulsePhase * 0.5;
                    const x1 = centerX + Math.cos(angle) * 50;
                    const y1 = centerY + Math.sin(angle) * 50;
                    const x2 = centerX + Math.cos(angle) * maxRadius;
                    const y2 = centerY + Math.sin(angle) * maxRadius;

                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.strokeStyle = 'rgba(184, 134, 11, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            requestAnimationFrame(animate);
        }
        animate();

        // Play/Stop control
        function togglePlay(btn) {
            if (!isPlaying) {
                initAudio();
                isPlaying = true;
                currentBeat = 0;
                nextNoteTime = audioContext.currentTime;
                scheduler();
                btn.textContent = 'STOP';
                btn.classList.add('active');
            } else {
                isPlaying = false;
                if (schedulerTimer) {
                    clearTimeout(schedulerTimer);
                }
                btn.textContent = 'START';
                btn.classList.remove('active');
            }
        }

        const playBtn = document.getElementById('playBtn');
        let lastTap = 0;
        playBtn.addEventListener('click', function(e) {
            // Debounce to prevent double-fire from touch+click
            const now = Date.now();
            if (now - lastTap < 300) return;
            lastTap = now;
            togglePlay(this);
        });

        // BPM pulse animation
        setInterval(() => {
            if (isPlaying) {
                const bpmEl = document.getElementById('bpm');
                bpmEl.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    bpmEl.style.transform = 'scale(1)';
                }, 100);
            }
        }, 60000 / tempo);
    </script>
</body>
</html>