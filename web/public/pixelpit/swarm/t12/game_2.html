<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SIZE HUNT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    background:#0a0a12;font-family:'Courier New',monospace;
    overflow:hidden;color:#fff;touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
  }
  #game{position:fixed;top:0;left:0;width:100%;height:100%}
  #ui{
    position:fixed;top:0;left:0;right:0;
    padding:10px 20px;
    display:flex;justify-content:space-between;align-items:center;
    pointer-events:none;
  }
  #score{font-size:20px}
  #timer{font-size:18px}
  #lives{display:flex;gap:6px}
  .heart{
    width:26px;height:26px;
    background:#D4A574;
    clip-path:path('M13 23.8l-2.1-1.9C6.4 18.7 4 16.6 4 13.8c0-2.7 2.3-4.9 5-4.9 1.6 0 3.1.8 4 2.1.9-1.3 2.4-2.1 4-2.1 2.7 0 5 2.2 5 4.9 0 2.8-2.4 4.9-5.9 7.1L13 23.8z');
    transition:transform .2s,opacity .3s;
    filter:drop-shadow(0 0 8px rgba(212,165,116,.5));
  }
  .heart.lost{opacity:.2;transform:scale(.7)}
  #start-screen,#end-screen{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(10,10,18,.95);
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    color:#D4A574;text-align:center;font-size:18px;
    padding:30px;z-index:100;
  }
  #start-screen{display:flex}
  #end-screen{display:none}
  h1{font-size:48px;margin-bottom:10px;text-shadow:0 0 40px rgba(212,165,116,.6)}
  button{
    background:transparent;border:2px solid #D4A574;color:#D4A574;
    padding:12px 40px;font-size:16px;letter-spacing:2px;cursor:pointer;
    transition:.3s;
  }
  button:hover{background:#D4A574;color:#0a0a12}
  #final-score{font-size:120px;margin:20px 0;text-shadow:0 0 60px rgba(212,165,116,.8);opacity:0;transform:scale(.5);
    animation:popIn .6s ease-out forwards}
  @keyframes popIn{0%{opacity:0;transform:scale(.5)}50%{transform:scale(1.1)}100%{opacity:1;transform:scale(1)}}
  #high-score{font-size:18px;opacity:0;
    animation:fadeIn .5s ease-out .4s forwards}
  @keyframes fadeIn{to{opacity:1}}
  #end-screen button{opacity:0;animation:fadeIn .5s ease-out .6s forwards}
  .shake{animation:shake .3s ease-out}
  @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
  .new-best{color:#FFD700!important;text-shadow:0 0 30px rgba(255,215,0,.6)}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <div id="score">0</div>
  <div id="timer">30</div>
  <div id="lives">
    <div class="heart"></div><div class="heart"></div><div class="heart"></div>
    <div class="heart"></div><div class="heart"></div>
  </div>
</div>
<div id="start-screen"><h1>SIZE HUNT</h1>
  <p>Tap fireflies when they glow. Tiny = 1, Medium = 3, Large = 5.</p>
  <p>30 seconds, 5 hearts. Beat your high score!</p>
  <button>Tap to Start</button>
</div>
<div id="end-screen">
  <h1>Game Over</h1>
  <div id="final-score">0</div>
  <div id="high-score">best: 0</div>
  <button>Play Again</button>
</div>

<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
let w,h;
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
resize();window.addEventListener('resize',resize);

let fireflies=[],particles=[];
let score=0,lives=5,gameRunning=false,gameTime=30,gameTimer=null;
let difficulty=1,spawnTimer=0;
const highScoreKey='sizehunt-high';
let highScore=parseInt(localStorage.getItem(highScoreKey)||'0');

// Audio
let audioCtx=null,musicGain=null;
function initAudio(){
  if(audioCtx)return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  musicGain=audioCtx.createGain();
  musicGain.gain.value=.3;
  musicGain.connect(audioCtx.destination);
}
function playNote(freq,dur=0.2,type='triangle',vol=.15){
  if(!audioCtx)return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type=type;osc.frequency.value=freq;
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime+0.02);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
  osc.connect(gain);gain.connect(musicGain);
  osc.start();osc.stop(audioCtx.currentTime+dur);
}
function playSparkle(){playNote(880,0.1,'sine',.2);playNote(1046,0.08,'sine',.15);}
function playMiss(){playNote(330,0.3,'triangle',.1);}

// Firefly
class Firefly{
  constructor(){
    this.size=this.randomSize();
    this.radius={tiny:12,medium:18,large:24}[this.size];
    this.points={tiny:1,medium:3,large:5}[this.size];
    this.x=60+Math.random()*(w-120);
    this.y=80+Math.random()*(h-160);
    this.phase=Math.random()*Math.PI*2;
    this.speed=0.015+Math.random()*0.015+difficulty*0.002;
    this.life=0;
    this.maxLife=200-difficulty*5;
    this.maxLife=Math.max(this.maxLife,100);
    this.caught=false;this.missed=false;this.fade=0;
    this.isBonus=Math.random()<0.15;
    this.color=this.isBonus? '#FFD700' : '#D4A574';
    this.flash= (this.size==='large')?20:0; // frames of bright flash
  }
  randomSize(){
    const r=Math.random();
    if(r<0.4)return 'tiny';
    if(r<0.8)return 'medium';
    return 'large';
  }
  get brightness(){
    if(this.caught||this.missed)return 0;
    let cycle=1;
    if(this.size==='tiny')cycle=1;
    else if(this.size==='medium')cycle=0.5+0.5*Math.sin(this.phase);
    else if(this.size==='large'){
      if(this.flash>0)return 1;
      cycle=0.3+0.2*Math.sin(this.phase);
    }
    const lifeFade=this.life<20?this.life/20: this.life>this.maxLife-30? (this.maxLife-this.life)/30:1;
    return cycle*lifeFade;
  }
  get isGlowing(){return this.brightness>0.4}
  update(){
    if(this.caught){this.fade+=0.1;return this.fade<1;}
    if(this.missed){this.fade+=0.05;return this.fade<1;}
    this.phase+=this.speed;
    this.life++;
    this.x+=Math.random()*0.4-0.2;
    this.y+=Math.random()*0.4-0.2;
    if(this.x<40||this.x>w-40)this.x= Math.max(40,Math.min(this.x,w-40));
    if(this.y<80||this.y>h-40)this.y= Math.max(80,Math.min(this.y,h-40));
    if(this.life>=this.maxLife){this.missed=true;}
    if(this.flash>0)this.flash--;
    return true;
  }
  draw(){
    const b=this.brightness;
    const [r,g,bb] = this.color.match(/\w\w/g).map(c=>parseInt(c,16));
    if(this.caught){
      const p=this.fade;
      const burstR=this.radius+ p*60;
      ctx.beginPath();ctx.arc(this.x,this.y,burstR,0,Math.PI*2);
      ctx.fillStyle=`rgba(${r},${g},${bb},${(1-p)*0.3})`;ctx.fill();
      for(let i=0;i<8;i++){
        const angle=i*2*Math.PI/8+p*3;
        const dist=p*80;
        const sx=this.x+Math.cos(angle)*dist;
        const sy=this.y+Math.sin(angle)*dist;
        ctx.beginPath();ctx.arc(sx,sy,4*(1-p),0,Math.PI*2);
        ctx.fillStyle=`rgba(${r},${g},${bb},${1-p})`;ctx.fill();
      }
      return;
    }
    if(this.missed){
      ctx.beginPath();ctx.arc(this.x,this.y,this.radius*(1-this.fade*0.5),0,Math.PI*2);
      ctx.fillStyle=`rgba(100,80,60,${(1-this.fade)*0.3})`;ctx.fill();
      return;
    }
    const glowSize=this.radius*2;
    const grad=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,glowSize);
    grad.addColorStop(0,`rgba(${r},${g},${bb},${b*0.8})`);
    grad.addColorStop(0.3,`rgba(${r},${g},${bb},${b*0.3})`);
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.beginPath();ctx.arc(this.x,this.y,glowSize,0,Math.PI*2);
    ctx.fillStyle=grad;ctx.fill();
    ctx.beginPath();ctx.arc(this.x,this.y,this.radius*0.5,0,Math.PI*2);
    ctx.fillStyle=`rgba(${r+40},${g+40},${bb+40},${0.2+b*0.8})`;ctx.fill();
  }
  contains(x,y){
    const dx=x-this.x,dy=y-this.y;
    return dx*dx+dy*dy< (this.radius+20)*(this.radius+20);
  }
}

// Particles
class Particle{
  constructor(x,y,color){
    this.x=x;this.y=y;
    this.vx=(Math.random()-0.5)*4;
    this.vy=(Math.random()-0.5)*4-1;
    this.life=1;
    this.color=color;
  }
  update(){
    this.x+=this.vx;
    this.y+=this.vy;
    this.vy+=0.05;
    this.vx*=0.98;
    this.life-=0.02;
    return this.life>0;
  }
  draw(){
    const [r,g,bb] = this.color.match(/\w\w/g).map(c=>parseInt(c,16));
    ctx.beginPath();ctx.arc(this.x,this.y,3*this.life,0,Math.PI*2);
    ctx.fillStyle=`rgba(${r},${g},${bb},${this.life})`;ctx.fill();
  }
}

// Spawn
function spawnFirefly(){
  const max=8;
  if(fireflies.length<max)fireflies.push(new Firefly());
}

// Input
function handleTap(x,y){
  if(!gameRunning)return;
  let hit=false;
  for(const f of fireflies){
    if(f.caught||f.missed)continue;
    if(f.contains(x,y)){
      hit=true;
      if(f.isGlowing){
        f.caught=true;addScore(f.points);
        playSparkle();
        for(let i=0;i<10;i++)particles.push(new Particle(f.x,f.y,f.color));
      }else{
        f.missed=true;loseLife();
        playMiss();
      }
      break;
    }
  }
  if(!hit){
    particles.push(new Particle(x,y,'#60403e'));
  }
}
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.touches[0];
  handleTap(t.clientX,t.clientY);
},{passive:false});
canvas.addEventListener('click',e=>handleTap(e.clientX,e.clientY));

// Score & Lives
function addScore(points){
  score+=points;
  document.getElementById('score').textContent=score;
  difficulty=1+Math.floor(score/10)*0.3;
  playSparkle();
}
function loseLife(){
  lives--;
  const hearts=document.querySelectorAll('.heart');
  if(hearts[lives])hearts[lives].classList.add('lost');
  document.body.classList.add('shake');
  setTimeout(()=>document.body.classList.remove('shake'),300);
  if(lives<=0)endGame();
}

// UI
function updateTimer(){
  document.getElementById('timer').textContent=gameTime;
}

// Game Loop
function update(){
  for(const s of stars) s.update();
  if(!gameRunning)return;
  spawnTimer++;
  const spawnRate=Math.max(60-difficulty*4,25);
  if(spawnTimer>=spawnRate){spawnFirefly();spawnTimer=0;}
  fireflies=fireflies.filter(f=>f.update());
  particles=particles.filter(p=>p.update());
}
function draw(){
  ctx.fillStyle='#0a0a12';ctx.fillRect(0,0,w,h);
  stars.forEach(s=>s.draw());
  fireflies.forEach(f=>f.draw());
  particles.forEach(p=>p.draw());
}
function gameLoop(){update();draw();requestAnimationFrame(gameLoop);}
gameLoop();

// Stars
class Star{
  constructor(){this.x=Math.random()*w;this.y=Math.random()*h;this.size=Math.random()*1.5;this.twinkle=Math.random()*Math.PI*2;this.speed=0.01+Math.random()*0.02;}
  update(){this.twinkle+=this.speed;}
  draw(){const a=0.3+Math.sin(this.twinkle)*0.2;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fillStyle=`rgba(200,200,220,${a})`;ctx.fill();}
}
const stars=Array.from({length:60},()=>new Star());

// Start & End
const startScreen=document.getElementById('start-screen');
startScreen.addEventListener('click',startGame);
const endScreen=document.getElementById('end-screen');
endScreen.querySelector('button').addEventListener('click',startGame);
function startGame(){
  initAudio();
  if(audioCtx.state==='suspended')audioCtx.resume();
  startScreen.style.display='none';
  endScreen.style.display='none';
  fireflies=[];particles=[];
  score=0;lives=5;difficulty=1;spawnTimer=0;gameTime=30;gameRunning=true;
  document.getElementById('score').textContent='0';
  updateTimer();
  const hearts=document.querySelectorAll('.heart');hearts.forEach(h=>h.classList.remove('lost'));
  for(let i=0;i<3;i++)setTimeout(spawnFirefly,i*300);
  playPad();
  playMelody();
  playBass();
  clearInterval(gameTimer);
  gameTimer=setInterval(()=>{
    gameTime--;updateTimer();
    if(gameTime<=0)endGame();
  },1000);
}
function endGame(){
  gameRunning=false;
  clearInterval(gameTimer);
  stopMusic();
  const final=document.getElementById('final-score');
  final.textContent=score;final.classList.remove('new-best');
  const hs=document.getElementById('high-score');
  if(score>highScore){highScore=score;localStorage.setItem(highScoreKey,highScore);hs.textContent='âœ¦ new best!';final.classList.add('new-best');hs.classList.add('new-best');}
  else{hs.textContent=`best: ${highScore}`;}
  endScreen.style.display='flex';
}

// Music
let padTimeout=null,melodyTimeout=null,bassTimeout=null;
function playPad(){
  if(!audioCtx||!gameRunning)return;
  const notes=[330/2,440/2,330];
  notes.forEach((freq,i)=>{
    const osc=audioCtx.createOscillator(),gain=audioCtx.createGain(),filter=audioCtx.createBiquadFilter();
    filter.type='lowpass';filter.frequency.value=400+i*100;filter.Q.value=1;
    osc.type='sine';osc.frequency.value=freq;
    gain.gain.setValueAtTime(0, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime+2);
    gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime+6);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+8);
    osc.connect(filter);filter.connect(gain);gain.connect(musicGain);
    osc.start();osc.stop(audioCtx.currentTime+8);
  });
  if(gameRunning)setTimeout(playPad,7000);
}
const pattern=[{n:587,d:0.2},{n:659,d:0.2},{n:739,d:0.3},{n:880,d:0.2},{n:739,d:0.2},{n:659,d:0.4},{n:null,d:0.3},{n:880,d:0.2},{n:987,d:0.2},{n:587,d:0.4},{n:null,d:0.2},{n:987,d:0.2},{n:880,d:0.3},{n:null,d:0.5}];
let mIndex=0;
function playMelody(){
  if(!audioCtx||!gameRunning)return;
  const step=pattern[mIndex];
  if(step.n)playNote(step.n,step.d+0.1,'triangle',0.12);
  mIndex=(mIndex+1)%pattern.length;
  melodyTimeout=setTimeout(playMelody,step.d*500);
}
function playBass(){
  if(!audioCtx||!gameRunning)return;
  const bass=[330/2,330/2,440/2,330/2];
  const idx=Math.floor(Date.now()/600)%bass.length;
  playNote(bass[idx],0.4,'sine',0.1);
  bassTimeout=setTimeout(playBass,600);
}
function stopMusic(){
  clearTimeout(melodyTimeout);clearTimeout(bassTimeout);
  if(musicGain){
    musicGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.5);
    setTimeout(()=>{if(musicGain)musicGain.gain.value=0.3;},600);
  }
}
</script>
</body>
</html>