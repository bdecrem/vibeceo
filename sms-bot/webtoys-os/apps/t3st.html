<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T3st Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: #d4d4d4;
        }
        
        /* Header */
        .header {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 8px 16px;
            gap: 16px;
        }
        
        .logo {
            font-weight: bold;
            font-size: 16px;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            letter-spacing: 2px;
        }
        
        .menu-bar {
            display: flex;
            gap: 4px;
            flex: 1;
        }
        
        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            user-select: none;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 14px;
        }
        
        .menu-item:hover {
            background: #3e3e42;
        }
        
        .dropdown {
            position: relative;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background: #252526;
            min-width: 180px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-top: 4px;
        }
        
        .dropdown-content a {
            color: #d4d4d4;
            padding: 8px 16px;
            text-decoration: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            font-size: 13px;
        }
        
        .dropdown-content a:hover {
            background: #3e3e42;
        }
        
        .dropdown.active .dropdown-content {
            display: block;
        }
        
        .shortcut {
            color: #808080;
            font-size: 11px;
        }
        
        /* Toolbar */
        .toolbar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .tool-btn {
            padding: 6px 12px;
            background: #3e3e42;
            border: 1px solid #464647;
            cursor: pointer;
            font-size: 13px;
            color: #d4d4d4;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tool-btn:hover {
            background: #4e4e52;
            transform: translateY(-1px);
        }
        
        .tool-btn:active {
            transform: translateY(0);
        }
        
        .separator {
            width: 1px;
            height: 20px;
            background: #3e3e42;
        }
        
        /* Editor */
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .line-numbers {
            background: #1e1e1e;
            color: #858585;
            padding: 12px 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 21px;
            text-align: right;
            user-select: none;
            min-width: 40px;
            border-right: 1px solid #2d2d30;
        }
        
        .editor {
            flex: 1;
            border: none;
            outline: none;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 21px;
            resize: none;
            background: #1e1e1e;
            color: #d4d4d4;
            tab-size: 4;
        }
        
        .editor::selection {
            background: #264f78;
        }
        
        /* Status bar */
        .status-bar {
            background: #007acc;
            padding: 4px 16px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .status-left {
            display: flex;
            gap: 16px;
        }
        
        .status-right {
            display: flex;
            gap: 16px;
        }
        
        /* Find/Replace dialog */
        .find-replace {
            position: absolute;
            top: 60px;
            right: 20px;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 12px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1001;
        }
        
        .find-replace.active {
            display: block;
        }
        
        .find-replace input {
            background: #3e3e42;
            border: 1px solid #464647;
            color: #d4d4d4;
            padding: 6px 8px;
            margin: 4px 0;
            width: 200px;
            border-radius: 3px;
            font-size: 13px;
        }
        
        .find-replace button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .find-replace button:hover {
            background: #1177bb;
        }
        
        /* Theme variations */
        body.light-theme {
            background: #ffffff;
            color: #333333;
        }
        
        body.light-theme .header {
            background: #f3f3f3;
            border-bottom-color: #e0e0e0;
        }
        
        body.light-theme .toolbar {
            background: #f8f8f8;
            border-bottom-color: #e0e0e0;
        }
        
        body.light-theme .editor-container {
            background: #ffffff;
        }
        
        body.light-theme .editor {
            background: #ffffff;
            color: #333333;
        }
        
        body.light-theme .line-numbers {
            background: #f8f8f8;
            color: #999999;
            border-right-color: #e0e0e0;
        }
        
        body.light-theme .tool-btn {
            background: #ffffff;
            border-color: #d0d0d0;
            color: #333333;
        }
        
        body.light-theme .dropdown-content {
            background: #ffffff;
            border-color: #e0e0e0;
        }
        
        body.light-theme .dropdown-content a {
            color: #333333;
        }
        
        body.light-theme .status-bar {
            background: #007acc;
        }
        
        /* Leaderboard Styles */
        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .leaderboard-modal.active {
            display: flex;
        }
        
        .leaderboard-container {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .leaderboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            background: #3e3e42;
            border: none;
            border-radius: 8px;
            color: #d4d4d4;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .leaderboard-tab.active {
            background: linear-gradient(45deg, #00ff88, #00cc6f);
            color: white;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            color: #333;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .leaderboard-entry:hover {
            transform: translateX(5px);
        }
        
        .leaderboard-entry.gold {
            background: linear-gradient(135deg, #FFD700, #FFED4E);
        }
        
        .leaderboard-entry.silver {
            background: linear-gradient(135deg, #C0C0C0, #E8E8E8);
        }
        
        .leaderboard-entry.bronze {
            background: linear-gradient(135deg, #CD7F32, #E4A853);
        }
        
        .leaderboard-entry.current-user {
            border: 2px solid #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .leaderboard-rank {
            font-size: 18px;
            font-weight: bold;
            width: 35px;
        }
        
        .leaderboard-name {
            flex: 1;
            font-size: 15px;
            text-transform: uppercase;
            padding: 0 12px;
        }
        
        .leaderboard-score {
            font-size: 16px;
            font-weight: bold;
            color: #007acc;
        }
        
        .no-scores {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 30px;
            font-style: italic;
        }
        
        .leaderboard-close {
            width: 100%;
            padding: 12px;
            background: #3e3e42;
            color: #d4d4d4;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }
        
        .leaderboard-close:hover {
            background: #4e4e52;
        }
        
        .auth-status {
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .logged-in-user {
            color: #00ff88;
            font-weight: bold;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 6px 12px;
            }
            
            .logo {
                font-size: 14px;
            }
            
            .menu-item {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .toolbar {
                padding: 6px;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tool-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .status-bar {
                padding: 3px 12px;
                font-size: 11px;
            }
            
            .dropdown-content {
                min-width: 150px;
            }
            
            .dropdown-content a {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .leaderboard-container {
                padding: 15px;
            }
            
            .leaderboard-title {
                font-size: 20px;
            }
            
            .leaderboard-entry {
                padding: 8px 10px;
            }
            
            .leaderboard-rank {
                font-size: 16px;
                width: 30px;
            }
            
            .leaderboard-name {
                font-size: 13px;
            }
            
            .leaderboard-score {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .menu-bar {
                display: none;
            }
            
            .toolbar {
                display: flex;
                flex-wrap: wrap;
            }
            
            .separator {
                display: none;
            }
            
            .tool-btn {
                flex: 0 0 auto;
                margin: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">T3ST</div>
        <div class="menu-bar">
            <div class="dropdown menu-item" onclick="toggleDropdown(this)">
                File
                <div class="dropdown-content">
                    <a href="#" onclick="newFile()">New <span class="shortcut">Ctrl+N</span></a>
                    <a href="#" onclick="openLocalFile()">Open Local File <span class="shortcut">Ctrl+O</span></a>
                    <a href="#" onclick="openSavedDocument()">Open Saved Document</a>
                    <a href="#" onclick="saveFile()">Save Locally <span class="shortcut">Ctrl+S</span></a>
                    <a href="#" onclick="saveAsFile()">Save As <span class="shortcut">Ctrl+Shift+S</span></a>
                    <a href="#" onclick="saveToSupabase()">Save to Cloud</a>
                </div>
            </div>
            <div class="dropdown menu-item" onclick="toggleDropdown(this)">
                Edit
                <div class="dropdown-content">
                    <a href="#" onclick="undo()">Undo <span class="shortcut">Ctrl+Z</span></a>
                    <a href="#" onclick="redo()">Redo <span class="shortcut">Ctrl+Y</span></a>
                    <a href="#" onclick="cut()">Cut <span class="shortcut">Ctrl+X</span></a>
                    <a href="#" onclick="copy()">Copy <span class="shortcut">Ctrl+C</span></a>
                    <a href="#" onclick="paste()">Paste <span class="shortcut">Ctrl+V</span></a>
                    <a href="#" onclick="selectAll()">Select All <span class="shortcut">Ctrl+A</span></a>
                    <a href="#" onclick="toggleFind()">Find <span class="shortcut">Ctrl+F</span></a>
                </div>
            </div>
            <div class="dropdown menu-item" onclick="toggleDropdown(this)">
                View
                <div class="dropdown-content">
                    <a href="#" onclick="toggleTheme()">Toggle Theme</a>
                    <a href="#" onclick="toggleLineNumbers()">Toggle Line Numbers</a>
                    <a href="#" onclick="toggleWordWrap()">Toggle Word Wrap</a>
                    <a href="#" onclick="increaseFontSize()">Increase Font Size <span class="shortcut">Ctrl++</span></a>
                    <a href="#" onclick="decreaseFontSize()">Decrease Font Size <span class="shortcut">Ctrl+-</span></a>
                    <a href="#" onclick="showLeaderboard()">Leaderboard <span class="shortcut">üèÜ</span></a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toolbar">
        <button class="tool-btn" onclick="newFile()">üìÑ New</button>
        <button class="tool-btn" onclick="openSavedDocument()">üìÇ Open</button>
        <button class="tool-btn" onclick="saveFile()">üíæ Save</button>
        <div class="separator"></div>
        <button class="tool-btn" onclick="undo()">‚Ü∂ Undo</button>
        <button class="tool-btn" onclick="redo()">‚Ü∑ Redo</button>
        <div class="separator"></div>
        <button class="tool-btn" onclick="cut()">‚úÇÔ∏è Cut</button>
        <button class="tool-btn" onclick="copy()">üìã Copy</button>
        <button class="tool-btn" onclick="paste()">üìå Paste</button>
        <div class="separator"></div>
        <button class="tool-btn" onclick="toggleFind()">üîç Find</button>
        <div class="separator"></div>
        <button class="tool-btn" onclick="showLeaderboard()">üèÜ Leaderboard</button>
    </div>
    
    <div class="editor-container">
        <div class="line-numbers" id="lineNumbers">1</div>
        <textarea class="editor" id="editor" placeholder="Start typing or paste your text here..." spellcheck="false"></textarea>
    </div>
    
    <div class="status-bar">
        <div class="status-left">
            <span id="fileName">Untitled</span>
            <span id="wordCount">0 words</span>
            <span id="charCount">0 characters</span>
        </div>
        <div class="status-right">
            <span id="lineCol">Ln 1, Col 1</span>
            <span id="encoding">UTF-8</span>
        </div>
    </div>
    
    <div class="find-replace" id="findReplace">
        <input type="text" id="findInput" placeholder="Find..." />
        <br>
        <button onclick="findNext()">Find Next</button>
        <button onclick="findPrev()">Find Previous</button>
        <button onclick="replaceOne()">Replace</button>
        <button onclick="replaceAll()">Replace All</button>
        <br>
        <input type="text" id="replaceInput" placeholder="Replace with..." />
    </div>
    
    <input type="file" id="fileInput" style="display: none;" accept=".txt,.md,.js,.html,.css,.json,.xml,.csv" />
    
    <!-- Leaderboard Modal -->
    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-container">
            <div class="leaderboard-title">üèÜ T3ST Leaderboard</div>
            
            <div class="auth-status" id="authStatus"></div>
            
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" onclick="switchLeaderboardTab('words')">Most Words</button>
                <button class="leaderboard-tab" onclick="switchLeaderboardTab('documents')">Most Documents</button>
            </div>
            
            <div id="leaderboardList">
                <div class="no-scores">Loading leaderboard...</div>
            </div>
            
            <button class="leaderboard-close" onclick="closeLeaderboard()">Close</button>
        </div>
    </div>
    
    <!-- Document Browser Modal -->
    <div id="documentBrowser" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
        <div style="background: #252526; border: 1px solid #3e3e42; border-radius: 8px; padding: 20px; width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #00ff88; margin-bottom: 16px;">Open Document</h2>
            <div id="documentList" style="margin-bottom: 16px;"></div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeBrowser()" style="padding: 8px 16px; background: #3e3e42; border: 1px solid #464647; color: #d4d4d4; border-radius: 4px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tqniseocczttrfwtpbdr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_wZCf4S2dQo6sCI2_GMhHQw_tJ_p7Ty0';
        
        // ZAD Configuration for leaderboard
        window.APP_ID = 't3st-leaderboard';
        
        let currentFileName = 'Untitled';
        let isDirty = false;
        let history = [];
        let historyIndex = -1;
        let wordWrap = false;
        let showLineNumbers = true;
        let fontSize = 14;
        let currentUser = null;
        let currentDocumentId = null;
        let currentLeaderboardTab = 'words';
        
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('lineNumbers');
        const fileInput = document.getElementById('fileInput');
        
        // Initialize with empty editor
        editor.value = '';
        updateLineNumbers();
        updateStatus();
        saveToHistory();
        
        // Load Supabase client
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.crossOrigin = 'anonymous';
        script.onload = () => {
            window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        };
        document.head.appendChild(script);
        
        // Authentication handling
        function loadAuthFromStorage() {
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser) {
                        if (currentUser.handle) {
                            currentUser.handle = currentUser.handle.toUpperCase();
                        }
                        if (!currentUser.participantId && currentUser.handle && currentUser.pin) {
                            currentUser.participantId = `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
                        }
                    }
                    updateAuthDisplay();
                } catch (e) {
                    console.error('Failed to load saved auth:', e);
                    localStorage.removeItem('toybox_user');
                }
            }
        }
        
        function updateAuthDisplay() {
            const authStatus = document.getElementById('authStatus');
            if (currentUser) {
                authStatus.innerHTML = `Logged in as <span class="logged-in-user">${currentUser.handle}</span>`;
            } else {
                authStatus.innerHTML = 'Not logged in - Stats won\'t be saved to leaderboard';
            }
        }
        
        // Listen for auth messages from desktop
        window.addEventListener('message', (e) => {
            if (e.data.type === 'TOYBOX_AUTH') {
                currentUser = e.data.user;
                if (currentUser) {
                    if (currentUser.handle) {
                        currentUser.handle = currentUser.handle.toUpperCase();
                    }
                    if (!currentUser.participantId && currentUser.handle && currentUser.pin) {
                        currentUser.participantId = `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
                    }
                    localStorage.setItem('toybox_user', JSON.stringify(currentUser));
                }
                updateAuthDisplay();
            }
        });
        
        // Request auth from parent
        if (window.parent !== window) {
            parent.postMessage({ type: 'GET_AUTH' }, '*');
        }
        
        // Load auth from storage
        loadAuthFromStorage();
        
        // Event listeners
        editor.addEventListener('input', () => {
            isDirty = true;
            updateLineNumbers();
            updateStatus();
            saveToHistory();
        });
        
        editor.addEventListener('scroll', () => {
            lineNumbers.scrollTop = editor.scrollTop;
        });
        
        editor.addEventListener('keyup', updateCursorPosition);
        editor.addEventListener('click', updateCursorPosition);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        if (e.shiftKey) {
                            openSavedDocument();
                        } else {
                            openLocalFile();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        if (e.shiftKey) {
                            saveAsFile();
                        } else {
                            saveFile();
                        }
                        break;
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 'f':
                        e.preventDefault();
                        toggleFind();
                        break;
                    case '=':
                    case '+':
                        e.preventDefault();
                        increaseFontSize();
                        break;
                    case '-':
                        e.preventDefault();
                        decreaseFontSize();
                        break;
                }
            }
        });
        
        // File operations
        function newFile() {
            if (isDirty && !confirm('You have unsaved changes. Do you want to continue?')) {
                return;
            }
            editor.value = '';
            currentFileName = 'Untitled';
            isDirty = false;
            document.getElementById('fileName').textContent = currentFileName;
            updateLineNumbers();
            updateStatus();
            history = [];
            historyIndex = -1;
            saveToHistory();
        }
        
        function openLocalFile() {
            fileInput.click();
        }
        
        function openFile() {
            openSavedDocument();
        }
        
        async function openSavedDocument() {
            if (!currentUser) {
                alert('Please log in through the desktop to access saved documents');
                return;
            }
            
            if (!window.supabase) {
                setTimeout(() => openSavedDocument(), 1000);
                return;
            }
            
            // Show the document browser
            const browser = document.getElementById('documentBrowser');
            browser.style.display = 'flex';
            
            // Load documents from Supabase
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '<div style="color: #808080;">Loading documents...</div>';
            
            try {
                // Use ZAD API to load documents
                const response = await fetch(`/api/zad/load?app_id=t3st-documents&participant_id=${currentUser.participantId}&action_type=document`);
                
                if (!response.ok) {
                    documentList.innerHTML = '<div style="color: #ff6b6b;">Error loading documents</div>';
                    return;
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    documentList.innerHTML = '<div style="color: #808080;">No saved documents found. Create and save your first document!</div>';
                    return;
                }
                
                // Filter for current user's documents and deduplicate
                const userDocs = data.filter(d => d.participant_id === currentUser.participantId);
                const uniqueDocs = {};
                
                userDocs.forEach(doc => {
                    const docId = doc.id || doc.content_data?.id;
                    const docTime = doc.updatedAt || doc.content_data?.updatedAt || doc.created_at;
                    
                    if (!uniqueDocs[docId] || new Date(docTime) > new Date(uniqueDocs[docId].updatedAt || uniqueDocs[docId].created_at)) {
                        uniqueDocs[docId] = {
                            id: docId,
                            title: doc.title || doc.content_data?.title || 'Untitled',
                            content: doc.content || doc.content_data?.content || '',
                            updatedAt: docTime
                        };
                    }
                });
                
                const docs = Object.values(uniqueDocs).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                
                // Display documents
                documentList.innerHTML = '';
                docs.forEach(doc => {
                    const docItem = document.createElement('div');
                    docItem.style.cssText = 'padding: 12px; background: #3e3e42; border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;';
                    docItem.onmouseover = () => docItem.style.background = '#4e4e52';
                    docItem.onmouseout = () => docItem.style.background = '#3e3e42';
                    
                    const updated = doc.updatedAt ? new Date(doc.updatedAt).toLocaleString() : 'Unknown';
                    const preview = doc.content ? doc.content.substring(0, 100) : '';
                    docItem.innerHTML = `
                        <div style="color: #d4d4d4; font-size: 14px; font-weight: bold;">${doc.title}</div>
                        <div style="color: #808080; font-size: 12px; margin-top: 4px;">Last modified: ${updated}</div>
                        <div style="color: #808080; font-size: 12px;">${preview}${preview.length >= 100 ? '...' : ''}</div>
                    `;
                    
                    docItem.onclick = () => loadDocument(doc.id, doc);
                    documentList.appendChild(docItem);
                });
            } catch (e) {
                console.error('Error:', e);
                documentList.innerHTML = '<div style="color: #ff6b6b;">Error loading documents</div>';
            }
        }
        
        function loadDocument(docId, docData) {
            currentDocumentId = docId;
            currentFileName = docData.title || 'Untitled';
            editor.value = docData.content || '';
            document.getElementById('fileName').textContent = currentFileName;
            isDirty = false;
            updateLineNumbers();
            updateStatus();
            history = [];
            historyIndex = -1;
            saveToHistory();
            closeBrowser();
        }
        
        function closeBrowser() {
            document.getElementById('documentBrowser').style.display = 'none';
        }
        
        async function saveToSupabase() {
            if (!currentUser) {
                alert('Please log in through the desktop to save documents');
                return;
            }
            
            const fileName = prompt('Enter document name:', currentFileName);
            if (!fileName) return;
            
            currentFileName = fileName;
            document.getElementById('fileName').textContent = currentFileName;
            
            const docId = currentDocumentId || 'doc_' + Date.now();
            const documentData = {
                id: docId,
                title: currentFileName,
                content: editor.value,
                author: currentUser.handle.toUpperCase(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                // Save using ZAD API
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: 't3st-documents',
                        participant_id: currentUser.participantId,
                        action_type: 'document',
                        content_data: documentData
                    })
                });
                
                if (!response.ok) {
                    console.error('Save failed:', await response.text());
                    alert('Failed to save document');
                } else {
                    currentDocumentId = docId;
                    alert('Document saved successfully!');
                    isDirty = false;
                    // Update leaderboard stats
                    await updateLeaderboardStats();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to save document');
            }
        }
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editor.value = e.target.result;
                    currentFileName = file.name;
                    isDirty = false;
                    document.getElementById('fileName').textContent = currentFileName;
                    updateLineNumbers();
                    updateStatus();
                    history = [];
                    historyIndex = -1;
                    saveToHistory();
                };
                reader.readAsText(file);
            }
        });
        
        function saveFile() {
            const blob = new Blob([editor.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.endsWith('.txt') ? currentFileName : currentFileName + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            isDirty = false;
        }
        
        function saveAsFile() {
            const fileName = prompt('Enter file name:', currentFileName);
            if (fileName) {
                currentFileName = fileName;
                document.getElementById('fileName').textContent = currentFileName;
                saveFile();
            }
        }
        
        // Edit operations
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                editor.value = history[historyIndex];
                updateLineNumbers();
                updateStatus();
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                editor.value = history[historyIndex];
                updateLineNumbers();
                updateStatus();
            }
        }
        
        function cut() {
            document.execCommand('cut');
        }
        
        function copy() {
            document.execCommand('copy');
        }
        
        function paste() {
            document.execCommand('paste');
        }
        
        function selectAll() {
            editor.select();
        }
        
        // View operations
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
        }
        
        function toggleLineNumbers() {
            showLineNumbers = !showLineNumbers;
            lineNumbers.style.display = showLineNumbers ? 'block' : 'none';
        }
        
        function toggleWordWrap() {
            wordWrap = !wordWrap;
            editor.style.whiteSpace = wordWrap ? 'pre-wrap' : 'pre';
            editor.style.wordWrap = wordWrap ? 'break-word' : 'normal';
        }
        
        function increaseFontSize() {
            fontSize = Math.min(fontSize + 2, 24);
            editor.style.fontSize = fontSize + 'px';
            lineNumbers.style.fontSize = fontSize + 'px';
            editor.style.lineHeight = (fontSize * 1.5) + 'px';
            lineNumbers.style.lineHeight = (fontSize * 1.5) + 'px';
        }
        
        function decreaseFontSize() {
            fontSize = Math.max(fontSize - 2, 10);
            editor.style.fontSize = fontSize + 'px';
            lineNumbers.style.fontSize = fontSize + 'px';
            editor.style.lineHeight = (fontSize * 1.5) + 'px';
            lineNumbers.style.lineHeight = (fontSize * 1.5) + 'px';
        }
        
        // Find/Replace
        function toggleFind() {
            const findReplace = document.getElementById('findReplace');
            findReplace.classList.toggle('active');
            if (findReplace.classList.contains('active')) {
                document.getElementById('findInput').focus();
            }
        }
        
        function findNext() {
            const searchTerm = document.getElementById('findInput').value;
            if (!searchTerm) return;
            
            const text = editor.value;
            const selectionStart = editor.selectionEnd;
            const index = text.indexOf(searchTerm, selectionStart);
            
            if (index !== -1) {
                editor.setSelectionRange(index, index + searchTerm.length);
                editor.focus();
            } else {
                // Wrap around to beginning
                const wrapIndex = text.indexOf(searchTerm);
                if (wrapIndex !== -1) {
                    editor.setSelectionRange(wrapIndex, wrapIndex + searchTerm.length);
                    editor.focus();
                }
            }
        }
        
        function findPrev() {
            const searchTerm = document.getElementById('findInput').value;
            if (!searchTerm) return;
            
            const text = editor.value;
            const selectionStart = editor.selectionStart;
            const index = text.lastIndexOf(searchTerm, selectionStart - 1);
            
            if (index !== -1) {
                editor.setSelectionRange(index, index + searchTerm.length);
                editor.focus();
            }
        }
        
        function replaceOne() {
            const findText = document.getElementById('findInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!findText) return;
            
            const selectionStart = editor.selectionStart;
            const selectionEnd = editor.selectionEnd;
            const selectedText = editor.value.substring(selectionStart, selectionEnd);
            
            if (selectedText === findText) {
                editor.setRangeText(replaceText);
                findNext();
            } else {
                findNext();
            }
        }
        
        function replaceAll() {
            const findText = document.getElementById('findInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!findText) return;
            
            editor.value = editor.value.replaceAll(findText, replaceText);
            updateLineNumbers();
            updateStatus();
            saveToHistory();
        }
        
        // Helper functions
        function updateLineNumbers() {
            const lines = editor.value.split('\n').length;
            let lineNumbersText = '';
            for (let i = 1; i <= lines; i++) {
                lineNumbersText += i + '\n';
            }
            lineNumbers.textContent = lineNumbersText;
        }
        
        function updateStatus() {
            const text = editor.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('charCount').textContent = `${chars} characters`;
        }
        
        function updateCursorPosition() {
            const pos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, pos);
            const lines = textBeforeCursor.split('\n');
            const currentLine = lines.length;
            const currentCol = lines[lines.length - 1].length + 1;
            
            document.getElementById('lineCol').textContent = `Ln ${currentLine}, Col ${currentCol}`;
        }
        
        function saveToHistory() {
            // Limit history
            if (history.length > 50) {
                history = history.slice(-50);
            }
            
            // Remove any history after current index
            history = history.slice(0, historyIndex + 1);
            
            // Add current state
            history.push(editor.value);
            historyIndex = history.length - 1;
        }
        
        function toggleDropdown(element) {
            // Close all other dropdowns
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                if (dropdown !== element) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            element.classList.toggle('active');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });
        
        // Leaderboard Functions
        async function updateLeaderboardStats() {
            if (!currentUser) return;
            
            // Count words in current document
            const text = editor.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            
            // Load existing stats
            try {
                const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&participant_id=${currentUser.participantId}&action_type=user_stats`);
                let userStats = null;
                
                if (response.ok) {
                    const data = await response.json();
                    const existing = data.find(d => d.participant_id === currentUser.participantId);
                    if (existing) {
                        userStats = existing.content_data;
                    }
                }
                
                if (!userStats) {
                    userStats = {
                        handle: currentUser.handle,
                        totalWords: 0,
                        totalDocuments: 0,
                        longestDocument: 0,
                        lastUpdated: new Date().toISOString()
                    };
                }
                
                // Update stats
                userStats.totalWords += words;
                userStats.totalDocuments += 1;
                userStats.longestDocument = Math.max(userStats.longestDocument, words);
                userStats.lastUpdated = new Date().toISOString();
                
                // Save updated stats
                await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        participant_id: currentUser.participantId,
                        action_type: 'user_stats',
                        content_data: userStats
                    })
                });
                
                console.log('Leaderboard stats updated');
            } catch (error) {
                console.error('Failed to update leaderboard stats:', error);
            }
        }
        
        async function loadLeaderboard() {
            try {
                const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&action_type=user_stats`);
                if (response.ok) {
                    const data = await response.json();
                    return data.map(item => item.content_data).filter(stats => stats);
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
            return [];
        }
        
        async function displayLeaderboard() {
            const stats = await loadLeaderboard();
            const listEl = document.getElementById('leaderboardList');
            
            if (stats.length === 0) {
                listEl.innerHTML = '<div class="no-scores">No data yet. Be the first to save a document!</div>';
                return;
            }
            
            // Sort based on current tab
            if (currentLeaderboardTab === 'words') {
                stats.sort((a, b) => (b.totalWords || 0) - (a.totalWords || 0));
            } else {
                stats.sort((a, b) => (b.totalDocuments || 0) - (a.totalDocuments || 0));
            }
            
            // Take top 10
            const topStats = stats.slice(0, 10);
            
            listEl.innerHTML = topStats.map((userStats, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';
                
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank + '.';
                
                const isCurrentUser = currentUser && userStats.handle === currentUser.handle;
                const userClass = isCurrentUser ? 'current-user' : '';
                
                const score = currentLeaderboardTab === 'words' 
                    ? `${userStats.totalWords || 0} words`
                    : `${userStats.totalDocuments || 0} docs`;
                
                return `
                    <div class="leaderboard-entry ${rankClass} ${userClass}">
                        <div class="leaderboard-rank">${medal}</div>
                        <div class="leaderboard-name">${userStats.handle || 'ANON'}</div>
                        <div class="leaderboard-score">${score}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showLeaderboard() {
            document.getElementById('leaderboardModal').classList.add('active');
            displayLeaderboard();
        }
        
        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.remove('active');
        }
        
        function switchLeaderboardTab(tab) {
            currentLeaderboardTab = tab;
            
            // Update tab styles
            const tabs = document.querySelectorAll('.leaderboard-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Refresh leaderboard
            displayLeaderboard();
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Clear editor on fresh load
            editor.value = '';
            updateLineNumbers();
            updateStatus();
            
            loadAuthFromStorage();
            // Request auth state from parent (if in iframe)
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'GET_AUTH' }, '*');
            }
        });
    </script>
</body>
</html>