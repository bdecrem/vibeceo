<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortune Cookie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(ellipse at top, #ffeaa7 0%, #fdcb6e 40%, #e17055 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        /* Animated background particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: particleFloat 15s infinite linear;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        .container {
            text-align: center;
            max-width: 500px;
            width: 100%;
            z-index: 10;
        }

        h1 {
            color: white;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 3rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.1);
            letter-spacing: -1px;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 4px 20px rgba(0,0,0,0.1); }
            50% { text-shadow: 0 4px 30px rgba(255,255,255,0.5); }
        }

        .cookie-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 2rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .cookie-container:hover {
            transform: scale(1.05);
        }

        .cookie-container:active {
            transform: scale(0.98);
        }

        .cookie {
            width: 260px;
            height: 180px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 130px 130px 130px 130px / 90px 90px 90px 90px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.15),
                inset 0 2px 5px rgba(255,255,255,0.5),
                inset 0 -3px 5px rgba(0,0,0,0.1);
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .cookie.cracked {
            animation: crack 0.6s ease-out;
        }

        @keyframes crack {
            0% { transform: translate(-50%, -50%) rotate(0); }
            20% { transform: translate(-50%, -50%) rotate(-5deg) scale(1.1); }
            40% { transform: translate(-50%, -50%) rotate(5deg) scale(1.15); }
            60% { transform: translate(-50%, -50%) rotate(-3deg) scale(1.1); }
            100% { transform: translate(-50%, -50%) rotate(0) scale(1); }
        }

        .cookie::before,
        .cookie::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(0,0,0,0.08);
            border-radius: 50%;
        }

        .cookie::before {
            top: 40%;
            left: 25%;
        }

        .cookie::after {
            bottom: 40%;
            right: 28%;
        }

        .fortune-slip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0) rotateX(90deg);
            width: 85%;
            max-width: 280px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.15),
                0 0 0 1px rgba(0,0,0,0.03);
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 20;
        }

        .fortune-slip.revealed {
            transform: translate(-50%, -50%) scale(1) rotateX(0);
            opacity: 1;
            animation: floatPaper 3s ease-in-out infinite;
        }

        @keyframes floatPaper {
            0%, 100% { transform: translate(-50%, -50%) translateY(0) scale(1) rotateX(0); }
            50% { transform: translate(-50%, -48%) translateY(-5px) scale(1) rotateX(0); }
        }

        .fortune-text {
            color: #2d3436;
            font-size: 1.05rem;
            line-height: 1.7;
            font-weight: 500;
            font-style: italic;
            margin-bottom: 20px;
            position: relative;
            padding: 0 10px;
        }

        .lucky-numbers {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .lucky-number {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            animation: numberPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation-fill-mode: both;
        }

        .lucky-number:nth-child(1) { animation-delay: 0.1s; }
        .lucky-number:nth-child(2) { animation-delay: 0.2s; }
        .lucky-number:nth-child(3) { animation-delay: 0.3s; }
        .lucky-number:nth-child(4) { animation-delay: 0.4s; }
        .lucky-number:nth-child(5) { animation-delay: 0.5s; }

        @keyframes numberPop {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        .hint {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }

        /* Confetti effect */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            animation: confettiFall 3s linear;
            animation-fill-mode: forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Save indicator */
        .save-bubble {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2d3436;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-20px) scale(0.8);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            pointer-events: none;
        }

        .save-bubble.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* History panel */
        .history-panel {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            width: 280px;
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.5s ease;
        }

        .history-panel.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .history-panel h3 {
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.85rem;
            line-height: 1.4;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 640px) {
            h1 { font-size: 2.2rem; }
            .cookie-container { width: 260px; height: 260px; }
            .cookie { width: 220px; height: 150px; }
            .history-panel { 
                left: 20px; 
                bottom: 20px; 
                right: 20px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✨ Fortune Cookie</h1>
        
        <div class="cookie-container" onclick="openFortune()">
            <div class="cookie" id="cookie"></div>
            <div class="fortune-slip" id="fortuneSlip">
                <div class="fortune-text" id="fortuneText"></div>
                <div class="lucky-numbers" id="luckyNumbers"></div>
            </div>
        </div>
        
        <p class="hint" id="hint">Click the cookie to reveal your fortune</p>
    </div>

    <div class="save-bubble" id="saveBubble">✨ Fortune saved!</div>

    <div class="history-panel" id="historyPanel">
        <h3>Recent Fortunes</h3>
        <div id="historyList"></div>
    </div>

    <script>
        // Global auth state
        let currentUser = null;
        let isOpen = false;
        let fortuneHistory = [];

        // Load auth from localStorage (immediate)
        function loadAuthFromStorage() {
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser) {
                    if (currentUser.handle) currentUser.handle = currentUser.handle.toUpperCase();
                    if (!currentUser.participantId && currentUser.handle && currentUser.pin) {
                        currentUser.participantId = `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
                    }
                }
            }
            return !!currentUser;
        }

        // Listen for auth from desktop (real-time)
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'TOYBOX_AUTH') {
                currentUser = e.data.user;
                if (currentUser) {
                    if (currentUser.handle) currentUser.handle = currentUser.handle.toUpperCase();
                    if (!currentUser.participantId && currentUser.handle && currentUser.pin) {
                        currentUser.participantId = `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
                    }
                }
                if (currentUser) loadUserData();
            }
        });

        const fortunes = [
            "A moment of patience in a moment of anger saves you a hundred moments of regret.",
            "Your creative energy will bring unexpected rewards today.",
            "The answer you seek is hidden in the question itself.",
            "A chance meeting will open doors you didn't know existed.",
            "Your kindness today will echo through eternity.",
            "Something wonderful is about to happen when you least expect it.",
            "The path ahead is clearer than it appears—trust your instincts.",
            "Your next laugh will heal more than just your spirit.",
            "An old friend will bring new opportunities.",
            "The universe is aligning in your favor—be ready.",
            "Your unique perspective is about to solve a big problem.",
            "Today's small step is tomorrow's giant leap.",
            "Someone is thinking of you with gratitude right now.",
            "Your courage will inspire someone to change their life.",
            "The best surprise of your life is just around the corner.",
            "Your intuition is especially strong today—follow it.",
            "A creative solution will present itself in your dreams.",
            "The love you give will return to you multiplied.",
            "Your persistence is about to pay off spectacularly.",
            "An unexpected compliment will brighten your whole week.",
            "The thing you're worried about will work out beautifully.",
            "Your smile today will be someone's favorite memory.",
            "A door you thought was closed is actually just waiting.",
            "Your next 'yes' will lead to an amazing adventure.",
            "The magic you seek is already within you."
        ];

        // Create background particles
        function createParticles() {
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                document.body.appendChild(particle);
            }
        }

        function generateLuckyNumbers() {
            const numbers = [];
            while (numbers.length < 5) {
                const num = Math.floor(Math.random() * 49) + 1;
                if (!numbers.includes(num)) numbers.push(num);
            }
            return numbers.sort((a, b) => a - b);
        }

        function createConfetti(x, y) {
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = (x + (Math.random() - 0.5) * 100) + 'px';
                    confetti.style.top = (y - 50) + 'px';
                    confetti.style.width = (5 + Math.random() * 5) + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.background = `hsl(${Math.random() * 360}, 70%, 60%)`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function openFortune() {
            const cookie = document.getElementById('cookie');
            const fortuneSlip = document.getElementById('fortuneSlip');
            const fortuneText = document.getElementById('fortuneText');
            const luckyNumbers = document.getElementById('luckyNumbers');
            const hint = document.getElementById('hint');
            
            if (isOpen) {
                fortuneSlip.classList.remove('revealed');
                cookie.classList.remove('cracked');
                isOpen = false;
                hint.textContent = 'Click the cookie to reveal your fortune';
                setTimeout(() => {
                    fortuneText.textContent = '';
                    luckyNumbers.innerHTML = '';
                }, 500);
                return;
            }
            
            // Get new fortune
            const fortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            const numbers = generateLuckyNumbers();
            
            // Animate cookie crack
            cookie.classList.add('cracked');
            
            // Create confetti effect
            const rect = cookie.getBoundingClientRect();
            createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
            
            // Show fortune
            setTimeout(() => {
                fortuneText.textContent = fortune;
                luckyNumbers.innerHTML = numbers
                    .map(n => `<div class="lucky-number">${n}</div>`)
                    .join('');
                fortuneSlip.classList.add('revealed');
                isOpen = true;
                hint.textContent = 'Click again for another fortune';
                
                // Save if logged in
                if (currentUser) {
                    saveFortune(fortune, numbers);
                }
                
                // Add to local history
                fortuneHistory.unshift({ fortune, numbers, timestamp: new Date() });
                if (fortuneHistory.length > 5) fortuneHistory.pop();
                updateHistory();
            }, 300);
        }

        async function saveFortune(fortune, numbers) {
            if (!currentUser?.participantId) return;
            
            const participantId = currentUser.participantId || `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
            
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: 'toybox-fortune-cookie',
                        participant_id: participantId,
                        action_type: 'fortune',
                        content_data: {
                            id: Date.now().toString(),
                            fortune: fortune,
                            lucky_numbers: numbers,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                if (response.ok) {
                    showSaveIndicator();
                    loadUserData();
                }
            } catch (err) {
                console.error('Save failed:', err);
            }
        }

        async function loadUserData() {
            if (!currentUser?.participantId) return;
            
            const participantId = currentUser.participantId || `${currentUser.handle.toUpperCase()}_${currentUser.pin}`;
            
            try {
                const response = await fetch(`/api/zad/load?app_id=toybox-fortune-cookie&action_type=fortune`);
                const data = await response.json();
                
                // Filter and deduplicate
                const userFortunes = data.filter(d => d.participant_id === participantId);
                const uniqueFortunes = {};
                
                userFortunes.forEach(item => {
                    const id = item.id || item.content_data?.id || item.timestamp;
                    const timestamp = item.timestamp || item.content_data?.timestamp || item.created_at;
                    
                    if (!uniqueFortunes[id] || new Date(timestamp) > new Date(uniqueFortunes[id].timestamp)) {
                        uniqueFortunes[id] = {
                            fortune: item.fortune || item.content_data?.fortune,
                            numbers: item.lucky_numbers || item.content_data?.lucky_numbers,
                            timestamp: timestamp
                        };
                    }
                });
                
                fortuneHistory = Object.values(uniqueFortunes)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5);
                
                updateHistory();
            } catch (err) {
                console.error('Load failed:', err);
            }
        }

        function updateHistory() {
            if (fortuneHistory.length === 0) return;
            
            const panel = document.getElementById('historyPanel');
            const list = document.getElementById('historyList');
            
            panel.classList.add('visible');
            list.innerHTML = fortuneHistory
                .map(item => {
                    const text = item.fortune || '';
                    const truncated = text.length > 60 ? text.substring(0, 60) + '...' : text;
                    return `<div class="history-item">${truncated}</div>`;
                })
                .join('');
        }

        function showSaveIndicator() {
            const bubble = document.getElementById('saveBubble');
            bubble.classList.add('show');
            setTimeout(() => bubble.classList.remove('show'), 2000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            if (loadAuthFromStorage()) {
                loadUserData();
            }
        });
    </script>
</body>
</html>