<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBTOYS Issue Tracker</title>
    <style>
        :root {
            --cream: #FEFEF5;
            --yellow: #FFD63D;
            --blue: #6ECBFF;
            --red: #FF4B4B;
            --green-mint: #B6FFB3;
            --purple-shadow: #C9C2F9;
            --yellow-soft: #FFF4CC;
            --blue-deep: #4A9FD4;
            --red-soft: #FF7A7A;
            --purple-accent: #8B7FD4;
            --green-sage: #7FB069;
            --charcoal: #2A2A2A;
            --gray-warm: #6B6B6B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--cream);
            min-height: 100vh;
            padding: 10px;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .issue-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .badge {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin: 2px;
            }
            
            .status-timeline {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .status-step {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .reaction-btn {
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }
            
            .issue-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .issue-meta {
                flex-wrap: wrap;
                gap: 5px;
                font-size: 0.8rem;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: var(--charcoal);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0px var(--yellow), 6px 6px 0px var(--yellow-soft);
            font-weight: 900;
        }
        
        h2 {
            color: var(--charcoal);
            text-shadow: 2px 2px 0px var(--yellow-soft);
            font-weight: 800;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            transform: rotate(-0.5deg);
            transition: transform 0.3s ease;
        }
        
        .card:nth-child(even) {
            transform: rotate(0.5deg);
        }
        
        .card:hover {
            transform: rotate(0deg) scale(1.02);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--charcoal);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 3px solid var(--charcoal);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--yellow-soft);
            font-weight: 600;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--blue);
            background: white;
            transform: scale(1.02);
            box-shadow: 0 0 0 3px var(--blue-deep);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        button {
            background: var(--blue);
            color: var(--charcoal);
            border: 3px solid var(--charcoal);
            padding: 16px 32px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 4px 4px 0px var(--charcoal);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-3px) translateX(-3px);
            box-shadow: 7px 7px 0px var(--charcoal);
            background: var(--yellow);
        }

        button:active {
            transform: translateY(1px) translateX(1px);
            box-shadow: 2px 2px 0px var(--charcoal);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .issue-list {
            /* Natural flow - no height restrictions or separate scrolling */
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .pagination-controls button {
            padding: 10px 20px;
            font-size: 14px;
            min-width: 80px;
        }
        
        .pagination-info {
            color: var(--gray-warm);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .pagination-controls {
                gap: 8px;
            }
            
            .pagination-controls button {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 60px;
            }
        }

        .issue-item {
            padding: 24px;
            border-left: 6px solid var(--blue);
            margin-bottom: 18px;
            background: linear-gradient(145deg, #ffffff 0%, #fefefe 100%);
            border-radius: 22px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 3px 3px 0px var(--purple-shadow);
            transform: rotate(-0.3deg);
            border: 1px solid rgba(42, 42, 42, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .issue-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--blue), var(--green-mint), var(--yellow));
            opacity: 0.7;
        }
        
        .issue-item:nth-child(even) {
            transform: rotate(0.3deg);
            border-left-color: var(--green-mint);
            box-shadow: 3px 3px 0px var(--yellow-soft);
        }
        
        .issue-item:nth-child(3n) {
            border-left-color: var(--red);
            box-shadow: 3px 3px 0px var(--red-soft);
        }

        .issue-item:hover {
            transform: translateY(-5px) rotate(0deg) scale(1.02);
            box-shadow: 5px 8px 0px var(--purple-shadow);
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .issue-title {
            font-weight: 700;
            color: var(--charcoal);
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.4;
            margin-top: 8px;
        }

        .issue-meta {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 700;
            border: 2px solid var(--charcoal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-bug {
            background: var(--red-soft);
            color: var(--charcoal);
        }

        .badge-feature {
            background: var(--green-mint);
            color: var(--charcoal);
        }

        .badge-enhancement {
            background: var(--yellow);
            color: var(--charcoal);
        }

        .badge-triage {
            background: var(--purple-shadow);
            color: var(--charcoal);
        }

        .badge-status {
            background: var(--blue);
            color: var(--charcoal);
        }

        .badge-new {
            background: var(--purple-shadow);
            color: var(--charcoal);
        }

        .badge-reformulated {
            background: var(--yellow);
            color: var(--charcoal);
        }

        .badge-fixing {
            background: var(--yellow-soft);
            color: var(--charcoal);
        }

        .badge-fixed {
            background: var(--green-mint);
            color: var(--charcoal);
        }

        .badge-pr-created {
            background: var(--green-sage);
            color: var(--charcoal);
        }

        .badge-failed {
            background: var(--red);
            color: white;
        }
        
        .badge-closed {
            background: var(--gray-warm);
            color: white;
        }
        
        .badge-needs-info {
            background: var(--orange);
            color: var(--charcoal);
        }
        
        .badge-documentation {
            background: var(--blue);
            color: var(--charcoal);
        }

        .status-timeline {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            position: relative;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(42, 42, 42, 0.1);
        }

        .status-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            position: relative;
            z-index: 2;
            color: var(--gray-warm);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .status-step.completed {
            color: var(--green-sage);
            font-weight: 700;
        }

        .status-step.current {
            color: var(--charcoal);
            font-weight: 800;
            transform: scale(1.05);
        }
        
        .status-step.blocked {
            color: var(--red);
            font-weight: 700;
        }
        
        .status-step.pending {
            color: #ccc;
            font-weight: 500;
        }
        
        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 214, 61, 0.7);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(255, 214, 61, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 214, 61, 0);
            }
        }
        
        .status-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-bottom: 8px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid;
        }
        
        .status-circle.completed {
            background: var(--green-sage);
            border-color: var(--green-sage);
            box-shadow: 0 0 0 4px rgba(127, 176, 105, 0.2), 
                        0 2px 8px rgba(127, 176, 105, 0.4);
        }
        
        .status-circle.completed::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 900;
        }
        
        .status-circle.current {
            background: var(--yellow);
            border-color: var(--yellow);
            animation: pulse-circle 2s infinite;
            box-shadow: 0 0 0 4px rgba(255, 214, 61, 0.3);
        }
        
        .status-circle.current::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--charcoal);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }
        
        .status-circle.pending {
            background: transparent;
            border-color: #ddd;
            box-shadow: none;
        }
        
        .status-circle.blocked {
            background: var(--red);
            border-color: var(--red);
            box-shadow: 0 0 0 4px rgba(255, 75, 75, 0.2);
        }
        
        .status-circle.blocked::after {
            content: '✗';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 900;
        }
        
        @keyframes pulse-circle {
            0% {
                box-shadow: 0 0 0 4px rgba(255, 214, 61, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(255, 214, 61, 0.1);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 4px rgba(255, 214, 61, 0.3);
                transform: scale(1);
            }
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.2); }
        }
        
        /* Connection lines between status circles */
        .status-step:not(:last-child)::before {
            content: '';
            position: absolute;
            top: 12px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent 24px, #ddd 24px, #ddd calc(100% - 24px), transparent calc(100% - 24px));
            z-index: 1;
        }
        
        .status-step.completed:not(:last-child)::before {
            background: linear-gradient(to right, transparent 24px, var(--green-sage) 24px, var(--green-sage) calc(100% - 24px), transparent calc(100% - 24px));
        }
        
        .status-step.current:not(:last-child)::before {
            background: linear-gradient(to right, transparent 24px, var(--yellow) 24px, #ddd calc(50%), #ddd calc(100% - 24px), transparent calc(100% - 24px));
        }
        
        @media (max-width: 768px) {
            .status-timeline {
                padding: 15px 5px;
            }
            
            .status-step {
                font-size: 0.55rem;
                padding: 4px 2px;
            }
            
            .status-circle {
                width: 20px;
                height: 20px;
                margin-bottom: 6px;
            }
            
            .status-circle.completed::after,
            .status-circle.blocked::after {
                font-size: 10px;
            }
            
            .status-step:not(:last-child)::before {
                top: 10px;
                background: linear-gradient(to right, transparent 20px, #ddd 20px, #ddd calc(100% - 20px), transparent calc(100% - 20px));
            }
            
            .status-step.completed:not(:last-child)::before {
                background: linear-gradient(to right, transparent 20px, var(--green-sage) 20px, var(--green-sage) calc(100% - 20px), transparent calc(100% - 20px));
            }
            
            .status-step.current:not(:last-child)::before {
                background: linear-gradient(to right, transparent 20px, var(--yellow) 20px, #ddd calc(50%), #ddd calc(100% - 20px), transparent calc(100% - 20px));
            }
        }

        .reactions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .reaction-btn {
            background: var(--yellow-soft);
            border: 2px solid var(--charcoal);
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 2px 2px 0px var(--charcoal);
        }

        .reaction-btn:hover {
            background: var(--green-mint);
            transform: translateY(-2px) scale(1.1);
            box-shadow: 3px 5px 0px var(--charcoal);
        }

        .reaction-btn:active {
            transform: translateY(0px);
            box-shadow: 1px 1px 0px var(--charcoal);
        }
        
        .reaction-btn.upvote {
            color: var(--green-sage);
            font-weight: 700;
            font-size: 16px;
        }
        
        .reaction-btn.downvote {
            color: var(--red);
            font-weight: 700;
            font-size: 16px;
        }
        
        .reaction-btn.upvote:hover {
            background: var(--green-mint);
            color: var(--charcoal);
        }
        
        .reaction-btn.downvote:hover {
            background: var(--red-soft);
            color: var(--charcoal);
        }
        
        .vote-count {
            font-weight: 800;
            margin-left: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: var(--red-soft);
            color: var(--charcoal);
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 3px solid var(--red);
            font-weight: 600;
            box-shadow: 3px 3px 0px var(--red);
        }

        .success {
            background: var(--green-mint);
            color: var(--charcoal);
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 3px solid var(--green-sage);
            font-weight: 600;
            box-shadow: 3px 3px 0px var(--green-sage);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray-warm);
            font-weight: 600;
            font-size: 18px;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            background: var(--cream);
            color: var(--charcoal);
            border: 2px solid var(--charcoal);
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 0px var(--charcoal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-btn:hover {
            background: var(--yellow-soft);
            transform: translateY(-2px);
            box-shadow: 3px 4px 0px var(--charcoal);
        }
        
        .filter-btn.active {
            background: var(--blue);
            color: var(--charcoal);
            font-weight: 700;
        }
        
        .issue-number {
            font-weight: 900;
            color: var(--purple-accent);
            font-size: 1.3rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 0px var(--purple-shadow);
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, var(--purple-shadow), #E6E6FA);
            border-radius: 12px;
            border: 2px solid var(--purple-accent);
            box-shadow: 2px 2px 0px var(--purple-accent);
        }
        
        .confidence-priority {
            margin-top: 10px;
            padding: 10px;
            background: var(--yellow-soft);
            border-radius: 10px;
            border: 2px solid var(--charcoal);
        }
        
        .confidence-priority strong {
            color: var(--charcoal);
            display: block;
            margin-bottom: 5px;
        }
        
        .cass-comment {
            margin-top: 15px;
            padding: 18px;
            background: linear-gradient(135deg, var(--blue) 0%, #87CEEB 100%);
            border-radius: 18px;
            border: 3px solid var(--blue-deep);
            box-shadow: 0 4px 12px rgba(74, 159, 212, 0.3), 2px 2px 0px var(--blue-deep);
            position: relative;
            overflow: hidden;
        }
        
        .cass-comment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--yellow), var(--green-mint), var(--purple-shadow));
            animation: rainbow-shimmer 3s linear infinite;
        }
        
        @keyframes rainbow-shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .cass-comment strong {
            color: var(--charcoal);
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .cass-comment::after {
            content: '💭';
            position: absolute;
            top: -5px;
            right: 10px;
            font-size: 24px;
            opacity: 0.6;
        }
        
        @media (max-width: 768px) {
            .filter-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            /* Remove all rotation and hover effects on mobile for stability */
            .card {
                transform: none !important;
                transition: none !important;
            }
            
            .card:nth-child(even) {
                transform: none !important;
            }
            
            .card:hover {
                transform: none !important;
            }
            
            .issue-item {
                transform: none !important;
                transition: box-shadow 0.3s ease !important;
            }
            
            .issue-item:nth-child(even) {
                transform: none !important;
            }
            
            .issue-item:nth-child(3n) {
                transform: none !important;
            }
            
            .issue-item:hover {
                transform: none !important;
                box-shadow: 5px 8px 0px var(--purple-shadow) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🐛 WEBTOYS Issue Tracker</h1>
            <p class="subtitle">Report bugs and request features for the WEBTOYS platform</p>
        </header>

        <div class="card">
            <h2>Submit New Issue</h2>
            <div id="submitForm">
                <div class="form-group">
                    <label for="idea">Description</label>
                    <textarea id="idea" placeholder="Describe the issue or feature request in detail..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="author">Your Name (optional)</label>
                    <input type="text" id="author" placeholder="Anonymous" />
                </div>

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="triage">Needs Triage</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="enhancement">Enhancement</option>
                        <option value="documentation">Documentation</option>
                    </select>
                </div>

                <button onclick="submitIssue()">Submit Issue</button>
            </div>

            <div id="message"></div>
        </div>

        <div class="card">
            <h2>Issues</h2>
            
            <!-- Filter Controls -->
            <div class="filter-controls" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">All Issues</button>
                <button class="filter-btn" onclick="setFilter('active')" data-filter="active">Active</button>
                <button class="filter-btn" onclick="setFilter('resolved')" data-filter="resolved">Resolved</button>
                <button class="filter-btn" onclick="setFilter('new')" data-filter="new">New</button>
                <button class="filter-btn" onclick="setFilter('fixing')" data-filter="fixing">In Progress</button>
                <button class="filter-btn" onclick="setFilter('closed')" data-filter="closed">Closed</button>
            </div>
            
            <div id="issueList" class="issue-list">
                <div class="loading">Loading issues...</div>
            </div>
        </div>
        
        <!-- Pagination Controls - Now outside the card -->
        <div class="pagination-controls" id="paginationControls" style="display: none; margin-top: 20px; margin-bottom: 30px;">
            <button onclick="changePage(-1)" id="prevBtn">← Previous</button>
            <div class="pagination-info" id="paginationInfo">Page 1 of 1</div>
            <button onclick="changePage(1)" id="nextBtn">Next →</button>
        </div>
    </div>

    <script>
        // ZAD Configuration
        window.APP_ID = '83218c2e-281e-4265-a95f-1d3f763870d4';
        
        // Pagination state
        let currentPage = 1;
        let issuesPerPage = 10;
        let allIssues = [];
        let filteredIssues = [];
        let currentFilter = 'all';
        
        // Content filtering - offensive words to hide
        const OFFENSIVE_WORDS = ['fuck', 'shit', 'damn', 'asshole', 'bitch', 'bastard', 'crap'];
        
        // ZAD Helper Functions (injected by WEBTOYS)
        async function save(actionType, data, participantData = null) {
            const participantId = localStorage.getItem('participant_id') || 
                                 'user_' + Math.random().toString(36).substr(2, 9);
            
            if (!localStorage.getItem('participant_id')) {
                localStorage.setItem('participant_id', participantId);
            }

            const response = await fetch('https://webtoys.ai/api/zad/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    app_id: window.APP_ID,
                    participant_id: participantId,
                    action_type: actionType,
                    content_data: data,
                    participant_data: participantData
                })
            });
            return response.json();
        }

        async function load(actionType, filters = {}) {
            try {
                // Build query parameters for GET request
                const params = new URLSearchParams({
                    app_id: window.APP_ID,
                    action_type: actionType
                });
                
                // Add any additional filters
                if (filters.participant_id) {
                    params.append('participant_id', filters.participant_id);
                }
                
                const url = `https://webtoys.ai/api/zad/load?${params.toString()}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API response:', result);
                
                // The API returns an array directly, not wrapped in { data: [] }
                return Array.isArray(result) ? result : (result.data || []);
            } catch (error) {
                console.error('Load function error:', error);
                throw error;
            }
        }

        // Application Functions
        async function submitIssue() {
            const author = document.getElementById('author').value || 'Anonymous';
            const category = document.getElementById('category').value;
            const idea = document.getElementById('idea').value;

            if (!idea.trim()) {
                showMessage('Please describe your issue or feature request', 'error');
                return;
            }

            // Get the next issue number
            const issueNumber = await getNextIssueNumber();
            
            const issueData = {
                idea: idea,
                author: author,
                category: category,
                status: 'new',
                issue_number: issueNumber, // Store the sequential issue number
                comments: [],
                reactions: {
                    '👍': 0,
                    '🔥': 0,
                    '❤️': 0
                },
                timestamp: Date.now()
            };

            try {
                const result = await save('issue', issueData);
                if (result.success) {
                    showMessage('Issue submitted successfully! It will be reviewed by our automated system.', 'success');
                    document.getElementById('idea').value = '';
                    loadIssues(); // Refresh the list
                } else {
                    showMessage('Failed to submit issue. Please try again.', 'error');
                }
            } catch (error) {
                showMessage('Error submitting issue: ' + error.message, 'error');
            }
        }

        async function loadIssues() {
            try {
                console.log('Loading issues for app:', window.APP_ID);
                const issues = await load('issue');
                console.log('Loaded issues:', issues);
                
                // Store all issues globally and apply content filtering
                allIssues = filterOffensiveContent(issues);
                
                // Load votes and update counts
                await loadVotes();
                updateVoteCounts();
                
                // Apply the current filter to display issues
                applyFilter(currentFilter);
                
            } catch (error) {
                console.error('Error loading issues:', error);
                document.getElementById('issueList').innerHTML = 
                    '<div class="error">Failed to load issues: ' + error.message + '</div>';
            }
        }

        // Content filtering function
        function filterOffensiveContent(issues) {
            return issues.filter(issue => {
                const data = issue.content_data || {};
                const text = (data.idea || '').toLowerCase();
                return !OFFENSIVE_WORDS.some(word => text.includes(word));
            });
        }
        
        // Filter issues by status
        function applyFilter(filter) {
            currentFilter = filter;
            
            // Update filter button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            // Filter issues based on status
            switch (filter) {
                case 'active':
                    filteredIssues = allIssues.filter(issue => {
                        const status = issue.content_data?.status || 'new';
                        return ['new', 'reformulated', 'fixing'].includes(status);
                    });
                    break;
                case 'resolved':
                    filteredIssues = allIssues.filter(issue => {
                        const status = issue.content_data?.status || 'new';
                        return ['fixed', 'pr-created'].includes(status);
                    });
                    break;
                case 'closed':
                    filteredIssues = allIssues.filter(issue => {
                        const status = issue.content_data?.status || 'new';
                        return ['closed', 'wontfix'].includes(status);
                    });
                    break;
                case 'new':
                    filteredIssues = allIssues.filter(issue => {
                        const status = issue.content_data?.status || 'new';
                        return status === 'new';
                    });
                    break;
                case 'fixing':
                    filteredIssues = allIssues.filter(issue => {
                        const status = issue.content_data?.status || 'new';
                        return status === 'fixing';
                    });
                    break;
                default:
                    filteredIssues = [...allIssues];
            }
            
            // Reset to page 1 and display
            currentPage = 1;
            displayFilteredIssues();
        }
        
        // Set filter function called by buttons
        function setFilter(filter) {
            applyFilter(filter);
        }
        
        // Pagination functions
        function changePage(direction) {
            const totalPages = Math.ceil(filteredIssues.length / issuesPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayFilteredIssues();
            }
        }
        
        // Generate issue number - use stored number or create sequential one
        function generateIssueNumber(issue) {
            // First check if we have a stored issue number
            if (issue.content_data && issue.content_data.issue_number) {
                return `#${issue.content_data.issue_number}`;
            }
            
            // For legacy issues without stored numbers - generate from UUID
            if (issue && issue.id) {
                const idStr = String(issue.id);
                const hash = idStr.replace(/-/g, '');
                const num = parseInt(hash.substr(0, 8), 16) % 9999 + 100;
                return `#${num}`;
            }
            
            return '#---';
        }
        
        // Get next issue number starting from 101
        async function getNextIssueNumber() {
            try {
                // Load all issues to find the highest number
                const allIssues = await load('issue');
                let maxNumber = 100; // Start from 100, so first issue is 101
                
                allIssues.forEach(issue => {
                    if (issue.content_data?.issue_number) {
                        maxNumber = Math.max(maxNumber, issue.content_data.issue_number);
                    }
                });
                
                return maxNumber + 1;
            } catch (error) {
                console.error('Error getting next issue number:', error);
                // Fallback to timestamp-based if error
                return 101 + (Date.now() % 1000);
            }
        }
        
        // Updated display function with pagination and issue numbers
        function displayFilteredIssues() {
            const container = document.getElementById('issueList');
            const paginationControls = document.getElementById('paginationControls');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            console.log('Displaying filtered issues:', filteredIssues?.length || 0);
            
            if (!filteredIssues || filteredIssues.length === 0) {
                container.innerHTML = '<div class="loading">No issues match the current filter.</div>';
                paginationControls.style.display = 'none';
                return;
            }

            // Sort by timestamp, newest first
            filteredIssues.sort((a, b) => (b.content_data?.timestamp || 0) - (a.content_data?.timestamp || 0));
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredIssues.length / issuesPerPage);
            const startIndex = (currentPage - 1) * issuesPerPage;
            const endIndex = Math.min(startIndex + issuesPerPage, filteredIssues.length);
            const currentIssues = filteredIssues.slice(startIndex, endIndex);
            
            // Update pagination controls
            paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredIssues.length} issues)`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            container.innerHTML = currentIssues.map(issue => {
                const data = issue.content_data || {};
                const status = data.status || 'new';
                const category = data.category || 'triage';
                const issueNumber = generateIssueNumber(issue);
                
                // Enhanced status progression for all flows
                let statusSteps;
                if (status === 'closed') {
                    // Check if it's a test/joke closure
                    if (data.closed_reason === 'test_joke') {
                        // Test/joke workflow - goes straight from Analyzed to Closed
                        statusSteps = [
                            { name: 'Submitted', state: 'completed' },
                            { name: 'Analyzed', state: 'completed' },
                            { name: 'Closed', state: 'completed', showIndicator: 'green' }
                        ];
                    } else {
                        // Normal closed workflow
                        statusSteps = [
                            { name: 'Submitted', state: 'completed' },
                            { name: 'Analyzed', state: 'completed' },
                            { name: 'Closed', state: 'completed', showIndicator: 'green' }
                        ];
                    }
                } else if (status === 'needs_info') {
                    // Needs more information workflow
                    statusSteps = [
                        { name: 'Submitted', state: 'completed' },
                        { name: 'Analyzed', state: 'completed' },
                        { name: 'Needs Info', state: 'current', showIndicator: 'yellow-pulse' }
                    ];
                } else if (status === 'wontfix') {
                    // Won't fix workflow
                    statusSteps = [
                        { name: 'Submitted', state: 'completed' },
                        { name: 'Analyzed', state: 'completed' },
                        { name: "Won't Fix", state: 'completed', showIndicator: 'red' }
                    ];
                } else if (status.includes('failed')) {
                    // Failed workflow - only show indicator on CURRENT status
                    statusSteps = [
                        { name: 'Submitted', state: 'completed' },
                        { name: 'Analyzed', state: data.reformulated ? 'completed' : 'current', 
                          showIndicator: data.reformulated ? null : 'yellow-pulse',
                          displayName: data.reformulated ? 'Analyzed' : 'Analyzing' },
                        { name: 'Failed', state: 'blocked', showIndicator: 'red' },
                        { name: 'Fixed', state: 'pending' },
                        { name: 'PR Created', state: 'pending' }
                    ];
                } else {
                    // Normal workflow - only show indicator on CURRENT active step
                    const isNew = status === 'new';  // Just submitted, not yet processing
                    const isAnalyzing = status === 'analyzing';  // Actually being processed
                    const isAnalyzed = status === 'reformulated' || status === 'fixing' || status === 'fixed' || status === 'pr-creating' || status === 'pr-created';
                    const isFixing = status === 'fixing';
                    const isFixed = status === 'fixed' || status === 'pr-creating' || status === 'pr-created';
                    const isPRCreating = status === 'pr-creating';
                    const isPRCreated = status === 'pr-created';
                    
                    statusSteps = [
                        { name: 'Submitted', state: 'completed', showIndicator: isNew ? 'green' : null },
                        { 
                            name: isAnalyzing ? 'Analyzing' : (isAnalyzed ? 'Analyzed' : 'Analysis Pending'),
                            state: isAnalyzing ? 'current' : (isAnalyzed ? 'completed' : 'pending'),
                            showIndicator: isAnalyzing ? 'yellow-pulse' : null
                        },
                        { 
                            name: isFixing ? 'Fixing' : 'Fixed',
                            state: isFixing ? 'current' : (isFixed ? 'completed' : 'pending'),
                            showIndicator: isFixing ? 'yellow-pulse' : null
                        },
                        { 
                            name: isPRCreating ? 'Creating PR' : (isPRCreated ? 'PR Created' : 'PR Pending'),
                            state: isPRCreating ? 'current' : (isPRCreated ? 'completed' : 'pending'),
                            showIndicator: isPRCreating ? 'yellow-pulse' : (isPRCreated ? 'green' : null)
                        }
                    ];
                }
                
                const statusBadgeClass = status === 'pr-created' ? 'badge-pr-created' : 
                                        status === 'fixed' ? 'badge-fixed' :
                                        status === 'fixing' ? 'badge-fixing' :
                                        status === 'reformulated' ? 'badge-reformulated' :
                                        status === 'closed' ? 'badge-closed' :
                                        status === 'needs_info' ? 'badge-needs-info' :
                                        status === 'wontfix' ? 'badge-failed' :
                                        status.includes('failed') ? 'badge-failed' :
                                        'badge-new';
                
                return `
                    <div class="issue-item">
                        <div class="issue-number">${issueNumber}</div>
                        <div class="issue-header">
                            <div class="issue-title">${escapeHtml(data.idea || 'No description')}</div>
                            <div class="issue-age" style="color: var(--gray-warm); font-weight: 600; font-size: 0.9rem; margin-top: 5px;">
                                ${status === 'closed' || status === 'wontfix' ? 'Closed' : 'Open'} for ${formatDate(data.timestamp)}
                            </div>
                        </div>
                        <div class="issue-meta">
                            <span class="badge badge-${category}">${category}</span>
                            <span class="badge ${statusBadgeClass}">${status.replace('-', ' ')}</span>
                            <span>by ${escapeHtml(data.author || 'Anonymous')}</span>
                            <span>${formatDate(data.timestamp)}</span>
                        </div>
                        
                        <div class="status-timeline">
                            ${statusSteps.map((step) => {
                                const className = step.state || 'pending';
                                const circleClass = step.state || 'pending';
                                return `<div class="status-step ${className}">
                                    <div class="status-circle ${circleClass}"></div>
                                    <span>${step.displayName || step.name}</span>
                                </div>`;
                            }).join('')}
                        </div>
                        
                        ${data.reformulated ? `
                            <div style="margin-top: 15px; padding: 15px; background: var(--purple-shadow); border-radius: 15px; border: 2px solid var(--purple-accent);">
                                <strong style="color: var(--charcoal);">🤖 AI Analysis:</strong> <span style="color: var(--charcoal);">${escapeHtml(data.reformulated)}</span>
                            </div>
                        ` : ''}
                        
                        ${data.confidence || data.priority ? `
                            <div class="confidence-priority">
                                ${data.confidence ? `<strong>Confidence: ${data.confidence}</strong>` : ''}
                                ${data.priority ? `<strong>Priority: ${data.priority}</strong>` : ''}
                            </div>
                        ` : ''}
                        
                        ${data.ai_analysis ? `
                            <div class="cass-comment">
                                <strong>🎸 Ash.tag:</strong> ${escapeHtml(data.ai_analysis)}
                            </div>
                        ` : ''}
                        
                        ${data.ash_comment ? `
                            <div class="cass-comment">
                                <strong>💭 Ash.tag says:</strong> ${escapeHtml(data.ash_comment)}
                            </div>
                        ` : ''}
                        
                        ${data.cass_comment ? `
                            <div class="cass-comment">
                                <strong>💬 Ash.tag:</strong> ${escapeHtml(data.cass_comment)}
                            </div>
                        ` : ''}
                        
                        ${data.cassink_comment ? `
                            <div class="cass-comment">
                                <strong>💬 Ash.tag:</strong> ${escapeHtml(data.cassink_comment)}
                            </div>
                        ` : ''}
                        
                        ${data.agent_comment ? `
                            <div class="cass-comment">
                                <strong>💬 Ash.tag:</strong> ${escapeHtml(data.agent_comment)}
                            </div>
                        ` : ''}
                        
                        ${data.analysis_comment ? `
                            <div class="cass-comment">
                                <strong>💬 Ash.tag:</strong> ${escapeHtml(data.analysis_comment)}
                            </div>
                        ` : ''}
                        
                        ${data.pr_url ? `
                            <div style="margin-top: 15px; padding: 15px; background: var(--green-mint); border-radius: 15px; border: 3px solid var(--green-sage); box-shadow: 2px 2px 0px var(--green-sage);">
                                <strong style="color: var(--charcoal);">🎉 Pull Request Created!</strong><br>
                                <a href="${data.pr_url}" target="_blank" style="color: var(--charcoal); font-weight: 700; text-decoration: underline;">
                                    View Pull Request #${data.pr_url.split('/').pop()} →
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="reactions" data-issue-id="${issue.id}">
                            <button class="reaction-btn upvote" onclick="toggleVote('${issue.id}', 'upvote')">
                                ▲ <span class="vote-count">${data.upvotes || 0}</span>
                            </button>
                            <button class="reaction-btn downvote" onclick="toggleVote('${issue.id}', 'downvote')">
                                ▼ <span class="vote-count">${data.downvotes || 0}</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Legacy function for backward compatibility
        function displayIssues(issues) {
            allIssues = filterOffensiveContent(issues);
            applyFilter(currentFilter);
        }

        // Store all votes globally
        let allVotes = [];
        
        // Toggle vote (upvote or downvote)
        async function toggleVote(issueId, voteType) {
            try {
                const participantId = localStorage.getItem('participant_id') || 
                                    'anon_' + Math.random().toString(36).substr(2, 9);
                
                // Store participant ID if new
                if (!localStorage.getItem('participant_id')) {
                    localStorage.setItem('participant_id', participantId);
                }
                
                // Check if user already voted on this issue
                const existingVote = allVotes.find(v => 
                    v.content_data?.issue_id === issueId && 
                    v.content_data?.voter === participantId
                );
                
                let newVoteType;
                if (existingVote && existingVote.content_data?.vote_type === voteType) {
                    // Same vote - remove it (toggle off)
                    newVoteType = 'none';
                } else {
                    // New vote or different vote
                    newVoteType = voteType;
                }
                
                // Save the vote
                await save('vote', {
                    issue_id: issueId,
                    voter: participantId,
                    vote_type: newVoteType,
                    timestamp: Date.now()
                });
                
                // Reload votes and update display
                await loadVotes();
                updateVoteCounts();
                
                showMessage(
                    newVoteType === 'none' ? 'Vote removed' : `Issue ${voteType}d!`, 
                    'success'
                );
                
            } catch (error) {
                showMessage('Failed to save vote: ' + error.message, 'error');
            }
        }
        
        // Load all votes from backend
        async function loadVotes() {
            try {
                allVotes = await load('vote');
                console.log('Loaded votes:', allVotes.length);
            } catch (error) {
                console.error('Error loading votes:', error);
                allVotes = [];
            }
        }
        
        // Update vote counts for all issues
        function updateVoteCounts() {
            // Get latest vote per user per issue
            const votesByUserIssue = {};
            allVotes.forEach(vote => {
                const data = vote.content_data || {};
                const key = `${data.voter}-${data.issue_id}`;
                
                // Keep only the latest vote from each user for each issue
                if (!votesByUserIssue[key] || 
                    data.timestamp > votesByUserIssue[key].timestamp) {
                    votesByUserIssue[key] = data;
                }
            });
            
            // Count votes per issue
            const voteCounts = {};
            Object.values(votesByUserIssue).forEach(vote => {
                if (vote.vote_type && vote.vote_type !== 'none') {
                    if (!voteCounts[vote.issue_id]) {
                        voteCounts[vote.issue_id] = { upvotes: 0, downvotes: 0 };
                    }
                    if (vote.vote_type === 'upvote') {
                        voteCounts[vote.issue_id].upvotes++;
                    } else if (vote.vote_type === 'downvote') {
                        voteCounts[vote.issue_id].downvotes++;
                    }
                }
            });
            
            // Update the allIssues array with vote counts
            allIssues.forEach(issue => {
                const counts = voteCounts[issue.id] || { upvotes: 0, downvotes: 0 };
                issue.content_data = issue.content_data || {};
                issue.content_data.upvotes = counts.upvotes;
                issue.content_data.downvotes = counts.downvotes;
            });
            
            // Refresh display
            displayFilteredIssues();
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.className = '';
                messageDiv.textContent = '';
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // Handle future dates (shouldn't happen but just in case)
            if (diff < 0) return 'just now';
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);
            
            // Less than 1 minute
            if (minutes < 1) return 'just now';
            
            // Less than 1 hour
            if (minutes < 60) {
                return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
            }
            
            // Same day (less than 24 hours but also check if it's actually today)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const issueDate = new Date(date);
            issueDate.setHours(0, 0, 0, 0);
            
            if (issueDate.getTime() === today.getTime()) {
                return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            }
            
            // Yesterday
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (issueDate.getTime() === yesterday.getTime()) {
                return 'yesterday';
            }
            
            // Less than 1 week
            if (days < 7) {
                return days === 1 ? '1 day ago' : `${days} days ago`;
            }
            
            // Less than 1 month (4 weeks)
            if (weeks < 4) {
                return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
            }
            
            // Less than 1 year
            if (months < 12) {
                return months === 1 ? '1 month ago' : `${months} months ago`;
            }
            
            // 1 year or more
            return years === 1 ? '1 year ago' : `${years} years ago`;
        }

        // Load issues on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, fetching issues...');
            loadIssues();
            
            // Refresh issues every 30 seconds
            setInterval(loadIssues, 30000);
        });
    </script>
</body>
</html>
