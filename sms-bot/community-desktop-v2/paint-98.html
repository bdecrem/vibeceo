<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paint 98</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Tahoma', 'MS Sans Serif', sans-serif;
            background: #c0c0c0;
            height: 100vh;
            overflow: hidden;
            font-size: 11px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            background: #c0c0c0;
            border-bottom: 2px inset #c0c0c0;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            min-height: 60px;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 6px;
            border-right: 1px solid #808080;
            padding-right: 12px;
        }

        .tool-group:last-child {
            border-right: none;
        }

        .tool-button {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Tahoma', sans-serif;
            min-width: 60px;
            transition: all 0.1s;
        }

        .tool-button:hover {
            background: #d0d0d0;
        }

        .tool-button:active, .tool-button.active {
            border: 2px inset #c0c0c0;
            background: #a0a0a0;
        }

        .kidpix-colors {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            max-width: 400px;
        }

        .color-btn {
            width: 28px;
            height: 28px;
            border: 3px outset #c0c0c0;
            cursor: pointer;
            position: relative;
        }

        .color-btn.active {
            border: 3px inset #c0c0c0;
        }

        .gradient-btn {
            background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0000ff, #800080);
        }

        .custom-color-btn {
            position: relative;
            background: #888888;
        }

        .custom-color-btn::before {
            content: 'üé®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .color-palette-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .color-palette-content {
            background: #c0c0c0;
            border: 3px outset #c0c0c0;
            padding: 16px;
            max-width: 480px;
            text-align: center;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(12, 30px);
            gap: 3px;
            justify-content: center;
            margin: 16px 0;
        }

        .palette-color {
            width: 30px;
            height: 30px;
            border: 2px outset #c0c0c0;
            cursor: pointer;
            position: relative;
        }

        .palette-color:hover {
            border: 2px inset #c0c0c0;
        }

        .hex-input-section {
            margin: 16px 0;
            padding: 12px;
            border: 1px inset #c0c0c0;
            background: #e0e0e0;
        }

        .hex-input {
            padding: 4px 8px;
            border: 1px inset #c0c0c0;
            font-family: monospace;
            font-size: 12px;
            width: 80px;
            text-align: center;
        }

        .canvas-area {
            flex: 1;
            display: flex;
            padding: 8px;
            gap: 8px;
        }

        .canvas-container {
            border: 3px inset #c0c0c0;
            background: white;
            padding: 4px;
            flex: 1;
        }

        #paintCanvas {
            display: block;
            background: white;
            cursor: crosshair;
            width: 100%;
            height: 100%;
        }

        .gallery-panel {
            width: 200px;
            border: 2px inset #c0c0c0;
            background: #c0c0c0;
            display: flex;
            flex-direction: column;
        }

        .gallery-header {
            background: #008080;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #004040;
        }

        .gallery-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .gallery-item {
            background: white;
            border: 1px solid #808080;
            margin-bottom: 8px;
            padding: 4px;
            cursor: pointer;
            text-align: center;
        }

        .gallery-item:hover {
            background: #e0e0e0;
        }

        .gallery-thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ccc;
        }

        .gallery-meta {
            font-size: 9px;
            color: #404040;
            margin-top: 4px;
        }

        .delete-button {
            background: #ff4444;
            color: white;
            border: 1px outset #c0c0c0;
            padding: 2px 6px;
            font-size: 8px;
            cursor: pointer;
            margin-top: 4px;
            border-radius: 2px;
            font-family: 'Tahoma', sans-serif;
        }

        .delete-button:hover {
            background: #ff6666;
        }

        .delete-button:active {
            border: 1px inset #c0c0c0;
            background: #cc3333;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .size-slider {
            width: 80px;
        }

        .status-bar {
            background: #c0c0c0;
            border-top: 1px inset #c0c0c0;
            padding: 4px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auth-status {
            color: #000080;
            font-weight: bold;
        }

        .kidpix-tool {
            font-size: 16px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #c0c0c0;
            border: 3px outset #c0c0c0;
            padding: 16px;
            min-width: 300px;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="toolbar">
            <div class="tool-group">
                <button class="tool-button kidpix-tool active" id="brushTool" onclick="selectTool('brush')" title="Paint Brush">üñåÔ∏è</button>
                <button class="tool-button kidpix-tool" id="sprayTool" onclick="selectTool('spray')" title="Spray Paint">üí®</button>
                <button class="tool-button kidpix-tool" id="stampTool" onclick="selectTool('stamp')" title="Fun Stamps">‚≠ê</button>
                <button class="tool-button kidpix-tool" id="eraserTool" onclick="selectTool('eraser')" title="Eraser">üßΩ</button>
            </div>

            <div class="tool-group">
                <div class="size-control">
                    <span>Size:</span>
                    <input type="range" class="size-slider" id="toolSize" min="1" max="40" value="8" oninput="updateToolSize()">
                    <span id="sizeDisplay">8</span>
                </div>
            </div>

            <div class="tool-group kidpix-colors">
                <div class="color-btn active" style="background: #ff0000" onclick="selectColor('#ff0000')" title="Red"></div>
                <div class="color-btn" style="background: #00ff00" onclick="selectColor('#00ff00')" title="Green"></div>
                <div class="color-btn" style="background: #0000ff" onclick="selectColor('#0000ff')" title="Blue"></div>
                <div class="color-btn" style="background: #ffff00" onclick="selectColor('#ffff00')" title="Yellow"></div>
                <div class="color-btn" style="background: #ff00ff" onclick="selectColor('#ff00ff')" title="Purple"></div>
                <div class="color-btn" style="background: #00ffff" onclick="selectColor('#00ffff')" title="Cyan"></div>
                <div class="color-btn" style="background: #ff8000" onclick="selectColor('#ff8000')" title="Orange"></div>
                <div class="color-btn" style="background: #800080" onclick="selectColor('#800080')" title="Dark Purple"></div>
                <div class="color-btn" style="background: #000000" onclick="selectColor('#000000')" title="Black"></div>
                <div class="color-btn" style="background: #ffffff; border-color: #808080;" onclick="selectColor('#ffffff')" title="White"></div>
                <div class="color-btn gradient-btn" onclick="selectGradient()" title="Rainbow Gradient"></div>
                <div class="color-btn custom-color-btn" onclick="showColorPalette()" title="More Colors"></div>
            </div>

            <div class="tool-group">
                <button class="tool-button" onclick="clearCanvas()">New</button>
                <button class="tool-button" onclick="saveArtwork()">Save</button>
            </div>
        </div>

        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="paintCanvas" width="600" height="400"></canvas>
            </div>
            
            <div class="gallery-panel">
                <div class="gallery-header">Art Gallery</div>
                <div class="gallery-content" id="galleryContent">
                    <div style="text-align: center; color: #808080; padding: 20px;">
                        No artwork saved yet!<br>
                        Create something beautiful and save it!
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span class="auth-status" id="authStatus">Not logged in</span>
            <span id="toolStatus">Paint Brush selected</span>
        </div>
    </div>

    <!-- Save Modal -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <h3>Save Your Artwork</h3>
            <p>Give your masterpiece a name:</p>
            <input type="text" id="artworkName" placeholder="My Amazing Art" style="width: 200px; padding: 4px; margin: 8px;">
            <div class="modal-buttons">
                <button class="tool-button" onclick="confirmSave()">Save</button>
                <button class="tool-button" onclick="closeSaveModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Color Palette Modal -->
    <div class="color-palette-modal" id="colorPaletteModal">
        <div class="color-palette-content">
            <h3>Choose a Color</h3>
            <div class="color-grid">
                <!-- Red Family -->
                <div class="palette-color" style="background: #ff0000" onclick="selectPaletteColor('#ff0000')" title="Red"></div>
                <div class="palette-color" style="background: #ff3333" onclick="selectPaletteColor('#ff3333')" title="Light Red"></div>
                <div class="palette-color" style="background: #cc0000" onclick="selectPaletteColor('#cc0000')" title="Dark Red"></div>
                <div class="palette-color" style="background: #ff6666" onclick="selectPaletteColor('#ff6666')" title="Pink Red"></div>
                
                <!-- Orange Family -->
                <div class="palette-color" style="background: #ff8000" onclick="selectPaletteColor('#ff8000')" title="Orange"></div>
                <div class="palette-color" style="background: #ffaa33" onclick="selectPaletteColor('#ffaa33')" title="Light Orange"></div>
                <div class="palette-color" style="background: #cc6600" onclick="selectPaletteColor('#cc6600')" title="Dark Orange"></div>
                <div class="palette-color" style="background: #ff9966" onclick="selectPaletteColor('#ff9966')" title="Peach"></div>
                
                <!-- Yellow Family -->
                <div class="palette-color" style="background: #ffff00" onclick="selectPaletteColor('#ffff00')" title="Yellow"></div>
                <div class="palette-color" style="background: #ffff66" onclick="selectPaletteColor('#ffff66')" title="Light Yellow"></div>
                <div class="palette-color" style="background: #cccc00" onclick="selectPaletteColor('#cccc00')" title="Dark Yellow"></div>
                <div class="palette-color" style="background: #ffffaa" onclick="selectPaletteColor('#ffffaa')" title="Cream"></div>
                
                <!-- Green Family -->
                <div class="palette-color" style="background: #00ff00" onclick="selectPaletteColor('#00ff00')" title="Lime Green"></div>
                <div class="palette-color" style="background: #33ff33" onclick="selectPaletteColor('#33ff33')" title="Light Green"></div>
                <div class="palette-color" style="background: #00cc00" onclick="selectPaletteColor('#00cc00')" title="Green"></div>
                <div class="palette-color" style="background: #008000" onclick="selectPaletteColor('#008000')" title="Forest Green"></div>
                
                <!-- Blue Family -->
                <div class="palette-color" style="background: #0000ff" onclick="selectPaletteColor('#0000ff')" title="Blue"></div>
                <div class="palette-color" style="background: #3333ff" onclick="selectPaletteColor('#3333ff')" title="Light Blue"></div>
                <div class="palette-color" style="background: #0000cc" onclick="selectPaletteColor('#0000cc')" title="Dark Blue"></div>
                <div class="palette-color" style="background: #000080" onclick="selectPaletteColor('#000080')" title="Navy Blue"></div>
                
                <!-- Purple Family -->
                <div class="palette-color" style="background: #800080" onclick="selectPaletteColor('#800080')" title="Purple"></div>
                <div class="palette-color" style="background: #aa33aa" onclick="selectPaletteColor('#aa33aa')" title="Light Purple"></div>
                <div class="palette-color" style="background: #660066" onclick="selectPaletteColor('#660066')" title="Dark Purple"></div>
                <div class="palette-color" style="background: #ff00ff" onclick="selectPaletteColor('#ff00ff')" title="Magenta"></div>
                
                <!-- Cyan Family -->
                <div class="palette-color" style="background: #00ffff" onclick="selectPaletteColor('#00ffff')" title="Cyan"></div>
                <div class="palette-color" style="background: #66ffff" onclick="selectPaletteColor('#66ffff')" title="Light Cyan"></div>
                <div class="palette-color" style="background: #00cccc" onclick="selectPaletteColor('#00cccc')" title="Teal"></div>
                <div class="palette-color" style="background: #008080" onclick="selectPaletteColor('#008080')" title="Dark Teal"></div>
                
                <!-- Brown Family -->
                <div class="palette-color" style="background: #8B4513" onclick="selectPaletteColor('#8B4513')" title="Saddle Brown"></div>
                <div class="palette-color" style="background: #A0522D" onclick="selectPaletteColor('#A0522D')" title="Sienna"></div>
                <div class="palette-color" style="background: #D2691E" onclick="selectPaletteColor('#D2691E')" title="Chocolate"></div>
                <div class="palette-color" style="background: #F4A460" onclick="selectPaletteColor('#F4A460')" title="Sandy Brown"></div>
                
                <!-- Gray Family -->
                <div class="palette-color" style="background: #000000" onclick="selectPaletteColor('#000000')" title="Black"></div>
                <div class="palette-color" style="background: #333333" onclick="selectPaletteColor('#333333')" title="Dark Gray"></div>
                <div class="palette-color" style="background: #666666" onclick="selectPaletteColor('#666666')" title="Gray"></div>
                <div class="palette-color" style="background: #999999" onclick="selectPaletteColor('#999999')" title="Light Gray"></div>
                
                <!-- More Grays -->
                <div class="palette-color" style="background: #cccccc" onclick="selectPaletteColor('#cccccc')" title="Silver"></div>
                <div class="palette-color" style="background: #ffffff; border: 2px solid #808080;" onclick="selectPaletteColor('#ffffff')" title="White"></div>
                <div class="palette-color" style="background: #ffc0cb" onclick="selectPaletteColor('#ffc0cb')" title="Pink"></div>
                <div class="palette-color" style="background: #ffd700" onclick="selectPaletteColor('#ffd700')" title="Gold"></div>
            </div>
            
            <div class="hex-input-section">
                <strong>Custom Hex Color:</strong><br>
                <input type="text" id="hexColorInput" class="hex-input" placeholder="#FF0000" maxlength="7">
                <button class="tool-button" onclick="selectHexColor()">Use Color</button>
            </div>
            
            <div class="modal-buttons">
                <button class="tool-button" onclick="closeColorPalette()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ZAD Configuration
        window.APP_ID = 'paint-98-app';

        // Authentication state
        let currentUser = null;

        // Canvas and drawing state
        const canvas = document.getElementById('paintCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#ff0000';
        let currentSize = 8;
        let lastX = 0;
        let lastY = 0;
        let isGradientMode = false;
        let gradientColors = ['#ff0000', '#ff8000', '#ffff00', '#00ff00', '#0000ff', '#800080'];

        // Stamp selection
        const stamps = ['‚≠ê', 'üåü', 'üí´', '‚ú®', 'üåà', 'üé®', 'üé™', 'üé≠', 'üé™', 'üå∏', 'üå∫', 'ü¶ã', 'üêù', 'üêû'];
        let currentStamp = 0;

        // Initialize canvas
        function initCanvas() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = currentSize;
            ctx.strokeStyle = currentColor;
            
            // Adjust canvas size to container
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 8;
            canvas.height = container.clientHeight - 8;
        }

        // ZAD Helper Functions
        async function save(dataType, data) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        participant_id: currentUser ? currentUser.handle : 'anonymous',
                        data_type: dataType,
                        action_type: dataType,
                        content_data: data
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Save error:', error);
                throw error;
            }
        }

        async function loadAll(dataType) {
            try {
                const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&action_type=${dataType}`);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }

        async function deleteItem(itemId) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        participant_id: currentUser ? currentUser.handle : 'anonymous',
                        data_type: 'delete_artwork',
                        action_type: 'delete_artwork',
                        content_data: {
                            delete_item_id: itemId,
                            deleted_by: currentUser.handle,
                            deleted_at: new Date().toISOString()
                        }
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Delete error:', error);
                throw error;
            }
        }

        // Drawing Functions
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            if (currentTool === 'stamp') {
                if (isGradientMode) {
                    const progress = (lastX / canvas.width + lastY / canvas.height) / 2;
                    const gradientColor = getGradientColor(progress);
                    ctx.fillStyle = gradientColor;
                } else {
                    ctx.fillStyle = currentColor;
                }
                placeStamp(lastX, lastY);
                return;
            }
            
            if (currentTool === 'brush' || currentTool === 'spray') {
                ctx.globalCompositeOperation = 'source-over';
                if (!isGradientMode) {
                    ctx.strokeStyle = currentColor;
                    ctx.fillStyle = currentColor;
                }
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
            }
            
            ctx.lineWidth = currentSize;
            
            if (currentTool === 'brush') {
                if (isGradientMode) {
                    const progress = (lastX / canvas.width + lastY / canvas.height) / 2;
                    const gradientColor = getGradientColor(progress);
                    ctx.strokeStyle = gradientColor;
                }
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            if (currentTool === 'brush' || currentTool === 'eraser') {
                if (isGradientMode && currentTool === 'brush') {
                    // Calculate gradient color based on position
                    const progress = (currentX / canvas.width + currentY / canvas.height) / 2;
                    const gradientColor = getGradientColor(progress);
                    ctx.strokeStyle = gradientColor;
                    ctx.fillStyle = gradientColor;
                }
                
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);
            } else if (currentTool === 'spray') {
                // Spray paint effect
                for (let i = 0; i < 20; i++) {
                    const offsetX = (Math.random() - 0.5) * currentSize * 2;
                    const offsetY = (Math.random() - 0.5) * currentSize * 2;
                    
                    if (isGradientMode) {
                        const progress = ((currentX + offsetX) / canvas.width + (currentY + offsetY) / canvas.height) / 2;
                        const gradientColor = getGradientColor(progress);
                        ctx.fillStyle = gradientColor;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(currentX + offsetX, currentY + offsetY, 1, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function placeStamp(x, y) {
            const stamp = stamps[currentStamp];
            const fontSize = currentSize * 3;
            ctx.save();
            ctx.font = `${fontSize}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            if (isGradientMode) {
                const progress = (x / canvas.width + y / canvas.height) / 2;
                const gradientColor = getGradientColor(progress);
                ctx.fillStyle = gradientColor;
            } else {
                ctx.fillStyle = currentColor;
            }
            
            ctx.fillText(stamp, x, y);
            ctx.restore();
            
            // Cycle to next stamp
            currentStamp = (currentStamp + 1) % stamps.length;
            updateToolStatus();
        }

        // Tool Functions
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
            
            switch(tool) {
                case 'brush':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'spray':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'stamp':
                    canvas.style.cursor = 'pointer';
                    break;
                case 'eraser':
                    canvas.style.cursor = 'grab';
                    break;
            }
            updateToolStatus();
        }

        function selectColor(color) {
            currentColor = color;
            isGradientMode = false;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentTool === 'brush' || currentTool === 'spray') {
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor;
            }
        }

        function selectGradient() {
            isGradientMode = true;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showColorPalette() {
            document.getElementById('colorPaletteModal').style.display = 'flex';
        }

        function closeColorPalette() {
            document.getElementById('colorPaletteModal').style.display = 'none';
        }

        function selectPaletteColor(color) {
            selectColorProgrammatically(color);
            closeColorPalette();
        }

        function selectColorProgrammatically(color) {
            currentColor = color;
            isGradientMode = false;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            
            if (currentTool === 'brush' || currentTool === 'spray') {
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor;
            }
        }

        function selectHexColor() {
            const hexInput = document.getElementById('hexColorInput');
            const hexValue = hexInput.value.trim();
            
            if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
                selectColorProgrammatically(hexValue);
                closeColorPalette();
            } else {
                alert('Please enter a valid hex color (e.g., #FF0000)');
            }
        }

        function getGradientColor(progress) {
            // Create rainbow gradient based on progress (0-1)
            const colors = gradientColors;
            const scaledProgress = progress * (colors.length - 1);
            const index = Math.floor(scaledProgress);
            const remainder = scaledProgress - index;
            
            if (index >= colors.length - 1) {
                return colors[colors.length - 1];
            }
            
            // Interpolate between two colors
            const color1 = hexToRgb(colors[index]);
            const color2 = hexToRgb(colors[index + 1]);
            
            const r = Math.round(color1.r + (color2.r - color1.r) * remainder);
            const g = Math.round(color1.g + (color2.g - color1.g) * remainder);
            const b = Math.round(color1.b + (color2.b - color1.b) * remainder);
            
            return `rgb(${r},${g},${b})`;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function updateToolSize() {
            currentSize = parseInt(document.getElementById('toolSize').value);
            document.getElementById('sizeDisplay').textContent = currentSize;
            ctx.lineWidth = currentSize;
        }

        function updateToolStatus() {
            const status = document.getElementById('toolStatus');
            switch(currentTool) {
                case 'brush':
                    status.textContent = 'Paint Brush selected';
                    break;
                case 'spray':
                    status.textContent = 'Spray Paint selected';
                    break;
                case 'stamp':
                    status.textContent = `Fun Stamps selected - Next: ${stamps[currentStamp]}`;
                    break;
                case 'eraser':
                    status.textContent = 'Eraser selected';
                    break;
            }
        }

        function clearCanvas() {
            if (confirm('Start a new drawing? This will erase your current artwork.')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Save/Load Functions
        function saveArtwork() {
            if (!currentUser) {
                alert('Please login first to save your artwork!');
                return;
            }
            document.getElementById('saveModal').style.display = 'flex';
            document.getElementById('artworkName').focus();
        }

        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        async function confirmSave() {
            const name = document.getElementById('artworkName').value.trim() || 'Untitled Artwork';
            
            try {
                const imageData = canvas.toDataURL('image/png');
                const artworkData = {
                    name: name,
                    imageData: imageData,
                    timestamp: new Date().toISOString(),
                    author: currentUser.handle,
                    tool: currentTool,
                    color: currentColor
                };
                
                await save('artwork', artworkData);
                closeSaveModal();
                document.getElementById('artworkName').value = '';
                loadGallery(); // Refresh gallery
                
                // Show success feedback
                const status = document.getElementById('toolStatus');
                const original = status.textContent;
                status.textContent = `"${name}" saved to gallery!`;
                status.style.color = '#008000';
                setTimeout(() => {
                    status.textContent = original;
                    status.style.color = '';
                }, 3000);
                
            } catch (error) {
                console.error('Save failed:', error);
                alert('Failed to save artwork. Please try again.');
            }
        }

        async function loadGallery() {
            try {
                const artworks = await loadAll('artwork');
                const deletedItems = await loadAll('delete_artwork');
                const gallery = document.getElementById('galleryContent');
                
                // Filter out deleted items
                const deletedIds = deletedItems.map(item => item.content_data.delete_item_id);
                const visibleArtworks = artworks.filter(artwork => 
                    !deletedIds.includes(artwork.id)
                );
                
                if (visibleArtworks.length === 0) {
                    gallery.innerHTML = `
                        <div style="text-align: center; color: #808080; padding: 20px;">
                            No artwork saved yet!<br>
                            Create something beautiful and save it!
                        </div>
                    `;
                    return;
                }
                
                // Sort by timestamp, newest first
                visibleArtworks.sort((a, b) => new Date(b.content_data.timestamp) - new Date(a.content_data.timestamp));
                
                // Check if current user is "bart"
                const canDelete = currentUser && currentUser.handle === 'bart';
                
                gallery.innerHTML = visibleArtworks.map(artwork => {
                    const data = artwork.content_data;
                    const date = new Date(data.timestamp).toLocaleDateString();
                    const deleteButton = canDelete ? 
                        `<button class="delete-button" onclick="event.stopPropagation(); confirmDeleteArtwork('${artwork.id}', '${data.name}')">Delete</button>` : '';
                    
                    return `
                        <div class="gallery-item" onclick="viewArtwork('${data.imageData}', '${data.name}')" 
                             title="Click to view full size">
                            <img src="${data.imageData}" alt="${data.name}" class="gallery-thumb">
                            <div class="gallery-meta">
                                <strong>${data.name}</strong><br>
                                by ${data.author}<br>
                                ${date}
                                ${deleteButton}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Gallery load error:', error);
            }
        }

        function viewArtwork(imageData, name) {
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(`
                <html>
                    <head><title>${name} - Paint 98 Gallery</title></head>
                    <body style="margin:0; background:#f0f0f0; display:flex; align-items:center; justify-content:center; min-height:100vh;">
                        <div style="text-align:center; font-family:Tahoma,sans-serif;">
                            <h2 style="margin-bottom:10px;">${name}</h2>
                            <img src="${imageData}" style="max-width:90vw; max-height:80vh; border:2px solid #ccc; background:white;">
                            <p style="margin-top:10px; color:#666;">From the Paint 98 Gallery</p>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        async function confirmDeleteArtwork(artworkId, artworkName) {
            // Double-check user permissions
            if (!currentUser || currentUser.handle !== 'bart') {
                alert('Only user "bart" can delete images from the gallery.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${artworkName}" from the gallery?\n\nThis action cannot be undone.`)) {
                try {
                    await deleteItem(artworkId);
                    
                    // Show success feedback
                    const status = document.getElementById('toolStatus');
                    const original = status.textContent;
                    status.textContent = `"${artworkName}" deleted from gallery`;
                    status.style.color = '#cc3333';
                    setTimeout(() => {
                        status.textContent = original;
                        status.style.color = '';
                    }, 3000);
                    
                    // Refresh gallery
                    loadGallery();
                    
                } catch (error) {
                    console.error('Delete failed:', error);
                    alert('Failed to delete artwork. Please try again.');
                }
            }
        }

        // Authentication Integration
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            if (currentUser) {
                authStatus.textContent = `Logged in as ${currentUser.handle}`;
                authStatus.className = 'auth-status';
            } else {
                authStatus.textContent = 'Not logged in - Login to save artwork';
                authStatus.className = 'auth-status';
            }
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TOYBOX_AUTH') {
                console.log('Received auth update:', event.data.user);
                currentUser = event.data.user;
                updateAuthStatus();
                loadGallery(); // Refresh gallery when auth changes
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            initCanvas();
            
            // Try to load auth from localStorage as fallback
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateAuthStatus();
                } catch (e) {
                    console.error('Failed to parse saved user');
                }
            }
            
            // Request fresh auth state from ToyBox OS
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'REQUEST_AUTH' }, '*');
            }
            
            loadGallery();
            updateToolStatus();
        });

        // Canvas Event Listeners
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch support
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            // Store current drawing
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Resize canvas
            initCanvas();
            
            // Restore drawing
            ctx.putImageData(imageData, 0, 0);
        });

        // Enter key in save modal
        document.getElementById('artworkName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmSave();
            }
        });
    </script>
</body>
</html>