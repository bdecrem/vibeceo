<!DOCTYPE html>
<html>
<head>
    <title>Detective Mystery</title>
    <style>
        body {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            color: #ecf0f1;
            min-height: 100vh;
        }

        .mystery-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(44, 62, 80, 0.9);
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
        }

        .title {
            text-align: center;
            font-size: 2.5em;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }

        .case-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .case-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .case-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .case-btn.active {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }

        .case-info {
            background: rgba(52, 73, 94, 0.8);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
        }

        .case-title {
            font-size: 1.5em;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .clues-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3em;
            color: #3498db;
            margin-bottom: 15px;
            text-decoration: underline;
        }

        .clue {
            background: rgba(26, 188, 156, 0.2);
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #1abc9c;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clue:hover {
            background: rgba(26, 188, 156, 0.3);
            transform: translateX(5px);
        }

        .clue.discovered {
            background: rgba(46, 204, 113, 0.3);
            border-left-color: #2ecc71;
        }

        .evidence-board {
            background: rgba(155, 89, 182, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 100px;
            border: 2px dashed #9b59b6;
        }

        .evidence-item {
            background: #9b59b6;
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 15px;
            display: inline-block;
            font-size: 0.9em;
        }

        .solution-section {
            margin-top: 30px;
        }

        .suspect-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .suspect {
            background: rgba(231, 76, 60, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .suspect:hover {
            border-color: #e74c3c;
            transform: scale(1.05);
        }

        .suspect.selected {
            background: rgba(39, 174, 96, 0.3);
            border-color: #27ae60;
        }

        .solve-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .solve-btn:hover {
            background: #e67e22;
            transform: scale(1.05);
        }

        .result {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .result.correct {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
            color: #2ecc71;
        }

        .result.incorrect {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .progress-bar {
            background: rgba(52, 73, 94, 0.6);
            height: 20px;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(243, 156, 18, 0.3); }
            50% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.6); }
            100% { box-shadow: 0 0 10px rgba(243, 156, 18, 0.3); }
        }

        .mystery-container {
            animation: pulse 3s infinite;
        }
    </style>
</head>
<body>
    <div class="mystery-container">
        <div class="title">üîç Detective Mystery üïµÔ∏è</div>
        
        <div class="case-selector">
            <button class="case-btn active" onclick="selectCase(0)">The Missing Diamond</button>
            <button class="case-btn" onclick="selectCase(1)">Murder at the Manor</button>
            <button class="case-btn" onclick="selectCase(2)">The Vanishing Act</button>
        </div>

        <div id="case-content">
            <!-- Case content will be loaded here -->
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div id="game-status" style="text-align: center; margin-top: 15px; color: #3498db;">
            Click on clues to investigate! Gather evidence to solve the case.
        </div>
    </div>

    <script>
        // ZAD Configuration
        window.APP_ID = 'detective-mystery';
        
        // Authentication system
        let currentUser = null;
        
        function loadAuth() {
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                } catch (e) {
                    console.error('Failed to parse saved user');
                }
            }
        }
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TOYBOX_AUTH') {
                currentUser = event.data.user;
                updateUserStatus();
            }
        });
        
        function updateUserStatus() {
            const status = document.getElementById('game-status');
            if (currentUser) {
                status.textContent = `Playing as Detective ${currentUser.handle} - Click clues to investigate!`;
            }
        }

        // ZAD Helper Functions
        async function save(dataType, data) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        participant_id: currentUser ? currentUser.handle : 'anonymous',
                        action_type: dataType,
                        content_data: data
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('Save error:', error);
                return null;
            }
        }

        async function load(dataType) {
            try {
                const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&action_type=${dataType}`);
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }

        // Mystery Cases Data
        const cases = [
            {
                title: "The Missing Diamond",
                description: "Lady Pemberton's precious diamond has vanished from her locked safe. Three suspects were in the house that evening.",
                clues: [
                    { id: 'fingerprints', text: "Fingerprints found on the safe handle match the butler", discovered: false },
                    { id: 'alibi1', text: "The maid was seen in the kitchen at 8 PM when the theft occurred", discovered: false },
                    { id: 'motive1', text: "The gardener owes money to dangerous people", discovered: false },
                    { id: 'evidence1', text: "A small piece of fabric was caught on the safe's edge", discovered: false },
                    { id: 'witness', text: "The cook heard arguing from the study around 7:45 PM", discovered: false }
                ],
                suspects: [
                    { name: "James the Butler", description: "Has access to all rooms and keys" },
                    { name: "Mary the Maid", description: "Was cleaning upstairs that evening" },
                    { name: "Tom the Gardener", description: "Recently asked for a loan from Lady Pemberton" }
                ],
                solution: "Tom the Gardener",
                explanation: "Though the butler's fingerprints were on the safe, Tom had both motive (debt) and opportunity. The fabric matches his work clothes, and the arguing was him pleading with Lady Pemberton before resorting to theft."
            },
            {
                title: "Murder at the Manor",
                description: "Lord Blackwood has been found dead in his study. The door was locked from the inside, but something doesn't add up.",
                clues: [
                    { id: 'poison', text: "Traces of cyanide found in Lord Blackwood's brandy glass", discovered: false },
                    { id: 'window', text: "The study window was found slightly open", discovered: false },
                    { id: 'note', text: "A threatening note was discovered in the victim's desk", discovered: false },
                    { id: 'inheritance', text: "Lord Blackwood recently changed his will", discovered: false },
                    { id: 'footprints', text: "Muddy footprints lead from the garden to the window", discovered: false }
                ],
                suspects: [
                    { name: "Dr. Harrison", description: "Family physician with access to poisons" },
                    { name: "Margaret Blackwood", description: "Lord Blackwood's niece and heir" },
                    { name: "Colonel Peters", description: "Old war friend with a recent grudge" }
                ],
                solution: "Dr. Harrison",
                explanation: "The locked room was a red herring. Dr. Harrison entered through the window after poisoning the brandy during an earlier 'house call'. His medical knowledge provided both means and method."
            },
            {
                title: "The Vanishing Act",
                description: "Famous magician Viktor the Magnificent has disappeared from his locked dressing room during intermission. His assistant is frantic.",
                clues: [
                    { id: 'trapdoor', text: "A hidden trapdoor is discovered under the dressing room carpet", discovered: false },
                    { id: 'debt', text: "Viktor owed significant money to theater investors", discovered: false },
                    { id: 'costume', text: "Viktor's stage costume is missing from his wardrobe", discovered: false },
                    { id: 'ticket', text: "A train ticket to Paris found hidden in Viktor's desk", discovered: false },
                    { id: 'argument', text: "Witnesses heard Viktor arguing with someone backstage", discovered: false }
                ],
                suspects: [
                    { name: "Lily the Assistant", description: "Knew all of Viktor's secrets and tricks" },
                    { name: "Marco the Investor", description: "Threatened Viktor over unpaid debts" },
                    { name: "Viktor himself", description: "Perhaps this is his greatest disappearing act" }
                ],
                solution: "Viktor himself",
                explanation: "Viktor staged his own disappearance to escape his debts. He used the trapdoor during intermission, changed into street clothes, and escaped. The missing costume and Paris ticket confirm his elaborate vanishing act."
            }
        ];

        let currentCase = 0;
        let discoveredClues = [];
        let selectedSuspect = '';
        let solvedCases = [];

        function selectCase(caseIndex) {
            currentCase = caseIndex;
            discoveredClues = [];
            selectedSuspect = '';
            
            // Update case buttons
            document.querySelectorAll('.case-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === caseIndex);
            });
            
            loadCase();
            updateProgress();
        }

        function loadCase() {
            const case_data = cases[currentCase];
            const content = document.getElementById('case-content');
            
            content.innerHTML = `
                <div class="case-info">
                    <div class="case-title">${case_data.title}</div>
                    <div>${case_data.description}</div>
                </div>

                <div class="clues-section">
                    <div class="section-title">üîç Investigation Clues</div>
                    ${case_data.clues.map((clue, index) => `
                        <div class="clue" onclick="discoverClue(${index})" id="clue-${index}">
                            <strong>Evidence ${index + 1}:</strong> Click to investigate...
                        </div>
                    `).join('')}
                </div>

                <div class="evidence-board">
                    <div class="section-title">üìã Evidence Board</div>
                    <div id="evidence-list">
                        <em>Discovered evidence will appear here...</em>
                    </div>
                </div>

                <div class="solution-section">
                    <div class="section-title">üéØ Who is the culprit?</div>
                    <div class="suspect-grid">
                        ${case_data.suspects.map((suspect, index) => `
                            <div class="suspect" onclick="selectSuspect('${suspect.name}')" id="suspect-${index}">
                                <strong>${suspect.name}</strong><br>
                                <small>${suspect.description}</small>
                            </div>
                        `).join('')}
                    </div>
                    <center>
                        <button class="solve-btn" onclick="solveMystery()">üîç Solve the Mystery!</button>
                    </center>
                    <div id="result"></div>
                </div>
            `;
        }

        function discoverClue(clueIndex) {
            if (discoveredClues.includes(clueIndex)) return;
            
            const case_data = cases[currentCase];
            const clue = case_data.clues[clueIndex];
            
            discoveredClues.push(clueIndex);
            
            // Update clue display
            const clueElement = document.getElementById(`clue-${clueIndex}`);
            clueElement.innerHTML = `<strong>Evidence ${clueIndex + 1}:</strong> ${clue.text}`;
            clueElement.classList.add('discovered');
            
            // Add to evidence board
            updateEvidenceBoard();
            updateProgress();
            
            // Save discovery
            if (currentUser) {
                save('clue_discovery', {
                    case: currentCase,
                    clue: clueIndex,
                    timestamp: new Date().toISOString()
                });
            }
        }

        function updateEvidenceBoard() {
            const case_data = cases[currentCase];
            const evidenceList = document.getElementById('evidence-list');
            
            if (discoveredClues.length === 0) {
                evidenceList.innerHTML = '<em>Discovered evidence will appear here...</em>';
                return;
            }
            
            evidenceList.innerHTML = discoveredClues.map(index => 
                `<div class="evidence-item">${case_data.clues[index].text}</div>`
            ).join('');
        }

        function selectSuspect(suspectName) {
            selectedSuspect = suspectName;
            
            // Update suspect display
            document.querySelectorAll('.suspect').forEach(suspect => {
                suspect.classList.remove('selected');
                if (suspect.textContent.includes(suspectName)) {
                    suspect.classList.add('selected');
                }
            });
        }

        function solveMystery() {
            if (!selectedSuspect) {
                alert('Please select a suspect before solving the mystery!');
                return;
            }
            
            const case_data = cases[currentCase];
            const resultDiv = document.getElementById('result');
            const isCorrect = selectedSuspect === case_data.solution;
            
            resultDiv.className = `result ${isCorrect ? 'correct' : 'incorrect'}`;
            
            if (isCorrect) {
                resultDiv.innerHTML = `
                    <strong>üéâ CASE SOLVED! üéâ</strong><br><br>
                    Excellent detective work! You correctly identified <strong>${selectedSuspect}</strong> as the culprit.<br><br>
                    <em>Explanation:</em> ${case_data.explanation}
                `;
                
                if (!solvedCases.includes(currentCase)) {
                    solvedCases.push(currentCase);
                    
                    // Save solution
                    if (currentUser) {
                        save('case_solved', {
                            case: currentCase,
                            suspect: selectedSuspect,
                            clues_found: discoveredClues.length,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            } else {
                resultDiv.innerHTML = `
                    <strong>‚ùå Not Quite Right ‚ùå</strong><br><br>
                    <strong>${selectedSuspect}</strong> wasn't the culprit this time.<br>
                    Try examining more clues and consider all the evidence.<br><br>
                    <em>Hint:</em> Look for clues that establish both motive and opportunity.
                `;
            }
        }

        function updateProgress() {
            const totalClues = cases[currentCase].clues.length;
            const progress = (discoveredClues.length / totalClues) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            loadAuth();
            updateUserStatus();
            loadCase();
            updateProgress();
        });
    </script>
</body>
</html>