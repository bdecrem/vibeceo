<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tahoma', 'MS Sans Serif', sans-serif;
            background: #c0c0c0;
            height: 100vh;
            overflow: hidden;
        }
        
        .calculator {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
        }
        
        .calculator-toolbar {
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 2px 5px;
            display: flex;
            gap: 5px;
            align-items: center;
            font-size: 12px;
        }
        
        .calculator-content {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .display {
            background: white;
            border: 2px inset #c0c0c0;
            padding: 8px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            height: 40px;
            line-height: 24px;
            font-weight: bold;
            overflow: hidden;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            flex: 1;
        }
        
        .btn {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            font-family: 'Tahoma', sans-serif;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 35px;
        }
        
        .btn:hover {
            background: #d4d4d4;
        }
        
        .btn:active {
            border: 2px inset #c0c0c0;
        }
        
        .btn.operator {
            background: #dfdfdf;
            color: #000080;
        }
        
        .btn.equals {
            background: #0080ff;
            color: white;
        }
        
        .btn.clear {
            background: #ff8080;
            color: white;
        }
        
        .history-panel {
            background: white;
            border: 2px inset #c0c0c0;
            padding: 5px;
            height: 100px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .history-item {
            padding: 2px 0;
            border-bottom: 1px dotted #ccc;
        }
        
        .toolbar-button {
            padding: 2px 8px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            cursor: pointer;
            font-size: 11px;
        }
        
        .toolbar-button:hover {
            background: #d4d4d4;
        }
        
        .toolbar-button:active {
            border: 1px inset #c0c0c0;
        }
        
        .status-info {
            margin-left: auto;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="calculator-toolbar">
            <div class="toolbar-button" onclick="clearHistory()">Clear History</div>
            <div class="toolbar-button" onclick="saveCalculation()">Save</div>
            <div class="toolbar-button" onclick="loadHistory()">Load History</div>
            <div class="status-info">
                <span id="userInfo">Calculator</span>
            </div>
        </div>
        
        <div class="calculator-content">
            <div class="display" id="display">0</div>
            
            <div class="buttons">
                <!-- Row 1 -->
                <div class="btn clear" onclick="clearAll()">AC</div>
                <div class="btn clear" onclick="clearEntry()">CE</div>
                <div class="btn operator" onclick="inputOperator('/')">/</div>
                <div class="btn operator" onclick="inputOperator('*')">*</div>
                
                <!-- Row 2 -->
                <div class="btn" onclick="inputNumber('7')">7</div>
                <div class="btn" onclick="inputNumber('8')">8</div>
                <div class="btn" onclick="inputNumber('9')">9</div>
                <div class="btn operator" onclick="inputOperator('-')">-</div>
                
                <!-- Row 3 -->
                <div class="btn" onclick="inputNumber('4')">4</div>
                <div class="btn" onclick="inputNumber('5')">5</div>
                <div class="btn" onclick="inputNumber('6')">6</div>
                <div class="btn operator" onclick="inputOperator('+')">+</div>
                
                <!-- Row 4 -->
                <div class="btn" onclick="inputNumber('1')">1</div>
                <div class="btn" onclick="inputNumber('2')">2</div>
                <div class="btn" onclick="inputNumber('3')">3</div>
                <div class="btn equals" onclick="calculate()" style="grid-row: span 2;">=</div>
                
                <!-- Row 5 -->
                <div class="btn" onclick="inputNumber('0')" style="grid-column: span 2;">0</div>
                <div class="btn" onclick="inputDecimal()">.</div>
            </div>
            
            <div class="history-panel" id="historyPanel"></div>
        </div>
    </div>

    <script>
        // ZAD App Configuration
        window.APP_ID = 'calculator';
        let currentUser = null;
        
        // Calculator state
        let display = document.getElementById('display');
        let historyPanel = document.getElementById('historyPanel');
        let userInfo = document.getElementById('userInfo');
        
        let currentInput = '0';
        let previousInput = '';
        let operator = '';
        let waitingForNewInput = false;
        let calculationHistory = [];
        
        // ZAD Helper Functions
        async function save(dataType, data) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        action_type: dataType,
                        participant_id: currentUser ? currentUser.handle : 'guest',
                        content_data: data
                    })
                });
                
                if (!response.ok) throw new Error('Save failed');
                return await response.json();
            } catch (error) {
                console.error('Save error:', error);
                return null;
            }
        }
        
        async function load(dataType, participantId = null) {
            try {
                const response = await fetch('/api/zad/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        action_type: dataType,
                        participant_id: participantId || (currentUser ? currentUser.handle : 'guest')
                    })
                });
                
                if (!response.ok) throw new Error('Load failed');
                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }
        
        // Authentication handlers
        function updateAuthStatus() {
            if (currentUser) {
                userInfo.textContent = `Calculator - ${currentUser.handle}`;
            } else {
                userInfo.textContent = 'Calculator - Not logged in';
            }
        }
        
        // Listen for auth updates from ToyBox OS
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TOYBOX_AUTH') {
                console.log('Received auth update:', event.data.user);
                currentUser = event.data.user;
                updateAuthStatus();
                if (currentUser) {
                    loadHistory();
                }
            }
        });
        
        // Load auth from localStorage (backup method)
        function loadAuth() {
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateAuthStatus();
                    loadHistory();
                } catch (e) {
                    console.error('Failed to parse saved user');
                }
            }
        }
        
        // Calculator functions
        function updateDisplay() {
            display.textContent = currentInput;
        }
        
        function inputNumber(num) {
            if (waitingForNewInput) {
                currentInput = num;
                waitingForNewInput = false;
            } else {
                currentInput = currentInput === '0' ? num : currentInput + num;
            }
            updateDisplay();
        }
        
        function inputDecimal() {
            if (waitingForNewInput) {
                currentInput = '0.';
                waitingForNewInput = false;
            } else if (currentInput.indexOf('.') === -1) {
                currentInput += '.';
            }
            updateDisplay();
        }
        
        function inputOperator(op) {
            if (previousInput && operator && !waitingForNewInput) {
                calculate();
            }
            previousInput = currentInput;
            operator = op;
            waitingForNewInput = true;
        }
        
        function calculate() {
            if (previousInput && operator && currentInput) {
                const prev = parseFloat(previousInput);
                const curr = parseFloat(currentInput);
                let result;
                
                switch (operator) {
                    case '+':
                        result = prev + curr;
                        break;
                    case '-':
                        result = prev - curr;
                        break;
                    case '*':
                        result = prev * curr;
                        break;
                    case '/':
                        if (curr === 0) {
                            alert('Cannot divide by zero');
                            return;
                        }
                        result = prev / curr;
                        break;
                    default:
                        return;
                }
                
                // Add to history
                const calculation = {
                    expression: `${previousInput} ${operator} ${currentInput}`,
                    result: result.toString(),
                    timestamp: new Date().toLocaleString(),
                    user: currentUser ? currentUser.handle : 'guest'
                };
                
                addToHistory(calculation);
                
                currentInput = result.toString();
                previousInput = '';
                operator = '';
                waitingForNewInput = true;
                updateDisplay();
            }
        }
        
        function clearEntry() {
            currentInput = '0';
            updateDisplay();
        }
        
        function clearAll() {
            currentInput = '0';
            previousInput = '';
            operator = '';
            waitingForNewInput = false;
            updateDisplay();
        }
        
        function addToHistory(calculation) {
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            historyPanel.innerHTML = '';
            calculationHistory.forEach(calc => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${calc.expression} = ${calc.result}</strong><br>
                                <small>${calc.timestamp} (${calc.user})</small>`;
                historyPanel.appendChild(item);
            });
        }
        
        async function saveCalculation() {
            if (!currentUser) {
                alert('Please login to save calculations');
                return;
            }
            
            if (calculationHistory.length === 0) {
                alert('No calculations to save');
                return;
            }
            
            const result = await save('calculation_history', {
                history: calculationHistory,
                savedAt: new Date().toISOString(),
                user: currentUser.handle
            });
            
            if (result) {
                alert('Calculation history saved!');
            } else {
                alert('Failed to save calculation history');
            }
        }
        
        async function loadHistory() {
            if (!currentUser) return;
            
            const data = await load('calculation_history');
            if (data.length > 0) {
                const latest = data.sort((a, b) => 
                    new Date(b.content_data.savedAt) - new Date(a.content_data.savedAt)
                )[0];
                
                if (latest && latest.content_data.history) {
                    calculationHistory = latest.content_data.history;
                    updateHistoryDisplay();
                }
            }
        }
        
        function clearHistory() {
            if (confirm('Clear calculation history?')) {
                calculationHistory = [];
                updateHistoryDisplay();
            }
        }
        
        // Keyboard support
        document.addEventListener('keydown', function(e) {
            e.preventDefault();
            
            if (e.key >= '0' && e.key <= '9') {
                inputNumber(e.key);
            } else if (e.key === '.') {
                inputDecimal();
            } else if (e.key === '+') {
                inputOperator('+');
            } else if (e.key === '-') {
                inputOperator('-');
            } else if (e.key === '*') {
                inputOperator('*');
            } else if (e.key === '/') {
                inputOperator('/');
            } else if (e.key === 'Enter' || e.key === '=') {
                calculate();
            } else if (e.key === 'Escape') {
                clearAll();
            } else if (e.key === 'Backspace') {
                clearEntry();
            }
        });
        
        // Initialize
        updateDisplay();
        updateAuthStatus();
        
        // Load auth and history on startup
        window.addEventListener('DOMContentLoaded', function() {
            loadAuth();
        });
    </script>
</body>
</html>