<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacWord</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Chicago, Geneva, sans-serif;
            background: #c0c0c0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            background: linear-gradient(180deg, #fff 0%, #dfdfdf 100%);
            border-bottom: 2px solid #000;
            padding: 4px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar button {
            padding: 4px 12px;
            background: #fff;
            border: 1px solid #000;
            font-family: Chicago, Geneva, sans-serif;
            font-size: 12px;
            cursor: pointer;
        }
        
        .toolbar button:hover {
            background: #000;
            color: #fff;
        }
        
        .toolbar button:active {
            transform: translate(1px, 1px);
        }
        
        .separator {
            width: 1px;
            height: 20px;
            background: #808080;
            margin: 0 4px;
        }
        
        .document-name {
            margin-left: auto;
            margin-right: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .editor-container {
            flex: 1;
            padding: 8px;
            background: #fff;
            margin: 8px;
            border: 2px solid #000;
            overflow-y: auto;
        }
        
        #editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            font-family: Monaco, 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            background: transparent;
        }
        
        .status-bar {
            background: #dfdfdf;
            border-top: 1px solid #000;
            padding: 4px 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }
        
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-overlay.active {
            display: flex;
        }
        
        .auth-screen {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #000;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .auth-screen.active {
            display: block;
        }
        
        .auth-screen h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .auth-btn {
            background: #000;
            color: #fff;
            border: 1px solid #000;
            padding: 8px 20px;
            margin: 8px;
            cursor: pointer;
            font-family: Chicago, Geneva, sans-serif;
            font-size: 14px;
        }
        
        .auth-btn:hover {
            background: #333;
        }
        
        .auth-input {
            padding: 8px;
            margin: 8px;
            border: 2px solid #000;
            width: 200px;
            font-family: Chicago, Geneva, sans-serif;
        }
        
        .documents-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            text-align: left;
        }
        
        .document-item {
            padding: 8px;
            border: 1px solid #ccc;
            margin: 4px 0;
            cursor: pointer;
            background: #f9f9f9;
        }
        
        .document-item:hover {
            background: #e0e0e0;
        }
        
        .document-item-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .document-item-preview {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-item-date {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }
    </style>
</head>
<body class="theme-system7 windowed-app">
    <div class="toolbar">
        <button onclick="newDocument()">New</button>
        <button onclick="openDocument()">Open</button>
        <button onclick="saveDocument()">Save</button>
        <div class="separator"></div>
        <button onclick="saveAsDocument()">Save As...</button>
        <div class="separator"></div>
        <button onclick="selectAll()">Select All</button>
        <button onclick="copyText()">Copy</button>
        <button onclick="pasteText()">Paste</button>
        <div class="document-name" id="docName">Untitled</div>
        <button onclick="logout()" style="margin-left: auto; margin-right: 8px; display: none;" id="logoutBtn">Logout</button>
    </div>
    
    <div class="editor-container">
        <textarea id="editor" placeholder="Start typing your document..."></textarea>
    </div>
    
    <div class="status-bar">
        <span id="wordCount">Words: 0</span>
        <span id="charCount">Characters: 0</span>
        <span id="saveStatus">Ready</span>
        <span id="userStatus">Not logged in</span>
    </div>
    
    <!-- Auth Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <!-- Welcome Screen -->
        <div class="auth-screen active" id="welcomeScreen">
            <h2>MacWord Authentication</h2>
            <p>Please sign in to save or load documents</p>
            <button class="auth-btn" onclick="showNewUserScreen()">New User</button>
            <button class="auth-btn" onclick="showReturningScreen()">Returning User</button>
            <button class="auth-btn" onclick="cancelAuth()">Cancel</button>
        </div>
        
        <!-- New User Screen -->
        <div class="auth-screen" id="newUserScreen">
            <h2>Create Your Account</h2>
            <p>Choose a handle and PIN</p>
            <input type="text" class="auth-input" id="newHandle" placeholder="Handle (3-15 chars)" maxlength="15">
            <br>
            <input type="password" class="auth-input" id="newPin" placeholder="4-digit PIN" maxlength="4" pattern="\d{4}">
            <br>
            <button class="auth-btn" onclick="registerUser()">Create Account</button>
            <button class="auth-btn" onclick="showWelcomeScreen()">Back</button>
        </div>
        
        <!-- Returning User Screen -->
        <div class="auth-screen" id="returningScreen">
            <h2>Welcome Back</h2>
            <input type="text" class="auth-input" id="loginHandle" placeholder="Your Handle">
            <br>
            <input type="password" class="auth-input" id="loginPin" placeholder="Your 4-digit PIN" maxlength="4">
            <br>
            <button class="auth-btn" onclick="loginUser()">Sign In</button>
            <button class="auth-btn" onclick="showWelcomeScreen()">Back</button>
        </div>
        
        <!-- Documents List Screen -->
        <div class="auth-screen" id="documentsScreen">
            <h2>Your Documents</h2>
            <div class="documents-list" id="documentsList"></div>
            <button class="auth-btn" onclick="cancelAuth()">Cancel</button>
        </div>
    </div>
    
    <script>
        // App configuration
        window.APP_ID = 'macword-toybox';
        
        // State management
        let currentUser = null;
        let currentDocId = null;
        let currentDocTitle = 'Untitled';
        let isDirty = false;
        let pendingAction = null;
        
        // ZAD Helper Functions
        async function save(dataType, data) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        data_type: dataType,
                        content_data: data,
                        participant_id: currentUser ? currentUser.id : 'anonymous',
                        action_type: dataType  // IMPORTANT: action_type should match data_type for ZAD
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('Save error:', error);
                return null;
            }
        }
        
        async function load(dataType) {
            try {
                // ZAD uses GET with query parameters, not POST!
                const url = `/api/zad/load?app_id=${encodeURIComponent(window.APP_ID)}&action_type=${encodeURIComponent(dataType)}`;
                
                console.log('Loading data from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Load failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Load result:', result);
                
                // ZAD returns an array of records
                if (Array.isArray(result)) {
                    // Each record has content_data which contains the actual data
                    return result.map(record => {
                        // Return the content_data merged with metadata
                        return {
                            ...record.content_data,
                            _participant_id: record.participant_id,
                            _created_at: record.created_at
                        };
                    });
                }
                
                return [];
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }
        
        // Check for available user slots
        async function checkAvailableSlots() {
            try {
                const users = await load('user_registry');
                return {
                    totalSlots: 100,
                    usedSlots: users.length,
                    availableSlots: 100 - users.length,
                    users: users
                };
            } catch (error) {
                console.error('Error checking slots:', error);
                return { totalSlots: 100, usedSlots: 0, availableSlots: 100, users: [] };
            }
        }
        
        // Auth UI Functions
        function showAuth(action) {
            pendingAction = action;
            document.getElementById('authOverlay').classList.add('active');
            showWelcomeScreen();
        }
        
        function hideAuth() {
            document.getElementById('authOverlay').classList.remove('active');
            pendingAction = null;
        }
        
        function cancelAuth() {
            hideAuth();
        }
        
        function showWelcomeScreen() {
            document.querySelectorAll('.auth-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('welcomeScreen').classList.add('active');
        }
        
        function showNewUserScreen() {
            document.querySelectorAll('.auth-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('newUserScreen').classList.add('active');
        }
        
        function showReturningScreen() {
            document.querySelectorAll('.auth-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('returningScreen').classList.add('active');
        }
        
        function showDocumentsScreen() {
            document.querySelectorAll('.auth-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('documentsScreen').classList.add('active');
        }
        
        // User Registration
        async function registerUser() {
            const handle = document.getElementById('newHandle').value.trim();
            const pin = document.getElementById('newPin').value;
            
            if (handle.length < 3 || handle.length > 15) {
                alert('Handle must be 3-15 characters');
                return;
            }
            
            if (!/^\d{4}$/.test(pin)) {
                alert('PIN must be exactly 4 digits');
                return;
            }
            
            // Check if handle exists
            const slots = await checkAvailableSlots();
            const existingUser = slots.users.find(u => u.handle === handle);
            
            if (existingUser) {
                alert('Handle already taken. Please choose another.');
                return;
            }
            
            // Use the handle exactly as entered (it's already unique per app)
            const userData = {
                handle: handle,
                pin: pin,
                id: handle,  // ID is exactly the handle - no modifications
                created: new Date().toISOString()
            };
            
            // IMPORTANT: Set current user BEFORE saving so participant_id is correct
            currentUser = userData;
            
            // Save user to ZAD registry
            await save('user_registry', userData);
            
            // Save to localStorage
            localStorage.setItem('macword_user', JSON.stringify(userData));
            updateUserStatus();
            
            // Continue with pending action
            hideAuth();
            if (pendingAction) {
                setTimeout(() => pendingAction(), 100); // Small delay to ensure UI updates
            }
        }
        
        // User Login
        async function loginUser() {
            const handle = document.getElementById('loginHandle').value.trim();
            const pin = document.getElementById('loginPin').value;
            
            // Load all users from ZAD
            const users = await load('user_registry');
            console.log('Login attempt for:', handle, 'with PIN:', pin);
            console.log('Found users:', users);
            
            // Debug: Show what we're comparing
            users.forEach(u => {
                console.log(`Comparing: handle="${u.handle}" vs "${handle}", pin="${u.pin}" vs "${pin}"`);
            });
            
            // Find matching user (case-insensitive handle match)
            const user = users.find(u => 
                u.handle && u.handle.toLowerCase() === handle.toLowerCase() && 
                u.pin === pin
            );
            
            if (!user) {
                console.error('No match found for:', handle);
                alert('Invalid handle or PIN');
                return;
            }
            
            // Set current user
            currentUser = user;
            localStorage.setItem('macword_user', JSON.stringify(user));
            updateUserStatus();
            
            // Continue with pending action
            hideAuth();
            if (pendingAction) {
                setTimeout(() => pendingAction(), 100); // Small delay to ensure UI updates
            }
        }
        
        // Document Functions
        function newDocument() {
            if (isDirty && !confirm('Discard unsaved changes?')) {
                return;
            }
            
            document.getElementById('editor').value = '';
            currentDocId = null;
            currentDocTitle = 'Untitled';
            updateDocName();
            updateCounts();
            isDirty = false;
        }
        
        async function openDocument() {
            if (!currentUser) {
                showAuth(() => openDocument());
                return;
            }
            
            // Show loading state
            document.getElementById('authOverlay').classList.add('active');
            showDocumentsScreen();
            document.getElementById('documentsList').innerHTML = '<div style="padding: 20px; color: #666;">Loading documents...</div>';
            
            // Load documents with correct data_type
            const docs = await load('document');
            
            // MIGRATION: Also load old documents saved with action_type='save'
            // These are from before we fixed the data_type issue
            const oldDocs = await load('save');
            const oldDocuments = oldDocs.filter(d => d.title && d.content); // Only docs, not users
            
            // Combine new and old documents
            const allDocs = [...docs, ...oldDocuments];
            console.log('All docs loaded:', allDocs);
            console.log('Current user:', currentUser);
            
            // Filter for current user's documents
            const userDocs = allDocs.filter(d => {
                // Check if document belongs to current user
                // Since id === handle, we check both fields
                return d.author === currentUser.handle || 
                       d.participant_id === currentUser.id ||
                       d.userId === currentUser.id ||
                       d._participant_id === currentUser.id;  // From the metadata we added
            });
            
            console.log('User docs after filter:', userDocs);
            
            if (userDocs.length === 0) {
                document.getElementById('documentsList').innerHTML = '<div style="padding: 20px; color: #666;">No documents found. Save a document first!</div>';
                return;
            }
            
            // Sort by date, newest first
            userDocs.sort((a, b) => new Date(b.created || b.created_at).getTime() - new Date(a.created || a.created_at).getTime());
            
            // Show documents list
            const listHtml = userDocs.map(doc => `
                <div class="document-item" onclick="loadDocument('${doc.id}')">
                    <div class="document-item-title">${doc.title || 'Untitled'}</div>
                    <div class="document-item-preview">${(doc.content || '').substring(0, 100)}...</div>
                    <div class="document-item-date">${new Date(doc.created || doc.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
            
            document.getElementById('documentsList').innerHTML = listHtml;
        }
        
        async function loadDocument(docId) {
            // Load both new and old documents
            const docs = await load('document');
            const oldDocs = await load('save');
            const oldDocuments = oldDocs.filter(d => d.title && d.content);
            const allDocs = [...docs, ...oldDocuments];
            
            const doc = allDocs.find(d => d.id === docId);
            
            if (doc) {
                document.getElementById('editor').value = doc.content || '';
                currentDocId = doc.id;
                currentDocTitle = doc.title || 'Untitled';
                updateDocName();
                updateCounts();
                isDirty = false;
            }
            
            hideAuth();
        }
        
        async function saveDocument() {
            if (!currentUser) {
                showAuth(() => saveDocument());
                return;
            }
            
            const content = document.getElementById('editor').value;
            
            if (!currentDocId) {
                // New document - ask for title
                const title = prompt('Document title:', currentDocTitle);
                if (title === null) return;
                
                currentDocTitle = title || 'Untitled';
                currentDocId = 'doc_' + Date.now();
            }
            
            const docData = {
                id: currentDocId,
                title: currentDocTitle,
                content: content,
                author: currentUser.handle,
                participant_id: currentUser.id, // Important: include participant_id
                userId: currentUser.id, // Also include as userId for compatibility
                created: new Date().toISOString(),
                wordCount: content.split(/\s+/).filter(w => w.length > 0).length,
                charCount: content.length
            };
            
            await save('document', docData);
            
            updateDocName();
            updateSaveStatus('Saved');
            isDirty = false;
            
            setTimeout(() => updateSaveStatus('Ready'), 2000);
        }
        
        async function saveAsDocument() {
            if (!currentUser) {
                showAuth(() => saveAsDocument());
                return;
            }
            
            const title = prompt('Document title:', currentDocTitle);
            if (title === null) return;
            
            currentDocTitle = title || 'Untitled';
            currentDocId = 'doc_' + Date.now();
            
            await saveDocument();
        }
        
        // Editor Functions
        function selectAll() {
            document.getElementById('editor').select();
        }
        
        function copyText() {
            const editor = document.getElementById('editor');
            if (editor.selectionStart !== editor.selectionEnd) {
                navigator.clipboard.writeText(editor.value.substring(editor.selectionStart, editor.selectionEnd));
            }
        }
        
        async function pasteText() {
            try {
                const text = await navigator.clipboard.readText();
                const editor = document.getElementById('editor');
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const newValue = editor.value.substring(0, start) + text + editor.value.substring(end);
                editor.value = newValue;
                editor.selectionStart = editor.selectionEnd = start + text.length;
                updateCounts();
                isDirty = true;
            } catch (err) {
                console.error('Failed to paste:', err);
            }
        }
        
        // UI Updates
        function updateCounts() {
            const text = document.getElementById('editor').value;
            const words = text.split(/\s+/).filter(w => w.length > 0).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = `Words: ${words}`;
            document.getElementById('charCount').textContent = `Characters: ${chars}`;
        }
        
        function updateDocName() {
            document.getElementById('docName').textContent = currentDocTitle;
        }
        
        function updateSaveStatus(status) {
            document.getElementById('saveStatus').textContent = status;
        }
        
        function updateUserStatus() {
            const status = currentUser ? `User: ${currentUser.handle}` : 'Not logged in';
            document.getElementById('userStatus').textContent = status;
            
            // Show/hide logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = currentUser ? 'inline-block' : 'none';
            }
        }
        
        function logout() {
            if (isDirty && !confirm('You have unsaved changes. Logout anyway?')) {
                return;
            }
            
            currentUser = null;
            localStorage.removeItem('macword_user');
            currentDocId = null;
            currentDocTitle = 'Untitled';
            document.getElementById('editor').value = '';
            isDirty = false;
            
            updateUserStatus();
            updateDocName();
            updateCounts();
            updateSaveStatus('Ready');
        }
        
        // Auto-save
        setInterval(() => {
            if (isDirty && currentUser && currentDocId) {
                saveDocument();
            }
        }, 30000); // Auto-save every 30 seconds
        
        // Event Listeners
        document.getElementById('editor').addEventListener('input', () => {
            updateCounts();
            isDirty = true;
            updateSaveStatus('Modified');
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.metaKey || e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveDocument();
                        break;
                    case 'o':
                        e.preventDefault();
                        openDocument();
                        break;
                    case 'n':
                        e.preventDefault();
                        newDocument();
                        break;
                    case 'a':
                        e.preventDefault();
                        selectAll();
                        break;
                }
            }
        });
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Check for saved user
            const savedUser = localStorage.getItem('macword_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('Restored user:', currentUser);
                    updateUserStatus();
                } catch (e) {
                    console.error('Failed to parse saved user:', e);
                    localStorage.removeItem('macword_user');
                }
            }
            
            updateCounts();
            updateDocName();
        });
    </script>
</body>
</html>