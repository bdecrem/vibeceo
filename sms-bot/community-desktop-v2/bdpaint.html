<!DOCTYPE html>
<html>
<head>
    <title>BDpaint</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #c0c0c0;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }
        
        .toolbar {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            padding: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tool-button {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .tool-button:hover {
            background: #d4d0c8;
        }
        
        .tool-button.active {
            border: 1px inset #c0c0c0;
            background: #a0a0a0;
        }
        
        .color-picker {
            display: flex;
            gap: 2px;
        }
        
        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #000;
            cursor: pointer;
        }
        
        .color-swatch.active {
            border: 2px solid #fff;
            outline: 1px solid #000;
        }
        
        #canvas-container {
            border: 1px inset #c0c0c0;
            background: white;
            display: inline-block;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
        
        .size-slider {
            margin-left: 10px;
        }
        
        #status {
            margin-top: 5px;
            padding: 2px 5px;
            background: #c0c0c0;
            border: 1px inset #c0c0c0;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="tool-button active" id="brush-tool" onclick="setTool('brush')">Brush</div>
        <div class="tool-button" id="eraser-tool" onclick="setTool('eraser')">Eraser</div>
        <div class="tool-button" onclick="clearCanvas()">Clear</div>
        <div class="tool-button" onclick="savePainting()">Save</div>
        <div class="tool-button" onclick="loadPainting()">Load</div>
        
        <div class="color-picker">
            <div class="color-swatch active" style="background: #000" onclick="setColor('#000')" data-color="#000"></div>
            <div class="color-swatch" style="background: #f00" onclick="setColor('#f00')" data-color="#f00"></div>
            <div class="color-swatch" style="background: #0f0" onclick="setColor('#0f0')" data-color="#0f0"></div>
            <div class="color-swatch" style="background: #00f" onclick="setColor('#00f')" data-color="#00f"></div>
            <div class="color-swatch" style="background: #ff0" onclick="setColor('#ff0')" data-color="#ff0"></div>
            <div class="color-swatch" style="background: #f0f" onclick="setColor('#f0f')" data-color="#f0f"></div>
            <div class="color-swatch" style="background: #0ff" onclick="setColor('#0ff')" data-color="#0ff"></div>
            <div class="color-swatch" style="background: #fff" onclick="setColor('#fff')" data-color="#fff"></div>
        </div>
        
        <div class="size-slider">
            Size: <input type="range" id="brush-size" min="1" max="20" value="3" onchange="setBrushSize(this.value)">
            <span id="size-display">3</span>px
        </div>
    </div>
    
    <div id="canvas-container">
        <canvas id="paint-canvas" width="600" height="400"></canvas>
    </div>
    
    <div id="status">Ready - Click and drag to paint</div>

    <script>
        // ZAD Configuration
        window.APP_ID = 'bdpaint';
        
        // ZAD Helper Functions
        async function save(dataType, data) {
            try {
                const response = await fetch('/api/zad/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        app_id: window.APP_ID,
                        data_type: dataType,
                        content_data: data,
                        participant_id: getCurrentUserId(),
                        action_type: dataType
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Save error:', error);
                throw error;
            }
        }

        async function load(dataType) {
            try {
                const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&action_type=${dataType}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data || [];
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }
        
        function getCurrentUserId() {
            // Try to get from ToyBox OS auth system
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    return user.handle || 'anonymous';
                } catch (e) {
                    return 'anonymous';
                }
            }
            return 'anonymous';
        }

        // Paint App Logic
        const canvas = document.getElementById('paint-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#000';
        let currentSize = 3;
        let currentUser = null;

        // Initialize canvas
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Authentication handling
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TOYBOX_AUTH') {
                currentUser = event.data.user;
                updateStatus();
            }
        });

        function updateStatus(message = null) {
            const status = document.getElementById('status');
            if (message) {
                status.textContent = message;
            } else if (currentUser) {
                status.textContent = `Ready - Logged in as ${currentUser.handle}`;
            } else {
                status.textContent = 'Ready - Click and drag to paint';
            }
        }

        // Load auth from localStorage as fallback
        window.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('toybox_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateStatus();
                } catch (e) {
                    console.error('Failed to parse saved user');
                }
            }
        });

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }

        // Event listeners
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Tool functions
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + '-tool').classList.add('active');
            
            canvas.style.cursor = tool === 'eraser' ? 'crosshair' : 'crosshair';
        }

        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setBrushSize(size) {
            currentSize = parseInt(size);
            document.getElementById('size-display').textContent = size;
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            updateStatus('Canvas cleared');
        }

        async function savePainting() {
            try {
                const imageData = canvas.toDataURL();
                const paintingData = {
                    image: imageData,
                    timestamp: new Date().toISOString(),
                    author: getCurrentUserId()
                };
                
                await save('painting', paintingData);
                updateStatus('Painting saved successfully!');
            } catch (error) {
                updateStatus('Error saving painting');
                console.error('Save error:', error);
            }
        }

        async function loadPainting() {
            try {
                const paintings = await load('painting');
                if (paintings.length === 0) {
                    updateStatus('No saved paintings found');
                    return;
                }

                // Load the most recent painting
                const latestPainting = paintings[paintings.length - 1];
                if (latestPainting.content_data && latestPainting.content_data.image) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        updateStatus('Painting loaded successfully!');
                    };
                    img.src = latestPainting.content_data.image;
                } else {
                    updateStatus('Error loading painting data');
                }
            } catch (error) {
                updateStatus('Error loading painting');
                console.error('Load error:', error);
            }
        }

        // Initialize
        updateStatus();
    </script>
</body>
</html>