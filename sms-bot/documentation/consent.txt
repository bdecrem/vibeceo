
  üîç DEEP ANALYSIS: consent_given Logic & Twilio TOS Compliance

  Current Implementation - Where consent_given=TRUE is set:

  1. Explicit START Command (handlers.ts:1784-1798)
  if (messageUpper === "START" || messageUpper === "UNSTOP") {
      await createNewSubscriber(normalizedPhoneNumber);
      // Sets consent_given: true, confirmed: false

      // Response includes:
      "Reply YES if you want our daily creative chaos delivered via SMS.
       Standard rates apply. Text STOP anytime to unsubscribe."
  }

  2. üö® AUTO-CREATION for ANY MESSAGE (handlers.ts:1911-1933)
  // If message is NOT "START", "UNSTOP", "STOP", "YES"
  if (!currentSubscriber) {
      console.log("New user - auto-creating subscriber record");
      await createNewSubscriber(normalizedPhoneNumber);
      // ‚ö†Ô∏è Sets consent_given: true WITHOUT explicit opt-in
      // Then processes their original message normally
  }

  Example: If someone texts "hello" ‚Üí Auto-created with consent_given: true

  3. Account Merging (controller.ts:3227)
  - When merging phone/email accounts during verification
  - Sets consent_given: true as part of merge

  4. Announcements Subscription (subscribers.ts:352-354)
  - Our new code: When subscribing to announcements
  - Sets consent_given: true (for Twilio TOS compliance)

  ---
  üìã Twilio TOS Requirements (TCPA/A2P 10DLC)

  Required for Compliance:
  1. Prior Express Written Consent before sending promotional messages
  2. Clear Opt-In Language: "I agree to receive SMS messages from [Brand]"
  3. Cannot Be Implied: Just texting your number ‚â† consent
  4. Must Disclose:
    - Message frequency
    - That message & data rates may apply
    - How to opt-out (STOP)
    - Help keyword (HELP)

  ---
  ‚ö†Ô∏è COMPLIANCE ANALYSIS

  ‚úÖ COMPLIANT:

  - START command: User explicitly texts START ‚Üí Receives opt-in language ‚Üí
  Can confirm with YES
  - Announcements subscription: User explicitly texts ANNOUNCEMENTS ‚Üí Gets
  confirmation
  - STOP handling: Proper unsubscribe mechanism

  üö® POTENTIALLY NON-COMPLIANT:

  MAJOR ISSUE: Auto-Creation Logic (Line 1911)

  // User texts: "hello" or "what's up" or "create app"
  // System: Auto-creates subscriber with consent_given=true
  // ‚ùå This is IMPLIED consent, not EXPRESS consent
  // ‚ùå Violates TCPA requirements

  Why this is problematic:
  1. No explicit opt-in requested - User didn't text START or SUBSCRIBE
  2. No consent language shown - They just get their message processed
  3. Implied vs Express - TCPA requires EXPRESS written consent
  4. A2P 10DLC enforcement - Carriers can block/filter non-compliant
  messages

  Example flow that breaks compliance:
  User: "hello"
  System: *Auto-creates subscriber with consent_given=true*
  System: *Responds to "hello"*
  User: Never explicitly opted in, but now marked as consented

  ---
  üéØ COMPLIANCE RECOMMENDATIONS

  Option 1: Strict Compliance (Recommended)
  // When non-subscriber texts anything:
  if (!currentSubscriber && !["START", "UNSTOP"].includes(messageUpper)) {
      await sendSmsResponse(
          from,
          "Welcome to Kochi! Text START to join and begin using our 
  features.",
          twilioClient
      );
      return; // Don't process message or auto-create subscriber
  }

  Option 2: Soft Gate (Friendlier)
  // Create subscriber but set consent_given=false
  // Ask them to confirm
  if (!currentSubscriber) {
      await createNewSubscriber(normalizedPhoneNumber, { consent_given:
  false });
      await sendSmsResponse(
          from,
          "Thanks for reaching out! To continue, reply START to opt in to 
  Kochi updates. Standard rates apply.",
          twilioClient
      );
      return;
  }

  Option 3: Transactional Only
  // Keep auto-creation BUT document that initial use is "transactional" not
   "promotional"
  // Only set consent_given=true for actual subscriptions (AI DAILY, 
  ANNOUNCEMENTS, etc.)
  // Process one-off commands without requiring START

  ---
  üìä CURRENT STATE SUMMARY:

  | Scenario                 | consent_given | Compliant? | Notes
               |
  |--------------------------|---------------|------------|-----------------
  -------------|
  | User texts START         | ‚úÖ TRUE        | ‚úÖ YES      | Explicit
  opt-in              |
  | User texts ANNOUNCEMENTS | ‚úÖ TRUE        | ‚úÖ YES      | Explicit
  subscription        |
  | User texts "hello"       | ‚úÖ TRUE        | ‚ùå NO       | Auto-created
  without consent |
  | User texts "create game" | ‚úÖ TRUE        | ‚ùå NO       | Auto-created
  without consent |
  | Agent subscriptions      | ‚úÖ TRUE        | ‚úÖ YES      | Explicit
  SUBSCRIBE command   |

  ---
  üí° KEY INSIGHT:

  The auto-creation logic (introduced for user convenience) bypasses proper 
  consent flow. While this makes onboarding smoother, it creates legal risk
  under TCPA and technical risk with carrier filtering (Verizon, AT&T
  increasingly block non-compliant A2P messages).

  Most conservative approach: Require START before processing ANY commands.