# WEBTOYS-OS (ToyBox OS) Documentation

## Overview

**WEBTOYS-OS** (also known as **ToyBox OS**) is a browser-based windowed operating system that serves as the collaborative desktop environment for the WEBTOYS platform. It provides a Windows 95-style interface where users can run apps, collaborate on projects, and contribute to a community-built desktop experience.

## üéØ CRITICAL DISTINCTION: ToyBox OS vs WEBTOYS SMS System

### ToyBox OS / WEBTOYS-OS Apps (Local Development)
- **Built LOCALLY** by Claude CLI agents on the development machine
- **Developed in** `/sms-bot/community-desktop-v2/` directory
- **Version controlled** in git with full development workflow
- **Deployed to** Supabase `wtaf_content` table after local development
- **Created by** AI agents using development tools (NOT via SMS)
- **Examples**: ToyBox OS desktop, Community Notepad, Issue Tracker, windowed apps

### WEBTOYS SMS Apps (Remote Generation)
- **Built REMOTELY** via SMS text messages from users
- **Generated by** the SMS bot in `/sms-bot/` when users text requests
- **No local files** - HTML generated and stored directly in Supabase
- **Created by** users texting commands to the WEBTOYS phone number
- **Examples**: User-created pages, games, memes via SMS

### Shared Infrastructure
```
ToyBox OS (Local Development)          WEBTOYS (SMS System)
‚îú‚îÄ‚îÄ Built on THIS machine               ‚îú‚îÄ‚îÄ Built via SMS
‚îú‚îÄ‚îÄ By Claude CLI agents                ‚îú‚îÄ‚îÄ By SMS bot
‚îú‚îÄ‚îÄ Full dev workflow                   ‚îú‚îÄ‚îÄ Direct to database
‚îî‚îÄ‚îÄ Deploys to ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ Uses same backend
                         ‚Üì
                  Shared Infrastructure
                  ‚îú‚îÄ‚îÄ Supabase tables (wtaf_content, wtaf_zero_admin_collaborative)
                  ‚îú‚îÄ‚îÄ ZAD API system (/api/zad/save, /api/zad/load)
                  ‚îú‚îÄ‚îÄ Public URLs (webtoys.ai/public/[app-name])
                  ‚îî‚îÄ‚îÄ Authentication & data systems
```

## Project Location & Structure

### Primary Development Directory
```
/sms-bot/community-desktop-v2/       # ACTIVE directory (use this!)
‚îú‚îÄ‚îÄ scripts/                         # Update and utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ safe-update-wrapper.js      # CRITICAL: Always use for HTML updates
‚îÇ   ‚îú‚îÄ‚îÄ safe-css-wrapper.js         # CSS backup functionality
‚îÇ   ‚îú‚îÄ‚îÄ update-toybox.js            # Primary update script
‚îÇ   ‚îî‚îÄ‚îÄ [various fix scripts]       # Individual fixes and features
‚îú‚îÄ‚îÄ backups/                         # Automatic backups (git-ignored)
‚îÇ   ‚îú‚îÄ‚îÄ toybox-os_*.html           # HTML backups with timestamps
‚îÇ   ‚îî‚îÄ‚îÄ css/                       # Theme CSS backups
‚îú‚îÄ‚îÄ themes/                         # Theme files
‚îú‚îÄ‚îÄ prompts/                        # Templates for new apps
‚îî‚îÄ‚îÄ CLAUDE.md                       # Local documentation
```

**‚ö†Ô∏è DEPRECATED**: `/sms-bot/community-desktop/` - DO NOT USE

### Live URLs
- **Production Desktop**: https://webtoys.ai/public/toybox-os
- **Local Testing**: http://localhost:3000/public/toybox-os

## üî¥ CRITICAL: Safe Update System

### NEVER directly edit HTML in Supabase without using safe wrappers!

#### Primary Update Methods

1. **Using the organized update system** (RECOMMENDED):
```bash
cd /Users/bartdecrem/Documents/code/vibeceo8/sms-bot/community-desktop-v2

# For HTML changes (content, menus, icons)
node scripts/update-toybox.js html "description" --change="type"

# For CSS changes (styling, themes, layout)  
node scripts/update-toybox.js css "description" --change="type"
```

2. **Using safe-update-wrapper.js directly**:
```javascript
import { fetchCurrentToyBoxOS, safeUpdateToyBoxOS } from './scripts/safe-update-wrapper.js';

// Get current HTML
const current = await fetchCurrentToyBoxOS();
let html = current.html_content;

// Make your changes
html = html.replace('old content', 'new content');

// Safe update with automatic backup
await safeUpdateToyBoxOS(html, 'Description of changes');
```

3. **Restoring from backup**:
```bash
# Restore HTML
node scripts/update-toybox-os.js backups/toybox-os_latest-backup.html

# Restore CSS theme
node scripts/css-backup-manager.js restore system7-theme_latest-backup.css
```

### Backup System
- **Automatic backups** created before every update
- **Location**: `backups/` folder (git-ignored)
- **Naming**: `toybox-os_YYYY-MM-DD_HH-MM-SS.html`
- **Latest backup**: Always available as `toybox-os_latest-backup.html`

## Database Architecture

### Primary Tables

#### wtaf_content
Stores all HTML pages including ToyBox OS and its apps:
- `user_slug`: 'public' for ToyBox OS apps
- `app_slug`: 'toybox-os', 'community-notepad', etc.
- `html_content`: Complete HTML including embedded JavaScript
- `theme_id`: Links to theme CSS

#### wtaf_zero_admin_collaborative (ZAD)
Stores all app data and user information:
- `app_id`: UUID or app identifier
- `action_type`: Data category (e.g., 'user_registry', 'update_request')
- `participant_id`: User identifier
- `content_data`: JSONB with actual data

#### wtaf_themes
Stores theme CSS:
- `id`: Theme UUID
- `css_content`: Complete CSS for theme
- `name`: Theme name (e.g., 'System 7')

## User Authentication System

### Overview
ToyBox OS provides user authentication that persists across sessions and is shared with all windowed apps.

### Database Details
- **Table**: `wtaf_zero_admin_collaborative`
- **App ID**: `toybox-os-users`
- **Action Type**: `user_registry`

### User Data Structure
```json
{
    "handle": "bart",           // Username (3-15 chars) - THIS IS THE KEY FIELD!
    "pin": "1234",             // 4-digit PIN
    "id": "bart",              // Same as handle
    "created": "2025-01-21T..." // ISO timestamp
}
```

### Critical Authentication Notes
- **Use `.handle` NOT `.username`** - This is the most common error!
- User object stored in `currentUser` or `window.toyboxUser`
- Always check for null before accessing properties
- Authentication broadcasts via postMessage to all iframes

### Correct Authentication Pattern for Apps
```javascript
// Global user variable
let currentUser = null;

// Listen for auth from ToyBox OS
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'TOYBOX_AUTH') {
        currentUser = event.data.user;
        updateUI();
    }
});

// Access username correctly
const username = currentUser?.handle || 'anonymous';  // NOT .username!
```

## ZAD API System

All ToyBox OS apps use the Zero Admin Data (ZAD) system for data persistence.

### Endpoints
- **Save**: `/api/zad/save`
- **Load**: `/api/zad/load`

### NEVER use direct Supabase access in apps!

### Required Helper Functions
Every windowed app MUST include these ZAD helpers:

```javascript
window.APP_ID = 'unique-app-id';  // Required!

async function save(dataType, data) {
    const response = await fetch('/api/zad/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            app_id: window.APP_ID,
            participant_id: currentUser?.handle || 'anonymous',
            action_type: dataType,
            content_data: data
        })
    });
    return response.ok;
}

async function load(dataType) {
    const response = await fetch(`/api/zad/load?app_id=${window.APP_ID}&action_type=${dataType}`);
    const data = await response.json();
    return data || [];
}
```

## Creating New Windowed Apps

### Template Structure
```html
<!DOCTYPE html>
<html>
<head>
    <title>App Name</title>
    <style>
        /* Windows 95 aesthetic */
        body { 
            background: #c0c0c0;
            font-family: 'MS Sans Serif', Tahoma, sans-serif;
            margin: 0;
            padding: 8px;
        }
    </style>
</head>
<body>
    <!-- App UI here -->
    
    <script>
        // REQUIRED: App ID
        window.APP_ID = 'unique-app-id';
        
        // REQUIRED: User variable
        let currentUser = null;
        
        // REQUIRED: ZAD helper functions
        async function save(dataType, data) { /* ... */ }
        async function load(dataType) { /* ... */ }
        
        // REQUIRED: Auth listener
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TOYBOX_AUTH') {
                currentUser = event.data.user;
                // Update UI based on login state
            }
        });
        
        // Your app logic here
    </script>
</body>
</html>
```

### Deployment Process

1. **Create the app HTML** following the template
2. **Deploy to Supabase**:
```javascript
const { error } = await supabase
    .from('wtaf_content')
    .insert({
        user_slug: 'public',
        app_slug: 'your-app-name',
        html_content: yourHTML,
        original_prompt: 'App description'
    });
```

3. **Register in ToyBox OS**:
```javascript
// Add to window.windowedApps registry in toybox-os.html
window.windowedApps['your-app'] = {
    name: 'Your App',
    url: '/public/your-app-name',
    icon: 'üéØ',
    width: 800,
    height: 600
};
```

4. **Add desktop icon**:
```html
<div class="desktop-icon" onclick="openWindowedApp('your-app')">
    <div class="icon">üéØ</div>
    <div class="label">Your App</div>
</div>
```

## Common APIs and Patterns

### Window Manager API
```javascript
// Open a windowed app
openWindowedApp('app-id');

// Close current window (from inside app)
window.parent.postMessage({ type: 'CLOSE_WINDOW' }, '*');
```

### Authentication Check Pattern
```javascript
if (!currentUser) {
    alert('Please log in to use this feature');
    return;
}
// Proceed with authenticated action
```

### Data Persistence Pattern
```javascript
// Save user-specific data
async function saveUserData(data) {
    return await save('user_data', {
        ...data,
        userId: currentUser?.handle || 'anonymous',
        timestamp: new Date().toISOString()
    });
}

// Load and filter user data
async function loadUserData() {
    const allData = await load('user_data');
    return allData.filter(item => 
        item.content_data.userId === (currentUser?.handle || 'anonymous')
    );
}
```

## Theme System

### Current Theme
- **Name**: System 7
- **ID**: `2ec89c02-d424-4cf6-81f1-371ca6b9afcf`
- **Storage**: `wtaf_themes` table

### Updating Themes
```javascript
// Update theme CSS in database
const { error } = await supabase
    .from('wtaf_themes')
    .update({ css_content: newCSS })
    .eq('id', themeId);
```

### Theme Application
ToyBox OS dynamically loads theme CSS on startup:
```javascript
const theme = await loadTheme(themeId);
const styleElement = document.createElement('style');
styleElement.textContent = theme.css_content;
document.head.appendChild(styleElement);
```

## Testing & Development

### Local Development Setup
```bash
# Navigate to web directory
cd /Users/bartdecrem/Documents/code/vibeceo8/web

# Start development server
npm run dev

# Access ToyBox OS locally
# http://localhost:3000/public/toybox-os
```

### Testing Checklist
- [ ] Test app in windowed mode
- [ ] Verify authentication integration
- [ ] Check data persistence with ZAD
- [ ] Test with logged in and anonymous users
- [„Å™„Åå„Çâ Verify responsive behavior in different window sizes
- [ ] Check for console errors
- [ ] Test app reopening/state restoration

## Security & Best Practices

### Security Rules
1. **NEVER hardcode secrets** - Use environment variables
2. **NEVER expose Supabase keys** in client code
3. **Always validate user input** before saving
4. **Use participant_id** for data isolation
5. **Check authentication** before sensitive operations

### Development Best Practices
1. **ALWAYS use safe-update-wrapper.js** for updates
2. **ALWAYS backup before major changes**
3. **ALWAYS test locally first**
4. **ALWAYS use `.handle` not `.username`** for user field
5. **ALWAYS include ZAD helpers** in windowed apps
6. **ALWAYS listen for auth updates** via postMessage
7. **NEVER edit directly in Supabase** without backups

## Common Issues & Solutions

### Issue: Username shows as "anonymous" when logged in
**Solution**: Use `currentUser.handle` not `currentUser.username`

### Issue: App doesn't receive authentication
**Solution**: Add message event listener for TOYBOX_AUTH

### Issue: Data not persisting
**Solution**: Ensure APP_ID is set and ZAD helpers are included

### Issue: Changes lost after update
**Solution**: Always use safe-update-wrapper.js with backups

### Issue: App not opening in window
**Solution**: Register in windowedApps and add desktop icon

## Quick Command Reference

```bash
# Update ToyBox OS HTML
cd /Users/bartdecrem/Documents/code/vibeceo8/sms-bot/community-desktop-v2
node scripts/update-toybox.js html "Added new feature"

# Update theme CSS
node scripts/update-toybox.js css "Updated colors"

# Restore from backup
node scripts/update-toybox-os.js backups/toybox-os_latest-backup.html

# Create test issue (Issue Tracker)
node scripts/create-test-issue.js

# Fix specific issue
node scripts/fix-[issue-name].js
```

## Important Files Reference

- **Main Desktop**: `toybox-os.html` (in Supabase)
- **Safe Update**: `scripts/safe-update-wrapper.js`
- **Local Docs**: `community-desktop-v2/CLAUDE.md`
- **This File**: `sms-bot/documentation/webtoys-os.md`
- **ZAD Docs**: `sms-bot/documentation/ZAD-API-REFERENCE.md`

## Support & Troubleshooting

For issues or questions about WEBTOYS-OS development:
1. Check this documentation first
2. Review existing scripts in `scripts/` folder
3. Look at working examples (Chat, Notepad, Issue Tracker)
4. Check backups folder for previous versions
5. Use debug scripts to investigate issues

Remember: **The user authentication field is `.handle` NOT `.username`!**

---

*Last Updated: January 2025*
*Version: 2.0 (Community Desktop V2)*